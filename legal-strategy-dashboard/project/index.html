<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executive Defence Strategy | Police v Deshpande</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc2NCcgaGVpZ2h0PSc2NCcgdmlld0JveD0nMCAwIDY0IDY0Jz48cmVjdCB3aWR0aD0nNjQnIGhlaWdodD0nNjQnIHJ4PScxMicgZmlsbD0nIzAyMDYxNycvPjxwYXRoIGQ9J00xNiAxMmgzMnY0MEgxNnonIHN0cm9rZT0nI0Q0QUYzNycgc3Ryb2tlLXdpZHRoPSc0JyBmaWxsPSdub25lJy8+PHBhdGggZD0nTTI0IDI0aDE2bS0xNiAxMGgxNm0tMTYgMTBoMTYnIHN0cm9rZT0nI0Q0QUYzNycgc3Ryb2tlLXdpZHRoPSczJy8+PC9zdmc+">
    <link rel="shortcut icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc2NCcgaGVpZ2h0PSc2NCcgdmlld0JveD0nMCAwIDY0IDY0Jz48cmVjdCB3aWR0aD0nNjQnIGhlaWdodD0nNjQnIHJ4PScxMicgZmlsbD0nIzAyMDYxNycvPjxwYXRoIGQ9J00xNiAxMmgzMnY0MEgxNnonIHN0cm9rZT0nI0Q0QUYzNycgc3Ryb2tlLXdpZHRoPSc0JyBmaWxsPSdub25lJy8+PHBhdGggZD0nTTI0IDI0aDE2bS0xNiAxMGgxNm0tMTYgMTBoMTYnIHN0cm9rZT0nI0Q0QUYzNycgc3Ryb2tlLXdpZHRoPSczJy8+PC9zdmc+">
    <meta name="theme-color" content="#c5a059">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LegalDash">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">

    <!-- External Resources -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Google Identity & API Setup -->
    <script src="https://apis.google.com/js/api.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Custom Config -->
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        executive: {
                            navy: '#0f172a',
                            gold: '#d4af37',
                            goldDark: '#b8860b',
                            crimson: '#7F1D1D',
                            slate: '#1e293b',
                            silver: '#E2E8F0'
                        },
                        legal: {
                            navy: '#0f172a',
                            slate: '#334155',
                            gold: '#d4af37',
                            paper: '#f8fafc',
                            alert: '#ef4444'
                        }
                    },
                    boxShadow: {
                        'executive': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'card': '0 0 0 1px rgba(255,255,255,0.05), 0 4px 6px -1px rgba(0,0,0,0.1)',
                        'glass': 'inset 0 0 0 1px rgba(255,255,255,0.1)'
                    },
                    backgroundImage: {
                        'executive-gradient': 'linear-gradient(145deg, #0f172a 0%, #111f38 60%, #0b1426 100%)',
                        'gold-gradient': 'linear-gradient(135deg, #d4af37 0%, #b8860b 100%)'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --nav-width: 280px;
            --primary-gold: #d4af37;
            --executive-gold: #d4af37;
            --executive-navy: #0f172a;
            --legal-navy: #0f172a;
            --panel-surface: rgba(15, 23, 42, 0.68);
            --panel-surface-hover: rgba(30, 41, 59, 0.74);
        }

        html,
        body {
            max-width: 100%;
            overflow-x: hidden;
        }

        body {
            background-color: var(--legal-navy);
            color: #E2E8F0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
            letter-spacing: -0.011em;
            background-image:
                radial-gradient(circle at 12% 12%, rgba(212, 175, 55, 0.08), transparent 34%),
                radial-gradient(circle at 84% 20%, rgba(56, 189, 248, 0.06), transparent 36%),
                linear-gradient(160deg, #0f172a 0%, #111b30 58%, #0b1222 100%);
        }

        h1,
        h2,
        h3 {
            font-family: 'Playfair Display', serif;
            letter-spacing: -0.018em;
        }

        h4,
        h5,
        h6,
        p,
        li,
        span,
        td,
        th,
        input,
        select,
        textarea,
        button {
            letter-spacing: -0.01em;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation & UI */
        .nav-item {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
            opacity: 0.6;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.08);
            opacity: 1;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
            border-left-color: var(--primary-gold);
            color: #fff;
            opacity: 1;
        }

        .glass-panel {
            background: var(--panel-surface);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow:
                inset 0 0 0 1px rgba(255, 255, 255, 0.06),
                0 24px 55px -26px rgba(2, 6, 23, 0.95);
            transition: all 0.3s ease;
        }

        .glass-panel:hover {
            background: var(--panel-surface-hover);
        }

        .executive-border {
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .timeline-connector {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 18px;
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        @media (min-width: 768px) {
            .timeline-connector {
                left: 24px;
            }
        }

        /* Perspective Cards */
        .perspective-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backface-visibility: hidden;
        }

        .perspective-active {
            transform: rotateY(0deg);
            opacity: 1;
            pointer-events: auto;
        }

        .perspective-hidden {
            transform: rotateY(180deg);
            opacity: 0;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* AI Thinking Animation */
        .thinking-dots div {
            animation-duration: 1.2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
        }

        .thinking-dots div:nth-child(1) {
            animation-name: bounce;
        }

        .thinking-dots div:nth-child(2) {
            animation-name: bounce;
            animation-delay: 0.1s;
        }

        .thinking-dots div:nth-child(3) {
            animation-name: bounce;
            animation-delay: 0.2s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* Intervention Mode */
        .intervention-alert {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Drag and Drop Zone */
        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: var(--primary-gold);
            background-color: rgba(212, 175, 55, 0.05);
        }

        button,
        input,
        select,
        textarea,
        .nav-item,
        .doc-btn {
            transition: all 0.3s ease !important;
        }

        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible {
            outline: none;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.28);
            border-color: rgba(212, 175, 55, 0.55) !important;
        }

        .timeline-item {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 1.85rem;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: 0.95rem;
            top: 0.25rem;
            width: 0.8rem;
            height: 0.8rem;
            border-radius: 9999px;
            border: 2px solid rgba(255, 255, 255, 0.18);
            background: rgba(212, 175, 55, 0.7);
            z-index: 2;
            box-shadow: 0 0 0 5px rgba(212, 175, 55, 0.08);
        }

        .timeline-item.is-critical .timeline-dot {
            background: rgba(239, 68, 68, 0.84);
            box-shadow: 0 0 0 5px rgba(239, 68, 68, 0.1);
        }

        .timeline-item.is-hearing .timeline-dot {
            background: rgba(16, 185, 129, 0.92);
            box-shadow: 0 0 0 5px rgba(16, 185, 129, 0.12);
        }

        .timeline-source {
            margin-top: 0.4rem;
            font-size: 0.62rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: rgba(148, 163, 184, 0.9);
            font-weight: 700;
        }

        .source-register-footer {
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(15, 23, 42, 0.55);
            padding: 0.9rem 1rem;
            border-radius: 0.9rem;
        }

        .source-register-footer p {
            font-size: 0.63rem;
            color: rgb(148 163 184);
            text-transform: uppercase;
            letter-spacing: 0.11em;
            font-weight: 700;
            line-height: 1.45;
        }

        .sync-footer {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background: rgba(15, 23, 42, 0.92);
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .toast-stack {
            position: fixed;
            right: 1rem;
            bottom: 1rem;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 0.65rem;
            pointer-events: none;
            width: min(92vw, 360px);
        }

        .toast-item {
            pointer-events: auto;
            border-radius: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.12);
            padding: 0.75rem 0.9rem;
            color: #f8fafc;
            box-shadow: 0 20px 32px -20px rgba(2, 6, 23, 0.95);
            font-size: 0.74rem;
            line-height: 1.35;
            animation: toast-in 0.26s ease-out;
        }

        .toast-item.info {
            background: rgba(30, 64, 175, 0.92);
        }

        .toast-item.success {
            background: rgba(5, 120, 87, 0.93);
        }

        .toast-item.warning {
            background: rgba(180, 83, 9, 0.94);
        }

        .toast-item.error {
            background: rgba(153, 27, 27, 0.94);
        }

        @keyframes toast-in {
            from {
                transform: translateY(8px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .responsive-table {
            width: 100%;
            table-layout: auto;
        }

        .responsive-table th,
        .responsive-table td {
            white-space: normal;
            word-break: break-word;
            overflow-wrap: anywhere;
            vertical-align: top;
        }

        .view-panel,
        .glass-panel,
        .doc-sheet {
            min-width: 0;
        }

        @media (max-width: 1023px) {
            main {
                overflow-x: hidden;
            }

            .timeline-item {
                padding-left: 2.4rem;
            }

            .timeline-dot {
                left: 0.45rem;
            }

            .timeline-connector {
                left: 0.85rem;
            }

            .source-register-footer p {
                font-size: 0.59rem;
                letter-spacing: 0.08em;
            }
        }

        /* Forensic Document Sheets - Dark Mode Professional */
        .doc-sheet {
            background: #020617;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image:
                radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.02) 1px, transparent 0);
            background-size: 24px 24px;
        }

        .doc-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem;
            color: rgba(255, 255, 255, 0.02);
            font-weight: 900;
            pointer-events: none;
            z-index: 0;
            white-space: nowrap;
            letter-spacing: 0.5em;
        }

        .doc-sheet .border-black {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .doc-sheet .text-slate-800 {
            color: #f8fafc !important;
        }

        .doc-sheet .bg-yellow-100 {
            background: rgba(234, 179, 8, 0.1) !important;
            border-color: rgba(234, 179, 8, 0.3) !important;
            color: #fef08a !important;
        }

        .doc-sheet .bg-red-50 {
            background: rgba(239, 68, 68, 0.05) !important;
            border-color: rgba(239, 68, 68, 0.2) !important;
            color: #fca5a5 !important;
        }

        .active-doc-btn {
            background: rgba(255, 255, 255, 0.05) !important;
            border-color: var(--executive-gold) !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.1);
        }

        /* AI Forensic Inspector (Floating) */
        .ai-inspector {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 320px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Print/PDF Export Optimization */
        #pdf-export-container {
            display: none;
            position: absolute;
            left: -9999px;
            width: 800px;
            background: #020617;
            color: white;
            padding: 40px;
        }

        .pdf-page-breaker {
            page-break-after: always;
            height: 1px;
        }

        @media print {
            .view-panel {
                display: block !important;
                opacity: 1 !important;
                page-break-after: always;
            }
        }
    </style>
</head>

<body
    class="h-screen flex overflow-hidden antialiased selection:bg-executive-gold selection:text-white executive-gradient">

    <!-- MOBILE OVERLAY BACKDROP -->
    <div id="mobile-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/80 z-30 hidden lg:hidden backdrop-blur-md transition-opacity opacity-0"></div>

    <!-- EXECUTIVE SIDEBAR -->
    <aside id="sidebar" role="navigation"
        class="fixed inset-y-0 left-0 z-40 w-[var(--nav-width)] bg-executive-navy border-r border-white/5 text-slate-400 flex flex-col shadow-2xl transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 flex-shrink-0">
        <!-- Brand -->
        <div class="p-8 border-b border-white/5 flex justify-between items-center group cursor-pointer"
            onclick="switchView('dashboard')">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="w-10 h-10 rounded bg-gold-gradient flex items-center justify-center shadow-lg transform group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-scale-balanced text-white text-xl"></i>
                    </div>
                    <h1 class="font-serif text-xl font-bold tracking-[0.2em] text-white">LEX DEFENSION</h1>
                </div>
                <p class="text-[9px] uppercase tracking-[0.4em] text-executive-gold font-bold">Elite Strategic Counsel
                </p>
            </div>
            <button onclick="toggleSidebar(false)" aria-label="Close sidebar" class="lg:hidden text-slate-400 hover:text-white"><i
                    class="fa-solid fa-times text-xl"></i></button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 space-y-1 custom-scrollbar">
            <button onclick="switchView('dashboard')" id="btn-dashboard" aria-label="Case Snapshot"
                class="nav-item active w-full text-left px-8 py-4 text-[10px] font-bold uppercase tracking-[0.15em] flex items-center gap-4">
                <i class="fa-solid fa-chart-line w-5 text-center text-executive-gold"></i> Case Snapshot
            </button>
            <button onclick="switchView('intervention')" id="btn-intervention" aria-label="Immediate Protocol"
                class="nav-item w-full text-left px-8 py-4 text-[10px] font-bold uppercase tracking-[0.15em] flex items-center gap-4 bg-red-950/20 text-red-400 border-l-red-600">
                <i class="fa-solid fa-hand-shield w-5 text-center intervention-alert"></i> Immediate Protocol
            </button>
            <div class="px-8 py-4 text-[9px] uppercase tracking-widest text-slate-500 font-bold">Case Intelligence</div>
            <button onclick="switchView('chronology')" id="btn-chronology" aria-label="Forensic Timeline"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i> Forensic Timeline
            </button>
            <button onclick="switchView('harassment')" id="btn-harassment" aria-label="Forensic Audit"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-user-secret w-5 text-center"></i> Forensic Audit
            </button>
            <button onclick="switchView('matrix')" id="btn-matrix" aria-label="Truth Matrix"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-layer-group w-5 text-center"></i> Truth Matrix
            </button>
            <button onclick="switchView('legal')" id="btn-legal" aria-label="Legal Framework"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-gavel w-5 text-center"></i> Legal Framework
            </button>

            <div class="px-8 py-4 text-[9px] uppercase tracking-widest text-slate-500 font-bold">Assets & Operations
            </div>
            <button onclick="switchView('files')" id="btn-files" aria-label="Evidence Vault"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-vault w-5 text-center"></i> Evidence Vault
            </button>
            <button onclick="switchView('financial')" id="btn-financial" aria-label="Evidence Action Plan"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i> Evidence Action Plan
            </button>
            <button onclick="switchView('court')" id="btn-court" aria-label="Court Operations"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-landmark w-5 text-center"></i> Court Ops
            </button>

            <button onclick="switchView('ai')" id="btn-ai" aria-label="AI Co-Counsel"
                class="nav-item w-full text-left px-8 py-4 mt-4 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4 bg-white/5 border-l-executive-gold">
                <i class="fa-solid fa-brain w-5 text-center text-executive-gold"></i> AI Co-Counsel
            </button>
        </nav>

        <!-- Emergency Contact -->
        <div class="p-6 bg-amber-900/10 border-t border-white/5">
            <div class="flex items-center gap-3 mb-3">
                <div
                    class="w-8 h-8 rounded-full border border-executive-gold/30 flex items-center justify-center text-executive-gold">
                    <i class="fa-solid fa-phone-volume text-xs"></i>
                </div>
                <div>
                    <p class="text-[9px] uppercase text-slate-500 font-bold">Priority Support</p>
                    <p class="text-xs font-mono text-white">Duty Counsel Active</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main role="main" class="flex-1 overflow-y-auto bg-executive-navy relative smooth-scroll w-full custom-scrollbar">

        <!-- Sticky Header -->
        <header
            class="sticky top-0 z-20 bg-executive-navy/80 backdrop-blur-xl border-b border-white/5 px-6 md:px-10 py-5 flex flex-wrap gap-3 justify-between items-center shadow-2xl">
            <div class="flex items-center gap-6 min-w-0">
                <button id="sidebar-toggle" onclick="toggleSidebar()" aria-label="Open sidebar"
                    aria-controls="sidebar" aria-expanded="false"
                    class="lg:hidden text-white transition-colors hover:text-executive-gold">
                    <i class="fa-solid fa-bars-staggered text-2xl"></i>
                </button>
                <div>
                    <h2 id="page-title" class="font-serif text-xl md:text-2xl font-bold text-white tracking-tight">
                        Case Snapshot</h2>
                    <div class="flex items-center gap-3 mt-1.5">
                        <div
                            class="flex items-center gap-2 px-2 py-0.5 rounded bg-emerald-500/10 border border-emerald-500/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[9px] text-emerald-400 font-bold uppercase tracking-[0.1em]">AI Engine
                                Active</span>
                        </div>
                        <p id="page-subtitle"
                            class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em] hidden sm:block border-l border-white/10 pl-3">
                            Hearing: 23 Feb 2026 | Magistrates' Court</p>
                    </div>
                </div>
            </div>

            <div class="ml-auto flex-shrink-0 flex items-center gap-3 md:gap-6">
                <!-- Sync Status Indicator -->
                <div id="sync-status" role="status" aria-live="polite"
                    class="hidden md:flex px-4 py-2 glass-panel rounded-full items-center gap-3 cursor-pointer group transition-all hover:bg-white/5"
                    onclick="switchView('ai')">
                    <div id="sync-indicator-container" class="relative">
                        <span id="sync-indicator"
                            class="w-2.5 h-2.5 rounded-full bg-slate-500 transition-colors"></span>
                        <span id="sync-ping"
                            class="absolute inset-0 w-2.5 h-2.5 rounded-full bg-slate-500 animate-ping opacity-0"></span>
                    </div>
                    <span id="sync-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">System
                        Ready</span>
                </div>

                <button id="export-strategy-btn" type="button" onclick="exportDashboardToPDF(event)"
                    aria-label="Export Strategy Report to PDF"
                    class="relative z-50 inline-flex shrink-0 items-center gap-2 whitespace-nowrap px-5 py-2 bg-gold-gradient hover:scale-105 text-white text-[9px] font-bold uppercase tracking-[0.2em] rounded-full transition-all shadow-lg border border-white/10">
                    <i class="fa-solid fa-file-pdf"></i> <span>Export Strategy</span>
                </button>

                <div class="flex items-center gap-2">
                    <div class="h-10 w-10 rounded glass-panel executive-border text-white flex items-center justify-center font-serif font-bold text-sm shadow-xl cursor-help"
                        title="Deshpande, V. | Rank: Executive">
                        VD</div>
                </div>
            </div>
        </header>

        <div class="p-6 md:p-10 max-w-7xl mx-auto space-y-10 pb-24">

            <!-- VIEW: INTERVENTION (IMMEDIATE PROTOCOL) -->
            <div id="view-intervention" class="view-panel hidden animate-fade-in space-y-8">
                <div class="p-8 bg-red-950/25 border border-red-500/25 rounded-2xl">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-lg shadow-red-900/40">
                                <i class="fa-solid fa-hand text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-serif text-2xl font-bold text-white">Immediate Protocol</h3>
                                <p class="text-xs text-red-400 font-bold uppercase tracking-widest mt-1">Compliance +
                                    Evidence Preservation</p>
                            </div>
                        </div>
                        <div class="px-4 py-2 bg-white/10 rounded-lg border border-white/20">
                            <span class="text-[10px] text-white font-bold uppercase tracking-widest">Active</span>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="glass-panel p-6 rounded-xl border-l-4 border-l-red-500">
                            <h4 class="font-bold text-red-400 text-sm uppercase tracking-widest mb-4">Lawful Interaction
                                Script</h4>
                            <div
                                class="bg-black/40 p-5 rounded-lg border border-white/5 font-serif text-lg leading-relaxed text-white italic">
                                "Officer, I will comply with lawful directions, including name/address and testing
                                obligations. I do not wish to answer broader questions without legal advice."
                            </div>
                            <p class="text-[10px] text-slate-400 mt-4 uppercase font-bold">Use document-led, concise
                                language. Avoid speculation.</p>
                        </div>

                        <div class="glass-panel p-6 rounded-xl border-l-4 border-l-executive-gold">
                            <h4 class="font-bold text-executive-gold text-sm uppercase tracking-widest mb-4">Immediate
                                Corrective Action Rule</h4>
                            <p class="text-sm text-slate-300 leading-relaxed">
                                Strip any claim that cannot be proved by a dated record or admissible certificate.
                            </p>
                            <div class="mt-4 p-4 bg-white/5 rounded border border-white/10 text-xs text-slate-400">
                                <em>"If the evidence shows X, then the defence position is Y."</em>
                            </div>
                            <p class="text-[10px] text-slate-500 mt-3 uppercase font-bold tracking-widest">Source:
                                Forensic audit Section 2.</p>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Listed Hearing</h4>
                        <p class="text-2xl font-mono text-white">23 FEB 2026</p>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Melbourne Magistrates' Court</p>
                    </div>
                    <div class="glass-panel p-6 rounded-xl">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Primary Objective
                        </h4>
                        <p class="text-2xl font-mono text-white">Avoid Conviction</p>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Diversion preferred where available</p>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border border-emerald-500/20">
                        <h4 class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-3">Evidence Rule
                        </h4>
                        <p class="text-xs text-emerald-400 leading-relaxed">Create one indexed bundle and map each
                            document to charge elements and admissibility.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: DASHBOARD (CASE SNAPSHOT & OBJECTIVES) -->
            <div id="view-dashboard" class="view-panel animate-fade-in space-y-10">
                <!-- Global Briefing Card (Dynamic) -->
                <div class="glass-panel p-8 rounded-2xl executive-border relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-executive-gold/5 blur-[100px] -mr-32 -mt-32"></div>

                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h3 class="font-serif text-3xl font-bold text-white mb-2">Case Snapshot</h3>
                            <p class="text-xs text-executive-gold font-bold uppercase tracking-[0.3em]">AI-Generated
                                Strategy Alignment</p>
                        </div>
                        <div class="flex gap-2">
                            <span
                                class="px-3 py-1 bg-white/5 rounded-full border border-white/10 text-[9px] font-bold text-slate-400 uppercase">Live
                                Context</span>
                        </div>
                    </div>

                    <div id="ai-global-summary"
                        class="grid md:grid-cols-2 gap-12 text-slate-300 leading-relaxed text-sm">
                        <div class="space-y-4">
                            <p class="border-l-2 border-executive-gold pl-4 py-1 italic text-slate-400">Purpose: provide
                                a critical audit of the dashboard and a verified pathway to avoid conviction and/or
                                minimise penalty across the listed traffic/drug-driving charges.</p>
                            <p class="text-[11px] text-slate-500 leading-relaxed">Evidence repository access to the Google
                                Drive folder could not be programmatically verified in this environment; dashboard data is
                                treated as authoritative unless updated by certificates/brief records.</p>
                        </div>
                        <div class="glass-panel p-6 rounded-xl bg-white/[0.02]">
                            <h4
                                class="font-bold text-white text-xs uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-bolt text-executive-gold"></i> Strategic Priorities
                            </h4>
                            <ul class="space-y-3 text-xs">
                                <li class="flex items-start gap-3">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-executive-gold mt-1.5 flex-shrink-0"></span>
                                    <span>Avoid conviction wherever possible, with diversion as the preferred outcome.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-executive-gold mt-1.5 flex-shrink-0"></span>
                                    <span>If diversion is unavailable, run a minimisation pathway targeting no conviction
                                        where legally available and minimum penalty.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-executive-gold mt-1.5 flex-shrink-0"></span>
                                    <span>Protect employment/fit-and-proper standing and licence consequences through
                                        evidence-led submissions.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Strategic KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1">Primary Objective
                        </p>
                        <h4
                            class="text-xl font-serif font-bold text-white group-hover:text-executive-gold transition-colors">
                            Diversion Preferred</h4>
                        <div class="mt-4 w-full bg-white/5 h-1 rounded-full overflow-hidden">
                            <div class="bg-executive-gold w-[72%] h-full"></div>
                        </div>
                        <p class="text-[9px] text-slate-500 mt-2 text-right">Avoid conviction; fallback minimisation.</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1">Jurisdiction
                        </p>
                        <h4 class="text-xl font-serif font-bold text-white">Melbourne Magistrates' Court</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Listed hearing: 23 February 2026</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1">Charge Set
                        </p>
                        <h4 class="text-xl font-serif font-bold text-white">RSA 1986</h4>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">s30(1), s49(1)(h), s49(1)(bb)</p>
                    </div>
                    <div
                        class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group border border-emerald-500/20">
                        <p
                            class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest mb-1 focus:outline-none">
                            Evidence Position</p>
                        <h4 class="text-xl font-serif font-bold text-white">Dashboard-First</h4>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Drive repository requires ingestion and
                            verification.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: CHRONOLOGY ENGINE -->
            <div id="view-chronology" class="view-panel hidden animate-fade-in space-y-6">
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="p-8 border-b border-white/5 bg-white/[0.02]">
                        <h3 class="font-serif font-bold text-2xl text-white">Forensic Timeline</h3>
                        <p class="text-slate-500 text-sm mt-1">Canonical chronology from defence strategy mapping (08 Mar
                            2025 to 23 Feb 2026 hearing).</p>
                        <p class="text-[10px] text-amber-300 uppercase tracking-widest font-bold mt-2">Data Set: Temporary
                            canonical map pending final PDF text substitution.</p>
                    </div>
                    <div class="p-8 md:p-10 relative">
                        <div class="timeline-connector"></div>
                        <div id="canonical-timeline-list"></div>
                        <p class="text-xs text-slate-500 leading-relaxed">Verification note: timeline entries are
                            mapped to the Source Register and exhibit references for hearing-ready verification.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: POLICE CONDUCT UNIT -->
            <div id="view-harassment" class="view-panel hidden animate-fade-in space-y-8">
                <div
                    class="glass-panel border-l-4 border-l-emerald-500 rounded-2xl p-8 flex justify-between items-center group">
                    <div>
                        <h4 class="font-serif text-2xl font-bold text-white flex items-center gap-3">
                            <i
                                class="fa-solid fa-file-shield text-emerald-500 transition-transform group-hover:scale-110"></i>
                            Forensic Audit of Dashboard Narrative
                        </h4>
                        <p class="text-slate-500 text-sm mt-1">Single source of truth stress-tested for provability,
                            admissibility, and negotiation leverage.</p>
                        <div class="mt-4 flex gap-4">
                            <span
                                class="px-3 py-1 bg-white/5 rounded border border-white/10 font-mono text-[10px] text-emerald-400 uppercase font-bold">Status:
                                Audit Complete</span>
                            <span
                                class="px-3 py-1 bg-white/5 rounded border border-white/10 font-mono text-[10px] text-slate-400 uppercase font-bold tracking-tighter">Dated:
                                11 Feb 2026</span>
                        </div>
                    </div>
                    <div
                        class="w-16 h-16 rounded-full bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center text-emerald-500 shadow-inner">
                        <i class="fa-solid fa-check-double text-2xl"></i>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-panel rounded-2xl p-8 border border-white/5">
                        <h3 class="font-serif text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-list-check text-executive-gold"></i> WHAT THE DASHBOARD DOES WELL
                        </h3>
                        <div class="space-y-6">
                            <div class="p-5 bg-white/[0.02] border-l-2 border-slate-700 rounded-r-lg">
                                <p class="text-sm text-slate-300">Centralises artefacts (VicRoads letter, charge sheet
                                    screenshots, stop history, complaint reference) into one narrative.</p>
                            </div>
                            <div class="p-5 bg-white/[0.02] border-l-2 border-slate-700 rounded-r-lg">
                                <p class="text-sm text-slate-300">Identifies the honest and reasonable mistake-of-fact
                                    concept in strict-liability contexts and anchors it to <em>Proudman v Dayman</em>.
                                </p>
                            </div>
                            <div class="p-5 bg-white/[0.02] border-l-2 border-slate-700 rounded-r-lg">
                                <p class="text-sm text-slate-300">Raises procedural red flags (missing counts,
                                    inconsistent paperwork, missing impound release documentation) that support disclosure
                                    demands.</p>
                            </div>
                            <div class="p-5 bg-white/[0.02] border-l-2 border-slate-700 rounded-r-lg">
                                <p class="text-sm text-slate-300">Provides a concrete courtroom script to reduce
                                    uncontrolled admissions and maintain composure.</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-8 border border-white/5">
                        <h3 class="font-serif text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-gavel text-executive-gold"></i> IMMEDIATE CORRECTIVE ACTION
                        </h3>
                        <div class="grid gap-4 mb-6">
                            <div class="flex items-start gap-4 p-4 hover:bg-white/[0.03] transition-colors rounded-xl group cursor-help"
                                title="Immediate Escalation Strategy">
                                <div
                                    class="w-8 h-8 rounded-lg bg-executive-gold/10 border border-executive-gold/20 flex items-center justify-center text-executive-gold flex-shrink-0">
                                    <i class="fa-solid fa-gavel text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h5 class="text-xs font-bold text-white uppercase tracking-widest">Provability
                                        Filter
                                    </h5>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">Strip any claim not
                                        directly supported by a dated official document or admissible certificate.</p>
                                </div>
                            </div>
                            <div
                                class="flex items-start gap-4 p-4 hover:bg-white/[0.03] transition-colors rounded-xl group">
                                <div
                                    class="w-8 h-8 rounded-lg bg-executive-gold/10 border border-executive-gold/20 flex items-center justify-center text-executive-gold flex-shrink-0">
                                    <i class="fa-solid fa-file-contract text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h5 class="text-xs font-bold text-white uppercase tracking-widest">Conditional
                                        Framing
                                    </h5>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">Use: "If the evidence
                                        shows X, then the defence position is Y."</p>
                                </div>
                            </div>
                            <div
                                class="flex items-start gap-4 p-4 hover:bg-white/[0.03] transition-colors rounded-xl group">
                                <div
                                    class="w-8 h-8 rounded-lg bg-executive-gold/10 border border-executive-gold/20 flex items-center justify-center text-executive-gold flex-shrink-0">
                                    <i class="fa-solid fa-scale-balanced text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h5 class="text-xs font-bold text-white uppercase tracking-widest">Domain Guardrails
                                    </h5>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">Do not overstate scientific
                                        assertions or abuse-of-process/stay pathways without expert or procedural proof.</p>
                                </div>
                            </div>
                        </div>
                        <div class="p-5 bg-white/[0.02] border-l-2 border-red-400 rounded-r-lg">
                            <p class="text-xs text-slate-300 leading-relaxed">Right-to-silence scripts must be paired with
                                compliance to lawful directions (name/address and testing obligations). Misuse can create
                                new offences or aggravate sentencing outcomes.</p>
                        </div>
                    </div>
                </div>

                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5 shadow-2xl">
                    <div class="p-6 border-b border-white/5 bg-white/[0.02]">
                        <h3 class="font-serif text-xl font-bold text-white">Material Weaknesses and How to Fix Them</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="responsive-table text-left">
                            <thead>
                                <tr class="bg-white/[0.03] border-b border-white/10">
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Issue</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Why It Matters</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Likelihood</th>
                                    <th class="px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-widest">Impact</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-white/5 text-xs text-slate-300">
                                <tr>
                                    <td class="px-6 py-4">Temporal mismatch risk (licence suspension)</td>
                                    <td class="px-6 py-4">The 24 Sep VicRoads letter cannot, by itself, prove belief on 20
                                        Sep without separate earlier notice evidence.</td>
                                    <td class="px-6 py-4">High</td>
                                    <td class="px-6 py-4">High</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4">Missing or incomplete brief elements</td>
                                    <td class="px-6 py-4">Proceeding without a complete brief risks unnecessary admissions
                                        and wrong element focus.</td>
                                    <td class="px-6 py-4">High</td>
                                    <td class="px-6 py-4">High</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4">Overreach in administrative/HR consequences</td>
                                    <td class="px-6 py-4">Automatic-employment-trigger claims are often role/policy
                                        dependent and can weaken credibility.</td>
                                    <td class="px-6 py-4">Medium</td>
                                    <td class="px-6 py-4">Medium</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4">Scientific assertions without expert foundation</td>
                                    <td class="px-6 py-4">Detection-window and metabolite assertions require qualified
                                        expert support.</td>
                                    <td class="px-6 py-4">High</td>
                                    <td class="px-6 py-4">Medium</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4">Abuse-of-process / stay arguments set too high</td>
                                    <td class="px-6 py-4">Permanent stays are exceptional; complaint narratives rarely
                                        suffice alone in traffic/drug-driving matters.</td>
                                    <td class="px-6 py-4">Medium</td>
                                    <td class="px-6 py-4">High</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4">Right-to-silence script: compliance boundary</td>
                                    <td class="px-6 py-4">Scripts must not conflict with lawful direction compliance duties.</td>
                                    <td class="px-6 py-4">Medium</td>
                                    <td class="px-6 py-4">Medium</td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4">Evidence hygiene & document integrity</td>
                                    <td class="px-6 py-4">Metadata, naming, and exhibit consistency directly affect
                                        persuasiveness in diversion/plea materials.</td>
                                    <td class="px-6 py-4">Medium</td>
                                    <td class="px-6 py-4">Medium</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- VIEW: TRUTH MATRIX -->
            <div id="view-matrix" class="view-panel hidden animate-fade-in">
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5 shadow-2xl">
                    <div class="p-6 border-b border-white/5 bg-white/[0.02]">
                        <h3 class="font-serif text-2xl font-bold text-white tracking-tight">Truth Matrix</h3>
                        <p class="text-xs text-slate-500 mt-2 uppercase tracking-widest">Police allegation vs forensic
                            reality (single source register linked)</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="responsive-table text-left">
                            <thead>
                                <tr class="bg-white/[0.03] border-b border-white/10">
                                    <th
                                        class="px-4 md:px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">
                                        Police Allegation</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">
                                        Forensic Reality</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">
                                        Evidence Key</th>
                                    <th
                                        class="px-4 md:px-6 py-4 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">
                                        Source Register</th>
                                </tr>
                            </thead>
                            <tbody id="truth-matrix-body" class="divide-y divide-white/5 text-xs"></tbody>
                        </table>
                    </div>
                </div>
            </div>


            <!-- VIEW: FORENSIC FINANCIALS -->
            <div id="view-financial" class="view-panel hidden animate-fade-in space-y-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-panel rounded-2xl p-8 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-red-600/5 blur-[60px] -mr-16 -mt-16"></div>
                        <h3 class="font-serif text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-file-invoice-dollar text-executive-gold"></i> Evidence Ingestion
                            Protocol
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Step 1</span>
                                <span class="text-slate-300 font-mono text-xs">Export Drive folder as read-only local
                                    case bundle.</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Step 2</span>
                                <span class="text-slate-300 font-mono text-xs">Apply naming:
                                    YYYY-MM-DD_Source_DocType_ShortDescription.ext</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Step 3</span>
                                <span class="text-slate-300 font-mono text-xs">Build exhibit register: ID, Description,
                                    Date, Source, Relevance, Admissibility, Gaps.</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Step 4</span>
                                <span class="text-slate-300 font-mono text-xs">Hash each final exhibit with SHA-256 and
                                    record in register.</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Step 5</span>
                                <span class="text-slate-300 font-mono text-xs">Generate bookmarked court bundle PDF with
                                    indexed exhibits.</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-8 border border-red-500/10 bg-red-950/5">
                        <h3 class="font-serif text-xl font-bold text-red-500 mb-6">Charge-Specific Evidence Requirements
                        </h3>
                        <div class="space-y-6">
                            <p class="text-xs text-slate-400 leading-relaxed uppercase tracking-tighter">
                                Build each argument only after element and admissibility mapping is complete.
                            </p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                                    <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Charge 1 (s30)</p>
                                    <p class="text-[11px] text-slate-300 leading-relaxed">VicRoads status certificate,
                                        Fines Victoria directions records, service/address history, and contemporaneous
                                        belief evidence before 20 Sep 2025.</p>
                                </div>
                                <div class="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                                    <p class="text-[9px] text-emerald-400 uppercase font-bold mb-1">Charges 2-3 (s49)
                                    </p>
                                    <p class="text-[11px] text-emerald-300 leading-relaxed">Preliminary/confirmatory
                                        testing records, analyst certificates, chain-of-custody, procedure warnings, and
                                        BWC/police notes.</p>
                                </div>
                            </div>
                            <div class="p-5 bg-white/[0.02] border-t border-white/5 flex justify-between items-center">
                                <span class="text-xs text-slate-500 font-bold uppercase tracking-widest">Aggregate
                                    Conduct Evidence Leverage</span>
                                <span class="text-[11px] font-mono text-white">Negative intercept records, impound
                                    receipts/authorisations, PSC complaint chain.</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: EVIDENCE VAULT -->
            <div id="view-files" class="view-panel hidden animate-fade-in space-y-8">
                <div
                    class="glass-panel rounded-2xl overflow-hidden border border-white/5 min-h-[600px] flex flex-col shadow-2xl">
                    <div class="p-8 border-b border-white/10 bg-white/[0.03] flex justify-between items-center">
                        <div>
                            <h3 class="font-serif text-2xl font-bold text-white tracking-tight">Evidentiary Vault</h3>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Digitized
                                Forensic Exhibits | Level 5 Access</p>
                        </div>
                        <div
                            class="px-4 py-2 bg-red-950/20 border border-red-500/20 rounded text-[9px] font-bold text-red-400 uppercase tracking-widest">
                            Privileged</div>
                    </div>

                    <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
                        <!-- File Selection for Mobile -->
                        <div class="md:hidden p-4 bg-executive-navy border-b border-white/10">
                            <select onchange="showDoc(this.value.replace('exhibit-', ''), event)" aria-label="Select Exhibit"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-xs text-white focus:outline-none focus:border-executive-gold">
                                <option value="exhibit-a">Exhibit A: Source Register</option>
                                <option value="exhibit-b">Exhibit B: Court-Day Checklist</option>
                                <option value="exhibit-c">Exhibit C: Charge 1 Evidence</option>
                                <option value="exhibit-d">Exhibit D: Charges 2-3 Evidence</option>
                                <option value="exhibit-e">Exhibit E: Diversion Pack Checklist</option>
                            </select>
                            <div class="mt-4">
                                <h4 class="text-[9px] font-bold text-slate-500 uppercase mb-3 tracking-[0.2em]">Live Ingestion</h4>
                                <div class="file-list space-y-2">
                                    <!-- Google Drive files and local uploads appear here -->
                                </div>
                                <div id="drop-zone-mobile" role="button" tabindex="0" aria-label="Upload local forensic files"
                                    class="drop-zone mt-4 p-4 border-2 border-dashed border-white/5 rounded-xl text-center cursor-pointer hover:bg-white/5 transition-colors">
                                    <i class="fa-solid fa-cloud-arrow-up text-slate-500 mb-2"></i>
                                    <p class="text-[10px] text-slate-500">Add local forensic data</p>
                                </div>
                            </div>
                        </div>

                        <!-- File Tree -->
                        <aside
                            class="w-72 bg-executive-navy/50 border-r border-white/5 p-6 flex-shrink-0 hidden md:block">
                            <h4 class="text-[9px] font-bold text-slate-600 uppercase mb-6 tracking-[0.2em]">Inventory
                                Index</h4>
                            <div class="space-y-2">
                                <button onclick="showDoc('exhibit-a', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all active-doc-btn border border-transparent">
                                    <i class="fa-solid fa-book text-red-500 text-sm"></i> Exhibit A: Source Register
                                </button>
                                <button onclick="showDoc('exhibit-b', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all border border-transparent">
                                    <i class="fa-solid fa-list-check w-3.5 text-center"></i> Exhibit B: Court-Day
                                    Checklist
                                </button>
                                <button onclick="showDoc('exhibit-c', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all border border-transparent">
                                    <i class="fa-solid fa-file-shield w-3.5 text-center"></i> Exhibit C: Charge 1
                                    Evidence
                                </button>
                                <button onclick="showDoc('exhibit-d', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all border border-transparent">
                                    <i class="fa-solid fa-vials w-3.5 text-center"></i> Exhibit D: Charges 2-3 Evidence
                                </button>
                                <button onclick="showDoc('exhibit-e', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-emerald-500/80 hover:text-emerald-400 hover:bg-emerald-500/5 rounded-xl flex items-center gap-3 transition-all border border-emerald-500/20">
                                    <i class="fa-solid fa-scale-balanced text-sm"></i> Exhibit E: Diversion Pack
                                </button>
                            </div>

                            <div class="mt-8 border-t border-white/5 pt-6">
                                <h4 class="text-[9px] font-bold text-slate-600 uppercase mb-4 tracking-[0.2em]">Live
                                    Ingestion</h4>
                                <div id="file-list" class="file-list space-y-2">
                                    <!-- Google Drive files and local uploads appear here -->
                                </div>
                                <div id="drop-zone" role="button" tabindex="0" aria-label="Upload local forensic files"
                                    class="drop-zone mt-4 p-4 border-2 border-dashed border-white/5 rounded-xl text-center cursor-pointer hover:bg-white/5 transition-colors">
                                    <i class="fa-solid fa-cloud-arrow-up text-slate-500 mb-2"></i>
                                    <p class="text-[10px] text-slate-500">Add local forensic data</p>
                                    <input type="file" id="file-input" class="hidden" multiple aria-label="Upload local forensic files"
                                        onchange="handleFiles(this.files)">
                                </div>
                            </div>
                        </aside>

                        <!-- Document Viewer -->
                        <div class="flex-1 bg-black/40 p-10 overflow-y-auto relative custom-scrollbar">


                            <!-- Exhibit A -->
                            <div id="doc-exhibit-a"
                                class="doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <h2 class="font-bold text-lg mb-6 text-center">Appendix 9.1 Source Register (Primary
                                    References)</h2>
                                <div class="space-y-4 text-sm leading-relaxed">
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-1:</strong> Dashboard (primary intelligence hub)</p>
                                        <p class="text-xs text-slate-400">vikram-legal-dashboard.netlify.app (as
                                            provided).</p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-2:</strong> High Court authority on mistake-of-fact doctrine</p>
                                        <p class="text-xs text-slate-400"><a class="underline text-emerald-300"
                                                href="https://www.hcourt.gov.au/cases-and-judgments/judgments/1-clr-100-clr/proudman-v-dayman"
                                                target="_blank" rel="noopener noreferrer">Proudman v Dayman (1941) 67 CLR
                                                536</a></p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-3:</strong> Judgment reference for pinpointing</p>
                                        <p class="text-xs text-slate-400">Proudman v Dayman [HCA 28] PDF (High Court of
                                            Australia).</p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-4:</strong> Supporting strict-liability / mistake analysis</p>
                                        <p class="text-xs text-slate-400"><a class="underline text-emerald-300"
                                                href="https://www.hcourt.gov.au/cases-and-judgments/judgments/judgments-2000-current/ctm-v-queen"
                                                target="_blank" rel="noopener noreferrer">CTM v The Queen (2008) 236 CLR
                                                440; [2008] HCA 25</a></p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-5:</strong> Diversion statutory basis (Victoria)</p>
                                        <p class="text-xs text-slate-400"><a class="underline text-emerald-300"
                                                href="https://www.legislation.vic.gov.au/in-force/acts/criminal-procedure-act-2009"
                                                target="_blank" rel="noopener noreferrer">Criminal Procedure Act 2009 (Vic)
                                                s59</a></p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-6:</strong> Traffic / drug-driving offence basis (Victoria)</p>
                                        <p class="text-xs text-slate-400"><a class="underline text-emerald-300"
                                                href="https://www.legislation.vic.gov.au/in-force/acts/road-safety-act-1986"
                                                target="_blank" rel="noopener noreferrer">Road Safety Act 1986 (Vic)</a>
                                        </p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-7:</strong> Fit-and-proper standard (regulated entities)</p>
                                        <p class="text-xs text-slate-400"><a class="underline text-emerald-300"
                                                href="https://handbook.apra.gov.au/standard/cps-520"
                                                target="_blank" rel="noopener noreferrer">APRA Prudential Standard CPS
                                                520</a></p>
                                    </div>
                                    <div class="p-4 border border-white/10 rounded-lg">
                                        <p><strong>SR-8:</strong> Sentencing statistics portal (Victoria)</p>
                                        <p class="text-xs text-slate-400"><a class="underline text-emerald-300"
                                                href="https://www.sentencingcouncil.vic.gov.au/sentencing-statistics"
                                                target="_blank" rel="noopener noreferrer">Sentencing Advisory Council
                                                (SACStat)</a></p>
                                    </div>
                                </div>
                                <div class="doc-watermark">EXHIBIT A</div>
                            </div>

                            <!-- Exhibit B: Court-Day Checklist -->
                            <div id="doc-exhibit-b"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <h2 class="font-bold text-lg mb-4 text-center">Appendix 9.2 Court-Day Checklist
                                    (Melbourne Magistrates' Court)</h2>
                                <ul class="list-disc ml-6 space-y-3 text-sm leading-relaxed">
                                    <li>Bring 4 printed sets: (A) diversion pack, (B) exhibit index, (C) brief-gap letter,
                                        (D) fallback plea bundle.</li>
                                    <li>Bring photo ID and proof of address (if available).</li>
                                    <li>Arrive early and ask prosecutions counter whether a resolution discussion is
                                        available before list callover.</li>
                                    <li>Do not discuss case facts with police in the corridor. Keep communications
                                        respectful and minimal.</li>
                                    <li>If seeking adjournment: identify specific missing documents, why they matter, and
                                        realistic completion timeframe.</li>
                                    <li>If seeking diversion: lead with accountability conditions, then low reoffending risk,
                                        then disproportionate conviction consequences.</li>
                                    <li>Do not volunteer unasked explanations. Avoid drug-detection science submissions
                                        without expert report.</li>
                                    <li>After court: comply immediately with conditions (testing, education, fines plan) and
                                        preserve proof.</li>
                                </ul>
                                <div class="doc-watermark">EXHIBIT B</div>
                            </div>

                            <!-- Exhibit C: Charge 1 Evidence -->
                            <div id="doc-exhibit-c"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <h2 class="font-bold text-lg mb-4 text-center">Section 7.2 Evidence Requirements:
                                    Charge 1 (RSA s30)</h2>
                                <ul class="list-disc ml-6 space-y-3 text-sm leading-relaxed">
                                    <li>VicRoads status certificate/printout showing suspension start/end dates, legal
                                        basis, and service details.</li>
                                    <li>Fines Victoria directions records: direction start/end, correspondence trail, and
                                        service address history.</li>
                                    <li>Proof of address instability during relevant period (tenancy termination, mail
                                        redirection, address update notices).</li>
                                    <li>Contemporaneous evidence of belief on/before 20 Sep 2025: portal screenshots, call
                                        logs, emails/SMS, payment confirmations.</li>
                                    <li>Prosecution material request set: licence status certificate, notice proof, and
                                        proof of driving/identity (BWC/intercept notes).</li>
                                </ul>
                                <div class="doc-watermark">EXHIBIT C</div>
                            </div>

                            <!-- Exhibit D: Charges 2-3 Evidence -->
                            <div id="doc-exhibit-d"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <h2 class="font-bold text-lg mb-4 text-center">Section 7.2 Evidence Requirements:
                                    Charges 2-3 (RSA s49)</h2>
                                <ul class="list-disc ml-6 space-y-3 text-sm leading-relaxed">
                                    <li>All testing paperwork: preliminary oral fluid record, confirmatory analysis
                                        certificate, analyst certificates, sample ID/seal records.</li>
                                    <li>Chain-of-custody records: seals, transfers, lab receipt logs, and time sequence
                                        continuity.</li>
                                    <li>Police procedure proof: grounds for testing requirement, warnings delivered,
                                        compliance steps, and BWC/police notes.</li>
                                    <li>Charge-wording support documents for any s49(1)(h) framing issue (exact wording is
                                        critical).</li>
                                    <li>If science is contested: retain forensic toxicologist to interpret certificate
                                        results and realistic detection windows.</li>
                                </ul>
                                <div class="doc-watermark">EXHIBIT D</div>
                            </div>

                            <!-- Exhibit E: Diversion Pack Checklist -->
                            <div id="doc-exhibit-e"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <h2 class="font-bold text-lg mb-4 text-center">Section 6.1 Diversion Pack Checklist
                                    (Exhibit-Ready)</h2>
                                <ul class="list-disc ml-6 space-y-3 text-sm leading-relaxed">
                                    <li>1-page executive cover letter: outcome sought and summary of proposed conditions.</li>
                                    <li>Chronology (1-2 pages) with citations to attachments.</li>
                                    <li>Signed accountability statement acknowledging court concerns and compliance
                                        commitments.</li>
                                    <li>Proof of steps taken: counselling appointment, education enrolment, fines plan,
                                        licence-status confirmation requests.</li>
                                    <li>Character references identifying writer, relationship, awareness of charges, and
                                        observations of responsibility/compliance.</li>
                                    <li>Employment/fit-and-proper impact letter (fact-based, non-hyperbolic).</li>
                                    <li>Supporting hardship documents kept concise and directly relevant.</li>
                                    <li>Include practical deliverables: drug education, counselling, community benefit,
                                        testing, and proof of status regularisation.</li>
                                </ul>
                                <div class="mt-8 pt-4 border-t border-slate-300 text-xs italic">Caveat: s59 diversion
                                    eligibility is charge-specific and may be limited for certain offences (check current
                                    statutory exclusions and prosecution stance).</div>
                                <div class="doc-watermark text-emerald-50/10">EXHIBIT E</div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: LEGAL/TOX -->
            <div id="view-legal" class="view-panel hidden animate-fade-in space-y-10">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-panel p-8 rounded-2xl border border-white/5">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h3 class="font-serif text-2xl font-bold text-white tracking-tight">Section 8.2 Visual
                                    Prioritisation Aids</h3>
                                <p class="text-[9px] text-executive-gold font-bold uppercase tracking-widest mt-1">
                                    Indicative probabilities (expert estimate; not official statistics)</p>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 250px;">
                            <canvas id="toxChart"></canvas>
                        </div>
                        <div class="chart-container mt-8" style="height: 240px;">
                            <canvas id="impactChart"></canvas>
                        </div>
                        <div class="mt-8 p-6 bg-executive-gold/5 border-l-2 border-executive-gold rounded-r-xl">
                            <p class="text-xs text-slate-400 leading-relaxed italic">
                                "Probabilities are indicative estimates for prioritisation. Use official datasets (for
                                example SACStat) to calibrate expectations once exact offence framing and court level are
                                confirmed."
                            </p>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div class="glass-panel p-8 rounded-2xl border border-white/5 relative">
                            <h4
                                class="text-xs font-bold text-white uppercase tracking-widest mb-6 flex items-center gap-3">
                                <i class="fa-solid fa-scale-balanced text-executive-gold"></i> SECTION 3.1 CORE DOCTRINES
                                AND TOOLS
                            </h4>
                            <div class="space-y-8">
                                <div class="group">
                                    <h5
                                        class="font-serif text-lg font-bold text-white group-hover:text-executive-gold transition-colors underline decoration-white/10 underline-offset-8">
                                        Proudman v Dayman (1941)</h5>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-3">High
                                        Court of Australia | 67 CLR 536</p>
                                    <p class="text-xs text-slate-400 mt-3 leading-relaxed">
                                        Honest and reasonable mistake of fact can negate strict-liability offences where
                                        the defendant honestly believed facts that, if true, made the act innocent.
                                    </p>
                                    <div
                                        class="mt-4 p-4 bg-white/[0.02] border border-white/5 rounded-lg text-[10px] text-slate-500">
                                        <strong class="text-executive-gold uppercase tracking-tighter">Tactical
                                            Application:</strong> Use contemporaneous records of belief (portal/call logs,
                                        notice trail), not post-dated documents alone.
                                    </div>
                                </div>
                                <div class="group">
                                    <h5
                                        class="font-serif text-lg font-bold text-white group-hover:text-executive-gold transition-colors underline decoration-white/10 underline-offset-8">
                                        Criminal Procedure Act 2009 (s 59)</h5>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-3">
                                        Diversion Framework (Victoria)</p>
                                    <p class="text-xs text-slate-400 mt-3 leading-relaxed">
                                        Diversion adjourns proceedings and discharges the accused on conditions when
                                        appropriate.
                                    </p>
                                </div>
                                <div class="group">
                                    <h5
                                        class="font-serif text-lg font-bold text-white group-hover:text-executive-gold transition-colors underline decoration-white/10 underline-offset-8">
                                        Fit-and-Proper / Sentencing Data</h5>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-3">APRA
                                        CPS 520 + SACStat</p>
                                    <p class="text-xs text-slate-400 mt-3 leading-relaxed">
                                        Occupational impact is role and framework dependent; sentencing benchmarks should be
                                        taken from Victorian sentencing datasets.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 rounded-2xl border border-red-500/20 bg-red-950/5/5">
                            <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-2">SOURCE NOTE:
                                DIVERSION ELIGIBILITY CAVEAT</p>
                            <p class="text-xs text-slate-400 leading-relaxed font-medium">
                                Verified legislation indicates section 59 has offence exclusions (including certain Road
                                Safety Act s49(1) offences). Treat diversion as charge-by-charge eligibility plus
                                prosecution/court practice, not an automatic entitlement.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-8 rounded-2xl border border-white/5">
                    <h4 class="font-serif text-xl font-bold text-white mb-4">Section 3.2 Critical Guardrails for Legal
                        Argument Quality</h4>
                    <ul class="list-disc ml-6 space-y-2 text-sm text-slate-300 leading-relaxed">
                        <li>Separate provable facts (documents/certificates) from submissions (discretion requests).</li>
                        <li>Do not run doctrines outside domain limits: mistake-of-fact does not itself defeat a properly
                            proved drug-present certificate absent statutory pathway or proof defect.</li>
                        <li>Treat diversion as a package: education, counselling, testing, references, and low-reoffending
                            structure.</li>
                        <li>Treat targeting/harassment primarily as complaint/FOI track unless linked to concrete
                            evidentiary unfairness.</li>
                    </ul>
                    <p class="text-sm text-slate-400 mt-6">Section 3.3 proof mapping: every charge needs element proof
                        (driving/identity/status or drug presence) and admissibility proof (certificates, continuity, lawful
                        procedure).</p>
                </div>

                <div class="glass-panel p-8 rounded-2xl border border-white/5">
                    <h4 class="font-serif text-xl font-bold text-white mb-4">Section 4.1 Charge 1 (RSA s30(1)) Driving
                        While Authorisation Suspended</h4>
                    <p class="text-sm text-slate-300 leading-relaxed mb-4">Key audit issue: a VicRoads letter dated 24 Sep
                        2025 does not, by itself, prove belief on 20 Sep 2025. It remains relevant to short-duration
                        administrative context.</p>
                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">What to Demand from
                        Prosecution</h5>
                    <ul class="list-disc ml-6 space-y-2 text-sm text-slate-300 mb-5">
                        <li>Licence status certificate showing suspension start/end and legal basis.</li>
                        <li>Notice/service evidence (postal or electronic records).</li>
                        <li>Driving/identity proof (BWC/intercept notes) for exact time and location.</li>
                    </ul>
                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Ranked Contest Theories
                    </h5>
                    <ul class="list-disc ml-6 space-y-2 text-sm text-slate-300 mb-5">
                        <li>Suspension not in force at material time (best if supported by VicRoads/Fines Victoria
                            records).</li>
                        <li>Identity/driving dispute (usually low yield in clear intercept matters).</li>
                        <li>Honest and reasonable mistake of fact supported by contemporaneous communications/logs.</li>
                    </ul>
                    <p class="text-sm text-slate-400">If contest is weak: prepare diversion package and fallback plea
                        minimisation bundle targeting no-conviction discretion where legally available.</p>
                </div>

                <div class="glass-panel p-8 rounded-2xl border border-white/5">
                    <h4 class="font-serif text-xl font-bold text-white mb-4">Section 4.2 Charges 2-3 (RSA s49) Oral Fluid
                        / Drug Presence</h4>
                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Evidence Checklist
                        (Non-Negotiable)</h5>
                    <ul class="list-disc ml-6 space-y-2 text-sm text-slate-300 mb-5">
                        <li>Preliminary oral-fluid record + confirmatory analysis certificate + analyst identity.</li>
                        <li>Chain-of-custody records (seals, sample IDs, transfers, lab receipt logs, dates/times).</li>
                        <li>Procedure proof: lawful grounds, warnings, and compliance steps.</li>
                        <li>Independent medical/counselling records for mitigation context (not scientific defence by
                            default).</li>
                    </ul>
                    <h5 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-2">Ranked Contest Avenues
                    </h5>
                    <ul class="list-disc ml-6 space-y-2 text-sm text-slate-300 mb-5">
                        <li>Procedural defect in testing requirement/warning compliance.</li>
                        <li>Certificate/continuity defect (sample mismatch, seals, unexplained gaps).</li>
                        <li>Duplicative charging negotiation where counts arise from same testing sequence.</li>
                    </ul>
                    <p class="text-sm text-slate-400">Scientific caution: detection-window/metabolite arguments are expert
                        evidence territory. If contesting science, retain qualified forensic toxicology support.</p>
                </div>
            </div>

            <!-- VIEW: COURT OPERATIONS -->
            <div id="view-court" class="view-panel hidden animate-fade-in space-y-10">
                <div
                    class="glass-panel rounded-2xl border border-white/5 overflow-hidden flex flex-col md:flex-row h-[750px] shadow-3xl">
                    <!-- Hearing Roadmap -->
                    <div
                        class="w-full md:w-80 bg-executive-navy/50 border-r border-white/5 p-10 overflow-y-auto custom-scrollbar">
                        <h3 class="font-serif text-xl font-bold text-white mb-10 tracking-tight">Procedural Pathway &
                            Hearing Plan</h3>
                        <div class="space-y-10 relative">
                            <div class="absolute left-2.5 top-0 bottom-0 w-[1px] bg-white/5"></div>

                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-slate-800 border-2 border-executive-navy flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-white uppercase tracking-[0.2em] mb-2">Day 0-1 |
                                    Immediate</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Create single evidence bundle,
                                    demand complete brief, and request written VicRoads/Fines Victoria status for 20 Sep
                                    and 03 Nov periods.</p>
                            </div>
                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-executive-gold/20 border-2 border-executive-gold/50 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-executive-gold animate-ping"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-executive-gold uppercase tracking-[0.2em] mb-2">
                                    Day 2-4 | Element Mapping</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Map evidence to each element and
                                    admissibility requirement; rewrite narrative into conditional, document-supported
                                    statements; draft diversion materials.</p>
                            </div>
                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-emerald-500/10 border-2 border-emerald-500/40 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-emerald-400 uppercase tracking-[0.2em] mb-2">Day
                                    5-7 | Negotiation</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Engage prosecution on brief gaps and
                                    streamlining/withdrawal opportunities; if certificates are clean, pivot to
                                    mitigation/diversion focus.</p>
                            </div>
                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-emerald-500/10 border-2 border-emerald-500/40 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-emerald-400 uppercase tracking-[0.2em] mb-2">Day
                                    8-10 | Finalise Pack</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Finalize diversion exhibits, prepare
                                    mention script for brief incompleteness, and lock transport/attendance compliance.</p>
                            </div>
                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-emerald-500/10 border-2 border-emerald-500/40 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-emerald-400 uppercase tracking-[0.2em] mb-2">Day
                                    11-12 | Pre-Hearing</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Print and bind diversion/adjournment
                                    /fallback bundles; rehearse short oral submissions; confirm counsel logistics.</p>
                            </div>
                        </div>

                        <!-- Magistrate Feedback Box -->
                        <div class="mt-12 p-6 rounded-2xl bg-white/[0.02] border border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <h6 class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Judicial
                                    Simulator</h6>
                                <button onclick="triggerAIAction('simulate-magistrate')" aria-label="Simulate magistrate feedback"
                                    class="text-executive-gold hover:text-white transition-colors">
                                    <i class="fa-solid fa-play text-[10px]"></i>
                                </button>
                            </div>
                            <div id="magistrate-feedback" class="text-[10px] text-slate-500 italic leading-relaxed">
                                Click to simulate hostile judicial cross-examination...
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Script -->
                    <div class="flex-1 flex flex-col bg-black/10">
                        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                            <div>
                                <h4 class="text-[10px] font-bold text-white uppercase tracking-[0.3em]">Oral Submission
                                    Script</h4>
                                <p class="text-[8px] text-slate-600 uppercase font-bold tracking-widest mt-1">Legally
                                    Privileged | Verified Victorian Precedent</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="court-save-indicator" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Not saved</span>
                                <button onclick="triggerAIAction('refine-script')"
                                    class="px-5 py-2 bg-executive-gold/10 hover:bg-executive-gold/20 text-executive-gold text-[9px] font-bold uppercase tracking-[0.2em] rounded-full transition-all flex items-center gap-2 border border-executive-gold/20">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI Strategic Refine
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 p-0">
                            <textarea id="courtScript"
                                class="w-full h-full p-12 bg-transparent text-slate-300 font-serif text-lg leading-relaxed resize-none focus:outline-none custom-scrollbar"
                                spellcheck="false" oninput="debounceSaveState()">
**OPENING**
"Your Honour, I appear self-represented. I confirm my name and I seek to proceed on an evidence-led basis. I have prepared indexed materials addressing diversion, brief completeness, and fallback mitigation."

**PRIMARY POSITION: DIVERSION / ADJOURNMENT FOR DIVERSION PACKAGE**
"I request diversion where available, or a short adjournment if required to complete the diversion package and obtain missing brief documents. My materials include accountability conditions, counselling/education steps, and compliance planning."

**CHARGE 1 POSITION (RSA s30(1))**
"The key issue is what the prosecution can prove about suspension status and notice at 20 September 2025. I rely on contemporaneous records and seek strict proof of suspension dates, service evidence, and driving/identity particulars."

**CHARGES 2-3 POSITION (RSA s49)**
"I request full certificates, continuity records, and procedure evidence. If those are complete, I seek streamlining and mitigation-focused resolution; if defects appear, I seek appropriate withdrawal or contest directions."

**FALLBACK MITIGATION**
"If diversion is not available, I seek the least punitive lawful outcome with no conviction where discretion exists, supported by objective rehabilitation and employment-impact material."

**CLOSING**
"I will comply immediately with any court conditions and provide documentary proof of completion."
</textarea>
                        </div>
                    </div>
                </div>
            </div>



            <!-- VIEW: AI CO-COUNSEL -->
            <div id="view-ai" class="view-panel hidden animate-fade-in h-[calc(100vh-140px)] flex flex-col">
                <div
                    class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden border border-white/5 shadow-3xl">
                    <!-- AI Header -->
                    <div class="p-8 border-b border-white/5 bg-white/[0.03] flex justify-between items-center gap-6">
                        <div class="flex items-center gap-6">
                            <div
                                class="h-16 w-16 rounded-2xl bg-gold-gradient flex items-center justify-center shadow-2xl transform hover:rotate-3 transition-transform">
                                <i class="fa-solid fa-brain text-white text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="font-serif text-2xl font-bold text-white tracking-tight">AI Co-Counsel</h3>
                                <div class="flex items-center gap-3 mt-1">
                                    <span class="flex h-2 w-2 relative">
                                        <span
                                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                    </span>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Gemini
                                        1.5 Flash  High Security Node</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <div class="hidden xl:flex flex-col gap-2">
                                <input type="password" id="gemini-api-key" placeholder="Gemini API Key"
                                    class="text-[9px] bg-white/5 border border-white/10 rounded-lg px-4 py-2 w-48 text-white focus:outline-none focus:border-executive-gold transition-all">
                                <input type="text" id="google-client-id" placeholder="Google Client ID"
                                    class="text-[9px] bg-white/5 border border-white/10 rounded-lg px-4 py-2 w-48 text-white focus:outline-none focus:border-executive-gold transition-all">
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="saveKeys()"
                                    class="text-[9px] font-bold uppercase tracking-widest bg-white/10 hover:bg-white/20 text-white px-6 py-2 rounded-lg transition-all border border-white/10">Save
                                    Config</button>
                                <button id="btn-auth" onclick="handleAuthClick()"
                                    class="text-[9px] font-bold uppercase tracking-widest bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-all shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-brands fa-google"></i> Connect Drive</button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Strategy Actions -->
                    <div
                        class="px-8 py-4 bg-white/[0.02] border-b border-white/5 flex gap-4 overflow-x-auto custom-scrollbar no-scrollbar">
                        <button onclick="triggerAIAction('analyze-strength')"
                            class="flex-shrink-0 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/10 hover:border-executive-gold/50 hover:text-executive-gold px-6 py-2.5 rounded-full transition-all shadow-sm">
                             Strategy Audit
                        </button>
                        <button onclick="triggerAIAction('draft-complaint')"
                            class="flex-shrink-0 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/10 hover:border-emerald-500/50 hover:text-emerald-400 px-6 py-2.5 rounded-full transition-all shadow-sm">
                             Build Diversion Pack
                        </button>
                        <button onclick="triggerAIAction('simulate-cross')"
                            class="flex-shrink-0 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/10 hover:border-red-500/50 hover:text-red-400 px-6 py-2.5 rounded-full transition-all shadow-sm">
                             Contest Weakness Simulation
                        </button>
                    </div>

                    <!-- Executive Chat Environment -->
                    <div id="chat-history" class="flex-1 overflow-y-auto p-10 space-y-8 bg-black/40 custom-scrollbar">
                        <div class="flex gap-6">
                            <div
                                class="w-12 h-12 rounded-xl bg-executive-navy border border-executive-gold/30 flex-shrink-0 flex items-center justify-center mt-1 shadow-xl">
                                <i class="fa-solid fa-scale-balanced text-executive-gold text-lg"></i>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl rounded-tl-none border border-white/5 max-w-[85%]">
                                <p class="text-sm text-slate-300 leading-relaxed font-serif">
                                    <strong class="text-white text-lg block mb-4">Strategic Environment Active.</strong>
                                    Working mode is now evidence-led and condition-based. Current focus is charging
                                    element proof, admissibility proof, and resolution pathway selection:
                                </p>
                                <ul class="mt-6 space-y-4 text-sm text-slate-400">
                                    <li class="flex gap-3"><i class="fa-solid fa-check text-executive-gold mt-1"></i>
                                        <span class="leading-relaxed"><strong>Charge 1:</strong> test suspension status
                                            proof, notice evidence, and contemporaneous belief records before relying on
                                            mistake-of-fact submissions.</span>
                                    </li>
                                    <li class="flex gap-3"><i class="fa-solid fa-check text-executive-gold mt-1"></i>
                                        <span class="leading-relaxed"><strong>Charges 2-3:</strong> audit certificates,
                                            continuity, and procedural compliance; if clean, prioritise diversion/mitigation
                                            over speculative technical contest.</span>
                                    </li>
                                </ul>
                                <p class="mt-8 text-xs text-slate-500 uppercase tracking-widest font-bold">How shall we
                                    proceed on the next evidence item?</p>
                            </div>
                        </div>
                    </div>

                    <!-- Intelligence Input Area -->
                    <div class="p-8 bg-black/60 border-t border-white/10">
                        <div class="max-w-4xl mx-auto flex gap-4 relative">
                            <textarea id="chat-input" rows="1"
                                class="w-full bg-white/5 border border-white/10 rounded-2xl pl-6 pr-16 py-5 text-sm text-white focus:outline-none focus:border-executive-gold transition-all resize-none shadow-2xl"
                                placeholder="Execute strategic inquiry or document request..."
                                onkeydown="handleChatInput(event)"></textarea>
                            <button onclick="sendMessage()" aria-label="Send Message"
                                class="absolute right-3 top-3 bottom-3 w-12 bg-gold-gradient hover:scale-105 text-white rounded-xl flex items-center justify-center transition-all shadow-lg">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                        <div class="flex justify-center items-center gap-6 mt-6">
                            <p class="text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em]">
                                <i class="fa-solid fa-shield-halved mr-2 text-executive-gold"></i> AES-256 Encrypted
                                Context
                            </p>
                            <p class="text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em]">
                                <i class="fa-solid fa-building-columns mr-2"></i> Counsel-Client Privileged
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="sync-footer sticky bottom-0 z-10 px-4 md:px-8 py-3">
                <div class="max-w-7xl mx-auto flex items-center justify-between gap-3">
                    <p id="last-synced-indicator"
                        class="text-[10px] text-slate-400 uppercase tracking-widest font-bold">
                        Last Synced: Never
                    </p>
                    <p id="sync-mode-indicator"
                        class="text-[10px] text-slate-500 uppercase tracking-widest font-bold">
                        Sync Mode: Online
                    </p>
                </div>
            </footer>
        </div>
    </main>

    <div id="strategy-context-hidden" class="sr-only" aria-hidden="true">
        Core Defence Context: Proudman v Dayman remains the primary strict-liability mistake-of-fact anchor and must be
        argued with contemporaneous records only. Diversion under Criminal Procedure Act 2009 (Vic) section 59 is to be
        pursued where legally open, with fallback minimisation and no-conviction submissions where discretion exists.
        Maintain evidence-led, conditional drafting and avoid speculative or overstated claims.
    </div>
    <div id="toast-stack" class="toast-stack" aria-live="polite" aria-atomic="true"></div>

    <script>
        // --- SECURITY: OBFUSCATION UTILITIES ---
        const _K = "LEX_DEFENSION_2026"; // Internal obfuscation key
        function _obs(s) {
            if (!s) return "";
            return btoa(s.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ _K.charCodeAt(i % _K.length))).join(''));
        }
        function _deobs(s) {
            if (!s) return "";
            try {
                const d = atob(s);
                return d.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ _K.charCodeAt(i % _K.length))).join('');
            } catch (e) { return ""; }
        }

        // --- SECURITY: XSS SANITIZATION ---
        function sanitize(str) {
            if (!str) return "";
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '/': '&#x2F;' };
            return str.replace(/[&<>"'/]/g, s => map[s]);
        }
        function formatAIResponse(text) {
            // Sanitize first
            let clean = sanitize(text);
            // Then re-enable bolding and line breaks for UI
            return clean.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        function applyAriaLabels() {
            const elements = document.querySelectorAll('button, [role="button"], input, select, textarea, a[href]');
            elements.forEach(el => {
                if (!el.getAttribute('aria-label')) {
                    const label = el.getAttribute('placeholder') || el.getAttribute('title') || (el.innerText || '').trim();
                    el.setAttribute('aria-label', label || 'Action');
                }
            });
        }

        // Global variables to hold chart instances
        let toxChartInstance = null;
        let impactChartInstance = null;
        let uploadedFiles = []; // Store uploaded file metadata
        let syncMode = 'online';
        let syncIntervalId = null;

        const CORE_DEFENCE_CONTEXT = `
Core Defence Defaults (non-optional):
- Primary doctrinal anchor: Proudman v Dayman (1941) 67 CLR 536 on honest and reasonable mistake of fact.
- Resolution priority: Diversion under Criminal Procedure Act 2009 (Vic) s59 where legally available.
- If diversion is unavailable: fallback minimisation with no-conviction submissions where judicial discretion permits.
- Argument standard: evidence-led, conditional drafting; avoid speculation and unsupported scientific or career-impact overstatement.
`.trim();

        // Temporary canonical map derived from the current strategy pack and exhibits.
        // Replace with final extracted values once Police_v_Deshpande_Executive_Defence_Strategy.pdf text is supplied.
        const CANONICAL_TIMELINE_EVENTS = [
            {
                dateLabel: '08 Mar 2025',
                title: 'Redundancy Enacted',
                note: 'Employment terminated, initiating documented financial hardship and dependency on vehicle access.',
                sourceRefs: ['SR-1', 'EX-C Hardship Chronology'],
                severity: 'context'
            },
            {
                dateLabel: '30 Apr 2025',
                title: 'Loss of Tenancy',
                note: 'Address instability begins; relevant to notice-service and communication continuity submissions.',
                sourceRefs: ['SR-1', 'EX-C Address History'],
                severity: 'context'
            },
            {
                dateLabel: '20 Sep 2025',
                title: 'Burnley Intercept (Monash Fwy)',
                note: 'Charge 1 allegation date (RSA s30(1)); requires strict proof of status, notice, and identity at material time.',
                sourceRefs: ['SR-6', 'EX-B Charge Sheet'],
                severity: 'critical'
            },
            {
                dateLabel: '24 Sep 2025',
                title: 'VicRoads/Fines Direction End Date',
                note: 'Letter states directions ended on 24 Sep 2025; supports mistake-of-fact framing but does not alone prove 20 Sep belief state.',
                sourceRefs: ['SR-2', 'EX-A VicRoads Letter'],
                severity: 'anchor'
            },
            {
                dateLabel: '03 Nov 2025',
                title: 'Oakleigh Oral Fluid / Drug Charges',
                note: 'Charges 2-3 (RSA s49(1)(h), s49(1)(bb)) require certificate, continuity, and procedure compliance proof.',
                sourceRefs: ['SR-6', 'EX-D Testing Materials'],
                severity: 'critical'
            },
            {
                dateLabel: '22 Nov 2025',
                title: 'Fines Victoria Summary Generated',
                note: 'Debt and enforcement context generated; used for hardship context, not as primary liability proof.',
                sourceRefs: ['SR-1', 'EX-D Fines Summary'],
                severity: 'context'
            },
            {
                dateLabel: '07 Jan 2026',
                title: 'Intercept Sequence Commences',
                note: 'First listed negative-alcohol intercept in complaint chronology.',
                sourceRefs: ['SR-1', 'EX-E Complaint Chronology'],
                severity: 'critical'
            },
            {
                dateLabel: '19 Jan 2026',
                title: 'Negative Intercept Record',
                note: 'Second listed negative intercept event in harassment chronology.',
                sourceRefs: ['SR-1', 'EX-E Complaint Chronology'],
                severity: 'critical'
            },
            {
                dateLabel: '21 Jan 2026',
                title: 'Original Hearing Listing',
                note: 'Matter listed before consolidated mention path; procedural tracking reference point.',
                sourceRefs: ['SR-1', 'EX-B Court Listing'],
                severity: 'anchor'
            },
            {
                dateLabel: '01 Feb 2026',
                title: 'Additional Negative Intercept',
                note: 'Fourth listed negative-alcohol intercept in complaint chronology.',
                sourceRefs: ['SR-1', 'EX-E Complaint Chronology'],
                severity: 'critical'
            },
            {
                dateLabel: '09 Feb 2026',
                title: 'Stop #5 and Vehicle Seizure Event',
                note: 'Complaint references seizure despite no firm suspicion indicators; central to conduct narrative.',
                sourceRefs: ['SR-1', 'EX-E Complaint Letter'],
                severity: 'critical'
            },
            {
                dateLabel: '09 Feb 2026  22:45',
                title: 'Vehicle Recovery (Box Hill)',
                note: 'Immediate release event relevant to necessity/proportionality challenge and mitigation context.',
                sourceRefs: ['SR-1', 'EX-E Recovery Record'],
                severity: 'anchor'
            },
            {
                dateLabel: '23 Feb 2026',
                title: 'Listed Hearing Date',
                note: 'Melbourne Magistrates Court hearing target: diversion first, fallback minimisation if diversion unavailable.',
                sourceRefs: ['SR-5', 'SR-6', 'EX-B Court Notice'],
                severity: 'hearing'
            }
        ];

        const CANONICAL_TRUTH_MATRIX_ROWS = [
            {
                allegation: 'Random roadside testing',
                forensicReality: 'Chronology shows a concentrated repeat-intercept pattern requiring strict procedural explanation.',
                evidenceKey: '5 stops in 33 days chronology packet',
                sourceRefs: ['SR-1', 'EX-E']
            },
            {
                allegation: 'Suspension was clearly active and known',
                forensicReality: '24 Sep direction-end letter is temporally close but still requires strict service and status proof for 20 Sep.',
                evidenceKey: 'VicRoads/Fines direction-end record',
                sourceRefs: ['SR-2', 'SR-6', 'EX-A']
            },
            {
                allegation: 'Refusal posture indicates guilt',
                forensicReality: 'Right-to-silence scripts are lawful when paired with compliance to lawful directions and testing duties.',
                evidenceKey: 'Court script + lawful-compliance protocol',
                sourceRefs: ['SR-1', 'EX-B']
            },
            {
                allegation: 'Drug-present charges are self-proving',
                forensicReality: 'Certificate continuity, warnings, and analyst proof remain mandatory for admissibility and weight.',
                evidenceKey: 'Testing paperwork + chain of custody file set',
                sourceRefs: ['SR-6', 'EX-D']
            },
            {
                allegation: 'Seizure was necessary for safety',
                forensicReality: 'Rapid release without charge-linked follow-through is probative on proportionality and discretion use.',
                evidenceKey: 'Box Hill release chronology (09 Feb 2026)',
                sourceRefs: ['SR-1', 'EX-E']
            },
            {
                allegation: 'Diversion is not case-anchored',
                forensicReality: 'Diversion remains a charge-by-charge pathway under CPA s59 with accountable conditions.',
                evidenceKey: 'Diversion pack checklist and statutory basis',
                sourceRefs: ['SR-5', 'EX-E']
            }
        ];

        const SECTION_SOURCE_REGISTER = {
            dashboard: 'Ref: SR-1 Dashboard Core; SR-2 Proudman v Dayman; SR-5 CPA s59; SR-6 Road Safety Act 1986.',
            intervention: 'Ref: SR-2 Proudman v Dayman; SR-5 CPA s59; EX-B Court-Day Script Controls.',
            chronology: 'Ref: SR-1 Chronology Pack; SR-2 Proudman v Dayman; SR-6 Charge Elements; EX-A to EX-E timeline exhibits.',
            harassment: 'Ref: SR-1 Conduct Narrative; EX-E Complaint and sequence logs.',
            matrix: 'Ref: SR-2 Proudman v Dayman; SR-5 CPA s59; SR-6 RSA 1986; EX-A, EX-D, EX-E.',
            legal: 'Ref: SR-2 Proudman v Dayman; SR-4 CTM v The Queen; SR-5 CPA s59; SR-6 RSA 1986.',
            files: 'Ref: Exhibit A Source Register through Exhibit E Diversion Pack checklist.',
            financial: 'Ref: SR-1 Financial chronology; EX-C/EX-D supporting hardship records.',
            court: 'Ref: SR-2 and SR-5 doctrinal anchors; EX-B hearing checklist; EX-E diversion package.',
            ai: 'Ref: SR-2 Proudman v Dayman; SR-5 CPA s59; SR-6 element/admissibility guardrails; EX-B script controls.'
        };

        function normalizeContextText(value) {
            return String(value || '')
                .replace(/\u00A0/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function showToast(type, message) {
            const stack = document.getElementById('toast-stack');
            if (!stack) return;
            const el = document.createElement('div');
            const safeType = ['info', 'success', 'warning', 'error'].includes(type) ? type : 'info';
            el.className = `toast-item ${safeType}`;
            el.textContent = message;
            stack.appendChild(el);
            window.setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(8px)';
                window.setTimeout(() => el.remove(), 220);
            }, 3600);
        }

        function setLastSynced(timestampMs) {
            const indicator = document.getElementById('last-synced-indicator');
            if (!indicator) return;
            if (!timestampMs) {
                indicator.textContent = 'Last Synced: Never';
                return;
            }
            const stamp = new Date(timestampMs).toLocaleString();
            indicator.textContent = `Last Synced: ${stamp}`;
        }

        function setSyncMode(mode = 'online', reason = '') {
            syncMode = mode === 'offline' ? 'offline' : 'online';
            const indicator = document.getElementById('sync-mode-indicator');
            if (!indicator) return;
            if (syncMode === 'offline') {
                indicator.textContent = `Sync Mode: Offline${reason ? ` (${reason})` : ''}`;
                indicator.classList.remove('text-slate-500');
                indicator.classList.add('text-amber-300');
            } else {
                indicator.textContent = 'Sync Mode: Online';
                indicator.classList.remove('text-amber-300');
                indicator.classList.add('text-slate-500');
            }
        }

        function renderCanonicalTimeline() {
            const host = document.getElementById('canonical-timeline-list');
            if (!host) return;
            host.innerHTML = '';
            CANONICAL_TIMELINE_EVENTS.forEach((eventItem) => {
                const wrapper = document.createElement('article');
                const severityClass = eventItem.severity === 'critical'
                    ? 'is-critical'
                    : eventItem.severity === 'hearing'
                        ? 'is-hearing'
                        : '';
                wrapper.className = `timeline-item ${severityClass}`;
                wrapper.innerHTML = `
                    <span class="timeline-dot" aria-hidden="true"></span>
                    <span class="font-mono text-[10px] text-executive-gold font-bold mb-1 block uppercase tracking-widest">${sanitize(eventItem.dateLabel)}</span>
                    <h4 class="font-bold text-white tracking-tight text-base">${sanitize(eventItem.title)}</h4>
                    <p class="text-xs text-slate-400 mt-1 leading-relaxed">${sanitize(eventItem.note)}</p>
                    <p class="timeline-source">Ref: ${sanitize(eventItem.sourceRefs.join('; '))}</p>
                `;
                host.appendChild(wrapper);
            });
        }

        function renderCanonicalTruthMatrix() {
            const tbody = document.getElementById('truth-matrix-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            CANONICAL_TRUTH_MATRIX_ROWS.forEach((row) => {
                const tr = document.createElement('tr');
                tr.className = 'group hover:bg-white/[0.02]';
                tr.innerHTML = `
                    <td class="px-4 md:px-6 py-4 text-slate-300">${sanitize(row.allegation)}</td>
                    <td class="px-4 md:px-6 py-4 text-slate-300">${sanitize(row.forensicReality)}</td>
                    <td class="px-4 md:px-6 py-4 text-slate-400">${sanitize(row.evidenceKey)}</td>
                    <td class="px-4 md:px-6 py-4"><span class="text-[10px] font-bold text-executive-gold uppercase tracking-widest">${sanitize(row.sourceRefs.join('; '))}</span></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function renderSourceRegisterFooters() {
            Object.entries(SECTION_SOURCE_REGISTER).forEach(([viewId, refText]) => {
                const panel = document.getElementById(`view-${viewId}`);
                if (!panel || panel.querySelector('.source-register-footer')) return;
                const footer = document.createElement('div');
                footer.className = 'source-register-footer mt-4';
                footer.innerHTML = `<p>${sanitize(refText)}</p>`;
                panel.appendChild(footer);
            });
        }

        // --- FILE UPLOAD LOGIC ---
        const dropZones = document.querySelectorAll('.drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZones.forEach(zone => {
            zone.addEventListener('click', () => fileInput.click());
            zone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    fileInput.click();
                }
            });

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
        });

        function handleFiles(files) {
            const lists = document.querySelectorAll('.file-list');
            Array.from(files).forEach(file => {
                uploadedFiles.push(file);
                const safeName = sanitize(file.name);

                lists.forEach(list => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100 text-xs";
                    div.innerHTML = `
                        <div class="flex items-center gap-2 truncate">
                            <i class="fa-solid fa-file text-slate-400"></i>
                            <span class="font-medium text-slate-700 truncate">${safeName}</span>
                        </div>
                        <span class="text-[10px] text-slate-400">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    `;
                    list.appendChild(div);
                });
            });

            // Add system message to analysis chat
            addDocMessage(`System: Successfully ingested ${files.length} new document(s) into local context.`, 'system');
        }

        // --- DOC ANALYSIS LOGIC ---
        function analyzeDocuments() {
            const input = document.getElementById('doc-query-input');
            const query = input.value.trim();
            if (!query) return;

            addDocMessage(query, 'user');
            input.value = '';

            // Simulate "Reading" files (Visual Feedback)
            const thinkingId = addDocMessage('Inspecting loaded files...', 'thinking');

            setTimeout(() => {
                document.getElementById(thinkingId).remove();
                // This connects to the main AI logic if key is present, otherwise mock response
                const apiKey = _deobs(sessionStorage.getItem('GEMINI_API_KEY'));

                if (apiKey) {
                    // Call real Gemini with file context context
                    const fileContext = uploadedFiles.map(f => `[File: ${f.name}]`).join(", ");
                    const context = `USER HAS UPLOADED THESE FILES: ${fileContext}. They are asking about them. ` + scrapeContext();
                    const promptGroupId = nextPromptGroupId();
                    window.learningTelemetry.promptGroups[promptGroupId] = {
                        userPrompt: query,
                        surface: 'doc_analysis',
                        regenerationCount: 0,
                    };

                    appendLearningEvent({
                        surface: 'doc_analysis',
                        role: 'user',
                        event_type: 'user_prompt',
                        message_id: `doc-user-${Date.now()}`,
                        prompt_group_id: promptGroupId,
                        text: query,
                    });

                    callGemini(apiKey, context, query, { surface: 'doc_analysis', promptGroupId }).then(response => {
                        addDocMessage(response, 'ai');
                        appendLearningEvent({
                            surface: 'doc_analysis',
                            role: 'assistant',
                            event_type: 'assistant_response',
                            message_id: `doc-ai-${Date.now()}`,
                            prompt_group_id: promptGroupId,
                            text: response,
                        });
                        flushLearningBuffer().catch((err) => console.warn('Doc analysis flush error', err));
                    }).catch(err => {
                        addDocMessage("Error analyzing documents: " + err.message, 'system');
                        appendLearningEvent({
                            surface: 'doc_analysis',
                            role: 'assistant',
                            event_type: 'assistant_error',
                            message_id: `doc-err-${Date.now()}`,
                            prompt_group_id: promptGroupId,
                            text: `Error analyzing documents: ${err.message}`,
                            meta: { error_code: 'doc_analysis_error' },
                        });
                    });
                } else {
                    // Mock response if no key
                    addDocMessage("**Analysis Result:** Based on the file metadata and your query, I recommend cross-referencing these documents with the Chronology Engine. Please save your API key to perform full text extraction and deep analysis.", 'ai');
                }
            }, 1500);
        }

        function addDocMessage(text, type) {
            const history = document.getElementById('doc-analysis-history');
            const id = 'doc-msg-' + Date.now();
            let html = '';

            if (type === 'user') {
                const clean = sanitize(text);
                html = `<div class="flex justify-end"><div class="bg-slate-200 text-slate-800 p-3 rounded-lg rounded-tr-none text-sm max-w-[80%]">${clean}</div></div>`;
            } else if (type === 'ai') {
                const formatted = formatAIResponse(text);
                html = `<div class="flex gap-3"><div class="w-6 h-6 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-robot text-legal-gold text-[10px]"></i></div><div class="bg-white border border-slate-200 p-3 rounded-lg rounded-tl-none text-sm max-w-[90%] shadow-sm">${formatted}</div></div>`;
            } else if (type === 'thinking') {
                html = `<div id="${id}" class="flex gap-3"><div class="w-6 h-6 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-robot text-legal-gold text-[10px] animate-pulse"></i></div><div class="text-xs text-slate-400 italic mt-2">Reading documents...</div></div>`;
            } else {
                const clean = sanitize(text);
                html = `<div class="text-center"><span class="text-[10px] text-slate-400 uppercase tracking-wide border-b border-slate-200 pb-1">${clean}</span></div>`;
            }

            history.insertAdjacentHTML('beforeend', html);
            history.scrollTop = history.scrollHeight;
            return id;
        }


        // --- GEMINI AI INTEGRATION (Main Chat + Learning Telemetry) ---
        const BASE_SYSTEM_PROMPT = `
Role: Senior Victorian Traffic Defence Counsel.
Client: Vikram Deshpande (Financial Executive).
Forum: Melbourne Magistrates' Court (Victoria).
Objective: avoid conviction where possible (diversion preferred). If not available, minimise penalty and seek no-conviction outcomes where legally open.
Hearing date: 23 February 2026.

Mandatory default strategy anchor:
${CORE_DEFENCE_CONTEXT}

You have access to the dashboard context. When answering:
1. Be concise, strategic, and authoritative.
2. Cite specific Victorian legislation (Road Safety Act 1986, Criminal Procedure Act 2009).
3. Use conditional, evidence-led wording and identify what must be proved by admissible records/certificates.
4. Avoid unsupported scientific or employment-impact overstatements.
`;

        const LEARNING_STORAGE_KEY = 'LEARNING_CHAT_BUFFER_V1';
        const LEARNING_CORRECTION_RE = /^(no|not quite|incorrect|wrong|i meant|you missed|try again|rephrase|format it as|do it this way|that is not what i asked)\b/i;
        let activeLearningRules = { version: 1, rules: [], prompt_snippet: '' };
        let lastDriveChatUploadCount = 0;

        function newUuid() {
            if (window.crypto && typeof window.crypto.randomUUID === 'function') return window.crypto.randomUUID();
            return `uuid-${Date.now()}-${Math.random().toString(16).slice(2)}`;
        }

        function initializeLearningTelemetry() {
            let parsed = null;
            const raw = localStorage.getItem(LEARNING_STORAGE_KEY);
            if (raw) {
                try {
                    parsed = JSON.parse(raw);
                } catch (err) {
                    console.warn('Could not parse saved learning telemetry buffer', err);
                }
            }

            const initial = parsed && typeof parsed === 'object' ? parsed : {};
            window.learningTelemetry = {
                sessionId: initial.sessionId || newUuid(),
                promptGroupCounter: Number.isFinite(initial.promptGroupCounter) ? initial.promptGroupCounter : 0,
                events: Array.isArray(initial.events) ? initial.events : [],
                promptGroups: initial.promptGroups && typeof initial.promptGroups === 'object' ? initial.promptGroups : {},
                lastAssistantBySurface: initial.lastAssistantBySurface && typeof initial.lastAssistantBySurface === 'object' ? initial.lastAssistantBySurface : {},
            };
            lastDriveChatUploadCount = window.learningTelemetry.events.length;
            persistLearningTelemetry();
        }

        function persistLearningTelemetry() {
            if (!window.learningTelemetry) return;
            localStorage.setItem(LEARNING_STORAGE_KEY, JSON.stringify(window.learningTelemetry));
        }

        function nextPromptGroupId() {
            if (!window.learningTelemetry) initializeLearningTelemetry();
            window.learningTelemetry.promptGroupCounter += 1;
            persistLearningTelemetry();
            const n = String(window.learningTelemetry.promptGroupCounter).padStart(3, '0');
            return `${window.learningTelemetry.sessionId}:g${n}`;
        }

        function buildSystemPrompt(basePrompt, rules) {
            const snippet = rules && typeof rules.prompt_snippet === 'string' ? rules.prompt_snippet.trim() : '';
            if (!snippet) return basePrompt;
            return `${basePrompt}\n\nRUNTIME LEARNING RULES (ACTIVE):\n${snippet}`;
        }

        async function loadActiveLearningRules() {
            try {
                const resp = await fetch(`./learning/rules/active_rules.json?ts=${Date.now()}`, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`active_rules.json HTTP ${resp.status}`);
                const parsed = await resp.json();
                if (parsed && typeof parsed === 'object') {
                    activeLearningRules = parsed;
                    return activeLearningRules;
                }
            } catch (err) {
                console.warn('Could not load active learning rules, using empty defaults', err);
            }
            activeLearningRules = { version: 1, rules: [], prompt_snippet: '' };
            return activeLearningRules;
        }

        function _lastAssistantWithinWindow(surface, nowTs, maxSeconds = 600) {
            const lookup = window.learningTelemetry?.lastAssistantBySurface?.[surface];
            if (!lookup) return null;
            const delta = nowTs - Date.parse(lookup.timestamp_utc || '');
            if (Number.isFinite(delta) && delta >= 0 && delta <= maxSeconds * 1000) return lookup;
            return null;
        }

        function appendLearningEvent(event) {
            if (!window.learningTelemetry) initializeLearningTelemetry();
            const nowIso = new Date().toISOString();
            const evt = {
                event_id: event.event_id || `dashboard_${newUuid()}`,
                session_id: event.session_id || window.learningTelemetry.sessionId,
                prompt_group_id: event.prompt_group_id || nextPromptGroupId(),
                timestamp_utc: event.timestamp_utc || nowIso,
                source: 'dashboard_chat',
                surface: event.surface || 'main_chat',
                event_type: event.event_type || 'user_prompt',
                role: event.role || 'user',
                message_id: event.message_id || `msg-${Date.now()}`,
                parent_message_id: event.parent_message_id || null,
                text: typeof event.text === 'string' ? event.text.trim() : '',
                feedback: event.feedback || null,
                meta: event.meta && typeof event.meta === 'object' ? event.meta : {},
            };

            if (evt.event_type === 'user_prompt' && LEARNING_CORRECTION_RE.test(evt.text || '')) {
                const lastAssistant = _lastAssistantWithinWindow(evt.surface, Date.parse(evt.timestamp_utc || nowIso), 600);
                if (lastAssistant) {
                    evt.event_type = 'user_correction';
                    evt.parent_message_id = lastAssistant.message_id || evt.parent_message_id;
                }
            }

            if (evt.event_type === 'assistant_response') {
                window.learningTelemetry.lastAssistantBySurface[evt.surface] = {
                    message_id: evt.message_id,
                    timestamp_utc: evt.timestamp_utc,
                    prompt_group_id: evt.prompt_group_id,
                };
            }

            window.learningTelemetry.events.push(evt);
            persistLearningTelemetry();
            return evt;
        }

        async function flushLearningBuffer() {
            persistLearningTelemetry();
            if (!accessToken) return;
            await saveChatLogsToDrive();
        }

        async function saveChatLogsToDrive() {
            if (!accessToken || !window.learningTelemetry) return;
            const events = window.learningTelemetry.events || [];
            if (!events.length) return;
            if (events.length === lastDriveChatUploadCount) return;

            const day = new Date().toISOString().slice(0, 10);
            const fileName = `dashboard_events_${day}_${window.learningTelemetry.sessionId}.jsonl`;
            const content = events.map((e) => JSON.stringify(e)).join('\n');
            await uploadFileToDriveByName(fileName, 'application/x-ndjson', content);
            lastDriveChatUploadCount = events.length;
            persistLearningTelemetry();
        }

        function handleFeedback(messageId, promptGroupId, feedback) {
            appendLearningEvent({
                surface: 'main_chat',
                role: 'user',
                event_type: 'feedback',
                message_id: `feedback-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`,
                parent_message_id: messageId,
                prompt_group_id: promptGroupId,
                feedback: feedback,
                text: '',
            });
            flushLearningBuffer().catch((err) => console.warn('Feedback flush error', err));
        }

        function handleRegenerate(messageId, promptGroupId, surface = 'main_chat') {
            appendLearningEvent({
                surface: surface,
                role: 'user',
                event_type: 'regeneration_request',
                message_id: `regen-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`,
                parent_message_id: messageId,
                prompt_group_id: promptGroupId,
                text: '',
            });
            const group = window.learningTelemetry?.promptGroups?.[promptGroupId];
            if (!group || !group.userPrompt) return;
            const regenCount = (group.regenerationCount || 0) + 1;
            group.regenerationCount = regenCount;
            sendMessage(group.userPrompt, false, surface, promptGroupId);
        }

        async function sendMessage(forcedPrompt = null, isSimulation = false, surface = 'main_chat', promptGroupId = null) {
            const input = document.getElementById('chat-input');
            const message = forcedPrompt || input.value.trim();
            if (!message) return;
            if (!window.learningTelemetry) initializeLearningTelemetry();

            const groupId = promptGroupId || nextPromptGroupId();
            if (!window.learningTelemetry.promptGroups[groupId]) {
                window.learningTelemetry.promptGroups[groupId] = {
                    userPrompt: message,
                    surface: surface,
                    regenerationCount: 0,
                };
            } else {
                window.learningTelemetry.promptGroups[groupId].userPrompt = message;
            }

            // Only add user message to chat if it's a normal chat, not a simulation/action
            let userMessageId = `usr-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`;
            if (!isSimulation && !forcedPrompt) {
                userMessageId = addMessage(message, 'user', { promptGroupId: groupId, surface: surface });
                input.value = '';
            } else if (forcedPrompt && !isSimulation) {
                userMessageId = addMessage(message, 'user', { promptGroupId: groupId, surface: surface }); // Show prompt in chat for actions like "Analyze"
            }

            appendLearningEvent({
                surface: surface,
                role: 'user',
                event_type: 'user_prompt',
                message_id: userMessageId,
                prompt_group_id: groupId,
                text: message,
            });

            const apiKey = _deobs(sessionStorage.getItem('GEMINI_API_KEY'));
            if (!apiKey) {
                if (isSimulation) {
                    document.getElementById('magistrate-feedback').innerText = "Error: Please enter your API Key in the AI Co-Counsel tab.";
                } else {
                    addMessage("Error: Please enter and save your Gemini API Key in the top right corner.", 'system');
                }
                appendLearningEvent({
                    surface: surface,
                    role: 'assistant',
                    event_type: 'assistant_error',
                    message_id: `err-${Date.now()}`,
                    parent_message_id: userMessageId,
                    prompt_group_id: groupId,
                    text: 'Missing API key',
                    meta: { error_code: 'missing_api_key' },
                });
                return;
            }

            let thinkingId;
            if (!isSimulation) {
                thinkingId = addMessage('Analyzing case files...', 'ai-thinking');
            } else {
                document.getElementById('magistrate-feedback').innerHTML = `<div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> Consulting Magistrate Persona...</div>`;
            }

            try {
                const context = scrapeContext();
                const response = await callGemini(apiKey, context, message, { surface: surface, promptGroupId: groupId });

                if (isSimulation) {
                    // Update the magistrate feedback box specifically
                    document.getElementById('magistrate-feedback').innerHTML = formatAIResponse(response);
                    appendLearningEvent({
                        surface: surface,
                        role: 'assistant',
                        event_type: 'assistant_response',
                        message_id: `sim-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`,
                        parent_message_id: userMessageId,
                        prompt_group_id: groupId,
                        text: response,
                    });
                } else {
                    document.getElementById(thinkingId).remove();
                    const aiMessageId = addMessage(response, 'ai', {
                        promptGroupId: groupId,
                        surface: surface,
                        parentMessageId: userMessageId,
                    });
                    appendLearningEvent({
                        surface: surface,
                        role: 'assistant',
                        event_type: 'assistant_response',
                        message_id: aiMessageId,
                        parent_message_id: userMessageId,
                        prompt_group_id: groupId,
                        text: response,
                    });
                }

            } catch (error) {
                if (isSimulation) {
                    document.getElementById('magistrate-feedback').innerText = "Simulation Error: " + error.message;
                } else {
                    document.getElementById(thinkingId).remove();
                    addMessage(`Error: ${error.message}`, 'system');
                }
                appendLearningEvent({
                    surface: surface,
                    role: 'assistant',
                    event_type: 'assistant_error',
                    message_id: `err-${Date.now()}-${Math.random().toString(16).slice(2, 8)}`,
                    parent_message_id: userMessageId,
                    prompt_group_id: groupId,
                    text: `Error: ${error.message}`,
                    meta: { error_code: 'gemini_request_failed' },
                });
            }
            flushLearningBuffer().catch((err) => console.warn('Learning flush error', err));
        }

        function triggerAIAction(action) {
            let prompt = "";
            let isSimulation = false;
            let surface = 'main_chat';

            switch (action) {
                case 'analyze-strength':
                    switchView('ai');
                    prompt = "Audit the dashboard strategy against the nine-section defence report. List the top 3 evidence gaps, the immediate corrective actions, and the best resolution path order (diversion, negotiation, fallback plea).";
                    break;
                case 'draft-complaint':
                    switchView('ai');
                    prompt = "Draft a diversion package checklist tailored to this matter: cover letter, chronology, accountability statement, counselling/education proof, references, and objective employment-impact letter.";
                    break;
                case 'simulate-cross':
                    switchView('ai');
                    prompt = "Simulate one difficult prosecution question on proof and admissibility for each charge (s30, s49(1)(h), s49(1)(bb)), then provide concise evidence-led answers.";
                    break;
                case 'refine-script':
                    switchView('ai');
                    const currentScript = document.getElementById('courtScript').value;
                    prompt = `Refine this hearing script for evidence-led clarity and procedural precision. Keep it concise, respectful, and aligned to diversion/adjournment/fallback pathways:\n\n"${currentScript}"`;
                    break;
                case 'simulate-magistrate':
                    isSimulation = true;
                    surface = 'magistrate_sim';
                    const scriptText = document.getElementById('courtScript').value;
                    prompt = `Act as a Victorian Magistrate reviewing this submission: "${scriptText}". Provide 2 likely interruptions/questions and a preliminary indication on diversion, adjournment, and fallback sentencing posture. Output as HTML.`;
                    break;
                case 'inspect':
                    isSimulation = false;
                    const inspector = document.getElementById('ai-inspector');
                    inspector.classList.remove('hidden');
                    const activeDoc = document.querySelector('.doc-sheet:not(.hidden)');
                    const docTitle = activeDoc ? activeDoc.querySelector('h1')?.innerText || 'Active Exhibit' : 'Selected Exhibit';
                    prompt = `Perform a forensic inspection of this document: "${docTitle}". Identify element-proof relevance, admissibility value, and any gaps. Provide concise bullet findings suitable for an AI Inspector panel.`;
                    break;
            }
            if (prompt) sendMessage(prompt, isSimulation, surface);
        }

        function addMessage(text, type, meta = {}) {
            const history = document.getElementById('chat-history');
            const id = 'msg-' + Date.now();
            const promptGroupId = meta.promptGroupId || '';
            const surface = meta.surface || 'main_chat';
            const parentMessageId = meta.parentMessageId || '';

            let html = '';
            if (type === 'user') {
                const clean = sanitize(text);
                html = `<div class="flex gap-4 flex-row-reverse" id="${id}" data-message-role="user" data-prompt-group-id="${promptGroupId}"><div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-user text-slate-500 text-xs"></i></div><div class="bg-legal-navy text-white p-4 rounded-lg rounded-tr-none shadow-md max-w-[80%]"><p class="text-sm leading-relaxed">${clean}</p></div></div>`;
            } else if (type === 'ai') {
                const formatted = formatAIResponse(text);
                html = `<div class="flex gap-4" id="${id}" data-message-role="assistant" data-prompt-group-id="${promptGroupId}" data-parent-message-id="${parentMessageId}"><div class="w-8 h-8 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-scale-balanced text-legal-gold text-xs"></i></div><div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm border border-slate-200 max-w-[80%]"><p class="text-sm text-slate-700 leading-relaxed">${formatted}</p><div class="mt-3 flex items-center gap-2"><button type="button" class="px-2 py-1 rounded bg-slate-100 text-slate-700 text-[11px] hover:bg-slate-200" onclick="handleFeedback('${id}', '${promptGroupId}', 'like')">Like</button><button type="button" class="px-2 py-1 rounded bg-slate-100 text-slate-700 text-[11px] hover:bg-slate-200" onclick="handleFeedback('${id}', '${promptGroupId}', 'dislike')">Dislike</button><button type="button" class="px-2 py-1 rounded bg-slate-100 text-slate-700 text-[11px] hover:bg-slate-200" onclick="handleRegenerate('${id}', '${promptGroupId}', '${surface}')">Regenerate</button></div></div></div>`;
            } else if (type === 'ai-thinking') {
                html = `<div class="flex gap-4" id="${id}"><div class="w-8 h-8 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-robot text-legal-gold text-xs animate-pulse"></i></div><div class="bg-transparent p-4 max-w-[80%] flex items-center gap-2 thinking-dots"><div class="w-2 h-2 bg-slate-400 rounded-full"></div><div class="w-2 h-2 bg-slate-400 rounded-full"></div><div class="w-2 h-2 bg-slate-400 rounded-full"></div></div></div>`;
            } else {
                html = `<div class="flex justify-center my-4" id="${id}"><span class="bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full font-bold">${text}</span></div>`;
            }

            history.insertAdjacentHTML('beforeend', html);
            history.scrollTop = history.scrollHeight;
            return id;
        }

        async function callGemini(apiKey, context, userPrompt, opts = {}) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            // Add Drive context if available
            let driveContextText = "";
            if (window.driveFilesContext && window.driveFilesContext.length > 0) {
                driveContextText = "\n\nFILES IN GOOGLE DRIVE (Case_Files):\n" +
                    window.driveFilesContext.map(f => `- ${f.name} (ID: ${f.id}, Modified: ${f.modifiedTime})`).join("\n");
            }
            const systemPrompt = buildSystemPrompt(BASE_SYSTEM_PROMPT, activeLearningRules);

            const payload = {
                contents: [{
                    parts: [{
                        text: `${systemPrompt}\n\nCURRENT DASHBOARD CONTEXT:\n${context}${driveContextText}\n\nSURFACE:\n${opts.surface || 'main_chat'}\n\nUSER QUESTION:\n${userPrompt}`
                    }]
                }]
            };

            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errData = await response.json(); throw new Error(errData.error?.message || 'Gemini API request failed'); }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function scrapeContext() {
            let context = '';
            const views = ['dashboard', 'intervention', 'chronology', 'harassment', 'matrix', 'financial', 'files', 'legal', 'court'];
            views.forEach((view) => {
                const el = document.getElementById(`view-${view}`);
                if (!el) return;
                const text = normalizeContextText(el.textContent || '').slice(0, 6500);
                if (text) context += `\n--- VIEW: ${view.toUpperCase()} ---\n${text}`;
            });
            const hiddenContext = normalizeContextText(document.getElementById('strategy-context-hidden')?.textContent || '');
            if (hiddenContext) {
                context += `\n--- CORE DEFENCE CONTEXT ---\n${hiddenContext}`;
            }
            return context;
        }

        async function saveKeys() {
            const geminiKey = document.getElementById('gemini-api-key').value;
            const clientId = document.getElementById('google-client-id').value;
            const oldClientId = localStorage.getItem('GOOGLE_CLIENT_ID');

            if (geminiKey) sessionStorage.setItem('GEMINI_API_KEY', _obs(geminiKey));
            if (clientId) localStorage.setItem('GOOGLE_CLIENT_ID', clientId); // Client ID is usually not sensitive enough for XOR but we keep it plaintext for simplicity or obfuscate if requested. Requirements say "API Key Storage" specifically.

            alert('Configuration Saved (API Key stored for this session only)');

            // Re-init token client if client ID changed and it's valid
            if (clientId && clientId !== oldClientId && clientId.includes('.apps.googleusercontent.com')) {
                initTokenClient();
            }

            // Sync to Drive if connected
            if (accessToken) {
                try {
                    await uploadConfigToDrive(geminiKey, clientId);
                } catch (err) {
                    console.error('Config Sync Fail:', err);
                    alert('Error syncing config to Drive: ' + err.message);
                }
            }
        }

        async function uploadConfigToDrive(geminiKey, clientId) {
            updateSyncStatus('Uploading Config...');
            const config = {
                GEMINI_API_KEY: geminiKey,
                GOOGLE_CLIENT_ID: clientId,
                lastUpdated: new Date().toISOString()
            };

            // Find existing api_keys.json
            const search = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'api_keys.json' and trashed = false`,
                fields: 'files(id)',
            });

            if (search.result.files.length > 0) {
                const fileId = search.result.files[0].id;
                const patchResp = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                if (!patchResp.ok) throw new Error(`Upload Config Error: ${patchResp.status}`);
            } else {
                // Create new
                const fileMetadata = {
                    name: 'api_keys.json',
                    mimeType: 'application/json',
                    parents: [DRIVE_FOLDER_ID]
                };
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(fileMetadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(config) +
                    close_delim;

                const postResp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'multipart/related; boundary=' + boundary },
                    body: multipartRequestBody
                });
                if (!postResp.ok) throw new Error(`Create Config Error: ${postResp.status}`);
            }
            updateSyncStatus('Config Synced', 'bg-emerald-500');
        }

        function handleChatInput(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }

        window.addEventListener('beforeunload', () => {
            persistLearningTelemetry();
        });

        // --- Chart Logic (Section 8.2 Visual Prioritisation) ---
        function renderToxChart() {
            if (!window.Chart) return;
            const barCanvas = document.getElementById('toxChart');
            const scatterCanvas = document.getElementById('impactChart');
            if (!barCanvas || !scatterCanvas) return;

            const barCtx = barCanvas.getContext('2d');
            const scatterCtx = scatterCanvas.getContext('2d');

            if (toxChartInstance) toxChartInstance.destroy();
            if (impactChartInstance) impactChartInstance.destroy();

            toxChartInstance = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: [
                        'Parallel complaint/FOI (mitigation leverage)',
                        'Sentencing submission for no conviction (if plea)',
                        'Technical challenge to drug evidence (chain/analysis)',
                        'Negotiate withdrawal/streamlining of counts',
                        'Diversion application (CPA diversion)',
                        'Obtain VicRoads status proof (20 Sep 2025)',
                        'Secure complete brief and disclosures'
                    ],
                    datasets: [{
                        label: 'Indicative probability (%)',
                        data: [25, 30, 15, 55, 45, 20, 65],
                        backgroundColor: 'rgba(31, 119, 179, 0.9)',
                        borderColor: 'rgba(31, 119, 179, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            ticks: {
                                callback: (value) => `${value}%`,
                                color: '#94a3b8',
                                font: { size: 9 }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.15)' }
                        },
                        y: {
                            ticks: { color: '#cbd5e1', font: { size: 9 } },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw}%`
                            }
                        }
                    }
                }
            });

            impactChartInstance = new Chart(scatterCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Impact vs probability',
                        data: [
                            { x: 15, y: 5 },
                            { x: 20, y: 5 },
                            { x: 25, y: 3 },
                            { x: 30, y: 4 },
                            { x: 45, y: 5 },
                            { x: 55, y: 4 },
                            { x: 65, y: 4 }
                        ],
                        backgroundColor: 'rgba(31, 119, 179, 0.9)',
                        borderColor: 'rgba(31, 119, 179, 1)',
                        pointRadius: 5,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            min: 0,
                            max: 100,
                            title: {
                                display: true,
                                text: 'Estimated probability of advancing target outcome',
                                color: '#94a3b8',
                                font: { size: 9 }
                            },
                            ticks: {
                                callback: (value) => `${value}%`,
                                color: '#94a3b8',
                                font: { size: 9 }
                            },
                            grid: { color: 'rgba(148, 163, 184, 0.15)' }
                        },
                        y: {
                            min: 1,
                            max: 5,
                            title: {
                                display: true,
                                text: 'Impact on target outcome (ordinal)',
                                color: '#94a3b8',
                                font: { size: 9 }
                            },
                            ticks: { stepSize: 1, color: '#94a3b8', font: { size: 9 } },
                            grid: { color: 'rgba(148, 163, 184, 0.15)' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // --- View Logic ---
        function switchView(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById(`btn-${viewId}`);
            if (btn) btn.classList.add('active');

            document.querySelectorAll('.view-panel').forEach(el => el.classList.add('hidden'));
            const panel = document.getElementById(`view-${viewId}`);
            if (panel) panel.classList.remove('hidden');

            // Dynamic Header Update
            const viewTitles = {
                'dashboard': 'Case Snapshot',
                'intervention': 'Immediate Protocol',
                'chronology': 'Forensic Timeline',
                'harassment': 'Forensic Audit',
                'matrix': 'Truth Matrix',
                'legal': 'Legal Framework',
                'files': 'Evidence Vault',
                'financial': 'Evidence Action Plan',
                'court': 'Court Operations',
                'ai': 'AI Co-Counsel'
            };
            const pageTitle = document.getElementById('page-title');
            if (pageTitle && viewTitles[viewId]) {
                pageTitle.innerText = viewTitles[viewId];
            }

            if (viewId === 'legal') setTimeout(renderToxChart, 100);
            if (window.innerWidth < 1024) toggleSidebar(false);
        }

        // --- Document Viewer Logic ---
        function showDoc(docId, evt) {
            document.querySelectorAll('.doc-sheet').forEach(el => el.classList.add('hidden'));
            const doc = document.getElementById(`doc-${docId}`);
            if (doc) doc.classList.remove('hidden');

            document.querySelectorAll('.doc-btn').forEach(el => {
                el.classList.remove('active-doc-btn');
                el.classList.add('opacity-60');
            });

            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active-doc-btn');
                evt.currentTarget.classList.remove('opacity-60');
            }
        }

        function toggleSidebar(forceOpen = null) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            const toggleButton = document.getElementById('sidebar-toggle');
            const isOpen = !sidebar.classList.contains('-translate-x-full');
            const shouldOpen = typeof forceOpen === 'boolean' ? forceOpen : !isOpen;

            if (shouldOpen) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden', 'opacity-0');
                overlay.classList.add('opacity-100');
                if (toggleButton) toggleButton.setAttribute('aria-expanded', 'true');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('opacity-100');
                overlay.classList.add('opacity-0');
                if (toggleButton) toggleButton.setAttribute('aria-expanded', 'false');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        window.addEventListener('load', () => {
            initializeLearningTelemetry();
            const savedGeminiKey = _deobs(sessionStorage.getItem('GEMINI_API_KEY'));
            const savedClientId = localStorage.getItem('GOOGLE_CLIENT_ID');

            if (savedGeminiKey) document.getElementById('gemini-api-key').value = savedGeminiKey;

            const clientIdInput = document.getElementById('google-client-id');
            if (savedClientId) {
                clientIdInput.value = savedClientId;
            }

            // Restore local state
            const localState = localStorage.getItem('DASHBOARD_LOCAL_STATE');
            if (localState) {
                try {
                    const parsed = JSON.parse(localState);
                    if (parsed.courtScript) document.getElementById('courtScript').value = parsed.courtScript;
                    const indicator = document.getElementById('court-save-indicator');
                    if (indicator) {
                        indicator.textContent = 'Restored';
                        indicator.classList.add('text-emerald-400');
                    }
                } catch (e) { console.error('Error restoring local state', e); }
            }

            renderCanonicalTimeline();
            renderCanonicalTruthMatrix();
            renderSourceRegisterFooters();
            setSyncMode('online');
            setLastSynced(null);
            applyAriaLabels();
            if (window.gapi && typeof gapi.load === 'function') {
                gapi.load('client', initGapiClient);
            } else {
                setSyncMode('offline', 'GAPI Missing');
                updateSyncStatus('Offline Mode', 'bg-amber-500');
                showToast('warning', 'Google API library not available. Running in Offline Mode.');
            }
            loadActiveLearningRules().catch((err) => console.warn('Rule load error', err));
        });

        window.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && window.innerWidth < 1024) {
                toggleSidebar(false);
            }
        });

        // --- GOOGLE DRIVE SYNC ENGINE ---
        const DRIVE_FOLDER_ID = '1hWKlM5c3EbB5jgAA5Xi_V6rFD3nKQUZS';
        let tokenClient;
        let accessToken = null;
        let lastSyncTime = null;
        window.driveFilesContext = [];

        async function initGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                setSyncMode('online');
                updateSyncStatus('Ready', 'bg-slate-500');
                initTokenClient();
                checkStoredToken();
            } catch (e) {
                console.error('GAPI Init Error:', e);
                setSyncMode('offline', 'GAPI');
                updateSyncStatus('Offline Mode', 'bg-amber-500');
                showToast('warning', 'Google Drive sync unavailable. Running in Offline Mode.');
            }
        }

        function initTokenClient() {
            const clientId = localStorage.getItem('GOOGLE_CLIENT_ID');
            if (!clientId) return;

            if (!window.google || !google.accounts || !google.accounts.oauth2 || typeof google.accounts.oauth2.initTokenClient !== 'function') {
                setSyncMode('offline', 'GIS Missing');
                updateSyncStatus('Offline Mode', 'bg-amber-500');
                showToast('warning', 'Google Identity Services unavailable. Running in Offline Mode.');
                return;
            }

            if (!clientId.includes('.apps.googleusercontent.com')) {
                console.warn("Potential Invalid Client ID: Ensure you use the full OAuth Client ID, not just the project number.");
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly',
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        console.error('Auth Error:', tokenResponse);
                        setSyncMode('offline', 'Auth');
                        updateSyncStatus('Offline Mode', 'bg-amber-500');
                        showToast('error', `Drive auth error: ${tokenResponse.error}`);
                        if (tokenResponse.error === 'access_denied') {
                            alert("Access Denied: Please ensure 'sarkar.vikram@gmail.com' is added as a 'Test User' in your Google Cloud Console OAuth Consent Screen.");
                        }
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    // Set token for GAPI client
                    gapi.client.setToken({ access_token: accessToken });

                    // Persist token securely (SessionStorage for access token)
                    const expiresAt = Date.now() + (tokenResponse.expires_in * 1000);
                    sessionStorage.setItem('GOOGLE_ACCESS_TOKEN', _obs(accessToken));
                    sessionStorage.setItem('GOOGLE_TOKEN_EXPIRES', expiresAt);

                    setSyncMode('online');
                    document.getElementById('btn-auth').innerText = 'Drive Connected';
                    document.getElementById('btn-auth').classList.replace('bg-blue-600', 'bg-emerald-600');
                    startSyncLoop();
                },
                error_callback: (err) => {
                    console.error('GIS Error:', err);
                    setSyncMode('offline', 'Auth');
                    updateSyncStatus('Offline Mode', 'bg-amber-500');
                    showToast('error', 'Drive authentication failed. Offline Mode enabled.');
                }
            });
        }

        function handleAuthClick() {
            if (!tokenClient) {
                alert("Please enter a Google Client ID in the AI Co-Counsel configuration first.");
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function checkStoredToken() {
            const storedToken = _deobs(sessionStorage.getItem('GOOGLE_ACCESS_TOKEN'));
            const expiresAt = sessionStorage.getItem('GOOGLE_TOKEN_EXPIRES');

            if (storedToken && expiresAt && Date.now() < parseInt(expiresAt)) {
                accessToken = storedToken;
                // Set token for GAPI client
                gapi.client.setToken({ access_token: accessToken });

                setSyncMode('online');
                document.getElementById('btn-auth').innerText = 'Drive Connected';
                document.getElementById('btn-auth').classList.replace('bg-blue-600', 'bg-emerald-600');
                startSyncLoop();
            }
        }

        function updateSyncStatus(status, colorClass = 'bg-emerald-500') {
            const indicator = document.getElementById('sync-indicator');
            const statusText = document.getElementById('sync-text');
            if (!indicator || !statusText) return;
            indicator.className = `w-2 h-2 rounded-full animate-pulse ${colorClass}`;
            statusText.innerText = status;
        }

        let isSyncing = false;

        async function startSyncLoop() {
            if (syncIntervalId) return;
            updateSyncStatus('Syncing...');
            await runSync();
            syncIntervalId = setInterval(runSync, 20000);
        }

        function resolveStateConflict(localState, remoteState) {
            const localStamp = Date.parse(localState?.timestamp || localState?.lastModified || '');
            const remoteStamp = Date.parse(remoteState?.timestamp || remoteState?.lastModified || remoteState?._driveModifiedTime || '');
            const localHasData = Boolean(localState && normalizeContextText(localState.courtScript || localState.notes || ''));
            const remoteHasData = Boolean(remoteState && normalizeContextText(remoteState.courtScript || remoteState.notes || ''));

            if (localHasData && !remoteHasData) {
                return { source: 'local', state: localState, shouldUpload: true };
            }
            if (!localHasData && remoteHasData) {
                return { source: 'drive', state: remoteState, shouldUpload: false };
            }
            if (!localHasData && !remoteHasData) {
                return { source: 'none', state: null, shouldUpload: false };
            }

            if (!Number.isFinite(localStamp) && Number.isFinite(remoteStamp)) {
                return { source: 'drive', state: remoteState, shouldUpload: false };
            }
            if (!Number.isFinite(remoteStamp) && Number.isFinite(localStamp)) {
                return { source: 'local', state: localState, shouldUpload: true };
            }
            if (Number.isFinite(localStamp) && Number.isFinite(remoteStamp)) {
                return localStamp >= remoteStamp
                    ? { source: 'local', state: localState, shouldUpload: localStamp > remoteStamp }
                    : { source: 'drive', state: remoteState, shouldUpload: false };
            }
            return { source: 'local', state: localState, shouldUpload: true };
        }

        function applyDashboardState(state) {
            if (!state) return;
            if (typeof state.courtScript === 'string') {
                const scriptEl = document.getElementById('courtScript');
                if (scriptEl) scriptEl.value = state.courtScript;
            }
            const normalized = {
                courtScript: typeof state.courtScript === 'string' ? state.courtScript : document.getElementById('courtScript')?.value || '',
                timestamp: state.timestamp || state.lastModified || new Date().toISOString(),
                notes: state.notes || 'Auto-saved from browser sync engine.'
            };
            localStorage.setItem('DASHBOARD_LOCAL_STATE', JSON.stringify(normalized));
            const indicator = document.getElementById('court-save-indicator');
            if (indicator) {
                indicator.textContent = `Synced ${new Date(normalized.timestamp).toLocaleTimeString()}`;
                indicator.classList.remove('text-slate-500');
                indicator.classList.add('text-emerald-400');
            }
        }

        async function syncDashboardStateLWW() {
            const localRaw = localStorage.getItem('DASHBOARD_LOCAL_STATE');
            let localState = null;
            if (localRaw) {
                try {
                    localState = JSON.parse(localRaw);
                } catch (err) {
                    console.warn('Invalid local dashboard state JSON', err);
                }
            }

            const remoteState = await fetchStateFromDrive();
            const decision = resolveStateConflict(localState, remoteState);

            if (decision.source === 'drive' && decision.state) {
                applyDashboardState(decision.state);
            }

            if (decision.source === 'local' && decision.state && decision.shouldUpload) {
                await saveStateToDrive({
                    courtScript: decision.state.courtScript || document.getElementById('courtScript')?.value || '',
                    timestamp: decision.state.timestamp || decision.state.lastModified || new Date().toISOString(),
                    notes: decision.state.notes || 'Auto-saved from browser sync engine.'
                });
            }
        }

        function classifySyncError(err) {
            const status = Number(err?.status)
                || Number(err?.result?.error?.code)
                || Number(err?.code)
                || 0;
            const message = normalizeContextText(err?.message || err?.result?.error?.message || '');
            const isQuota = /quota|rate limit|userRateLimitExceeded|quotaExceeded|daily limit/i.test(message);
            const isCredentialIssue = /invalid credentials|invalid api key|api key not valid|unauthorized|permission denied|auth/i.test(message);
            return { status, message, isQuota, isCredentialIssue };
        }

        async function runSync() {
            if (!accessToken || isSyncing) return;
            isSyncing = true;
            try {
                setSyncMode('online');
                updateSyncStatus('Syncing...');

                // 1. Fetch Config (API Keys)
                await fetchConfigFromDrive();

                // 1b. Refresh active learning rules used for runtime prompt injection
                await loadActiveLearningRules();

                // 2. Last-Write-Wins state sync
                await syncDashboardStateLWW();

                // 3. Index Files (Context Sync)
                await indexDriveFiles();

                // 4. Persist chat telemetry events
                await saveChatLogsToDrive();

                // 5. Sync workspace snapshots
                await syncWorkspaceFiles();

                // 6. Check self update
                await checkSelfUpdate();

                updateSyncStatus('Synced', 'bg-emerald-500');
                lastSyncTime = Date.now();
                setLastSynced(lastSyncTime);

            } catch (err) {
                const { status, message, isQuota, isCredentialIssue } = classifySyncError(err);
                if (status === 401) {
                    console.warn('Sync auth token expired; switching to Offline Mode.', err);
                    accessToken = null;
                    sessionStorage.removeItem('GOOGLE_ACCESS_TOKEN');
                    sessionStorage.removeItem('GOOGLE_TOKEN_EXPIRES');
                    setSyncMode('offline', 'Auth');
                    updateSyncStatus('Auth Expired', 'bg-red-500');
                    document.getElementById('btn-auth').innerText = 'Connect Drive';
                    document.getElementById('btn-auth').classList.replace('bg-emerald-600', 'bg-blue-600');
                    showToast('warning', 'Drive token expired. Switched to Offline Mode.');
                    return;
                }
                if (status === 400 && isCredentialIssue) {
                    console.warn('Sync credentials invalid; switching to Offline Mode.', err);
                    setSyncMode('offline', 'Credentials');
                    updateSyncStatus('Offline Mode', 'bg-amber-500');
                    showToast('warning', 'Invalid API credentials detected. Continuing in Offline Mode.');
                    return;
                }
                if (status === 403 || isQuota) {
                    console.warn('Sync quota/API limit reached; switching to Offline Mode.', err);
                    setSyncMode('offline', 'Quota/API');
                    updateSyncStatus('Offline Mode', 'bg-amber-500');
                    showToast('warning', 'Drive quota/API limit hit. Continuing in Offline Mode.');
                    return;
                }
                console.error('Sync Error:', err);
                updateSyncStatus('Sync Error', 'bg-red-500');
                showToast('error', `Sync error: ${message || 'Unknown error'}`);
            } finally {
                isSyncing = false;
            }
        }

        async function uploadFileToDriveByName(fileName, mimeType, content) {
            const search = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = '${fileName}' and trashed = false`,
                fields: 'files(id)',
            });

            const fileMetadata = {
                name: fileName,
                mimeType: mimeType,
                parents: [DRIVE_FOLDER_ID]
            };

            const url = search.result.files.length > 0
                ? `https://www.googleapis.com/upload/drive/v3/files/${search.result.files[0].id}?uploadType=media`
                : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

            if (search.result.files.length > 0) {
                // UPDATE (PATCH)
                const resp = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': mimeType },
                    body: typeof content === 'string' ? content : JSON.stringify(content)
                });
                if (!resp.ok) throw new Error(`Upload ${fileName} Error: ${resp.status}`);
            } else {
                // CREATE (MULTIPART POST)
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                const body = delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(fileMetadata) +
                    delimiter +
                    `Content-Type: ${mimeType}\r\n\r\n` +
                    (typeof content === 'string' ? content : JSON.stringify(content)) +
                    close_delim;

                const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'multipart/related; boundary=' + boundary },
                    body: body
                });
                if (!resp.ok) throw new Error(`Create ${fileName} Error: ${resp.status}`);
            }
        }

        async function syncWorkspaceFiles() {
            const filesToSync = [
                { name: 'legal_strategy_dashboard.html', mime: 'text/html' },
                { name: 'index.html', mime: 'text/html' },
                { name: 'manifest.json', mime: 'application/json' },
                { name: 'sw.js', mime: 'application/javascript' }
            ];

            for (const file of filesToSync) {
                try {
                    const resp = await fetch(file.name);
                    if (resp.ok) {
                        const content = await resp.text();
                        await uploadFileToDriveByName(file.name, file.mime, content);
                        console.log(`Successfully synced: ${file.name}`);
                    }
                } catch (e) {
                    console.warn(`Could not sync ${file.name}:`, e);
                }
            }
        }

        async function fetchConfigFromDrive() {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'api_keys.json' and trashed = false`,
                fields: 'files(id, name)',
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                const fileId = files[0].id;
                const contentResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!contentResponse.ok) throw new Error(`Fetch Config Error: ${contentResponse.status}`);
                const keys = await contentResponse.json();
                if (keys.GEMINI_API_KEY) {
                    sessionStorage.setItem('GEMINI_API_KEY', _obs(keys.GEMINI_API_KEY));
                    document.getElementById('gemini-api-key').value = keys.GEMINI_API_KEY;
                }
                if (keys.GOOGLE_CLIENT_ID) {
                    const localClientId = localStorage.getItem('GOOGLE_CLIENT_ID');
                    if (keys.GOOGLE_CLIENT_ID !== localClientId) {
                        localStorage.setItem('GOOGLE_CLIENT_ID', keys.GOOGLE_CLIENT_ID);
                        document.getElementById('google-client-id').value = keys.GOOGLE_CLIENT_ID;
                        // Client ID changed from cloud, re-init client logic if needed
                        initTokenClient();
                    }
                }
            }
        }

        async function fetchStateFromDrive() {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'dashboard_state.json' and trashed = false`,
                fields: 'files(id, modifiedTime)',
            });
            const files = response.result.files || [];
            if (!files.length) return null;

            const fileId = files[0].id;
            const modifiedTime = files[0].modifiedTime;
            const contentResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!contentResponse.ok) throw new Error(`Fetch State Error: ${contentResponse.status}`);
            const state = await contentResponse.json();
            return {
                ...state,
                _driveFileId: fileId,
                _driveModifiedTime: modifiedTime
            };
        }

        async function checkSelfUpdate() {
            if (!Number.isFinite(lastSyncTime)) return;
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'legal_strategy_dashboard.html' and trashed = false`,
                fields: 'files(id, name, modifiedTime)',
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                const driveTime = new Date(files[0].modifiedTime).getTime();
                if (driveTime > lastSyncTime + 5000) { // 5s grace period
                    if (confirm("A newer version of the dashboard is available on Google Drive. Reload now?")) {
                        window.location.reload();
                    }
                }
            }
        }

        async function indexDriveFiles() {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and trashed = false`,
                fields: 'files(id, name, mimeType, modifiedTime)',
            });
            window.driveFilesContext = response.result.files;

            // Update UI list if we are in Case Files view
            const lists = document.querySelectorAll('.file-list');
            // We only prepend/update to avoid clearing local uploads if any
            const driveFiles = window.driveFilesContext.filter(f => f.name !== 'legal_strategy_dashboard.html' && f.name !== 'api_keys.json' && f.name !== 'dashboard_state.json');

            // Simple logic to show drive files in the list if not already there
            driveFiles.forEach(file => {
                const existing = document.querySelector(`[data-drive-id="${file.id}"]`);
                if (!existing) {
                    const safeName = sanitize(file.name);
                    lists.forEach(list => {
                        const div = document.createElement('div');
                        div.setAttribute('data-drive-id', file.id);
                        div.className = "flex items-center justify-between p-2 bg-blue-50/50 rounded border border-blue-100 text-xs";
                        div.innerHTML = `
                            <div class="flex items-center gap-2 truncate">
                                <i class="fa-brands fa-google-drive text-blue-500"></i>
                                <span class="font-medium text-slate-700 truncate">${safeName}</span>
                            </div>
                            <span class="text-[9px] text-blue-400 uppercase font-bold">Cloud</span>
                        `;
                        list.prepend(div);
                    });
                }
            });
        }

        // --- STATE PERSISTENCE ---
        let debounceTimer;
        function debounceSaveState() {
            clearTimeout(debounceTimer);
            const indicator = document.getElementById('court-save-indicator');
            if (indicator) {
                indicator.textContent = 'Saving...';
                indicator.classList.remove('text-emerald-400');
                indicator.classList.add('text-slate-500');
            }
            debounceTimer = setTimeout(() => {
                const nowIso = new Date().toISOString();
                const state = {
                    courtScript: document.getElementById('courtScript').value,
                    timestamp: nowIso,
                    lastModified: nowIso,
                    notes: "Auto-saved from browser sync engine."
                };
                localStorage.setItem('DASHBOARD_LOCAL_STATE', JSON.stringify(state));
                if (indicator) {
                    indicator.textContent = `Saved ${new Date().toLocaleTimeString()}`;
                    indicator.classList.remove('text-slate-500');
                    indicator.classList.add('text-emerald-400');
                }
                console.log('Local state autosaved');
            }, 500);
        }

        async function saveStateToDrive(nextState = null) {
            const nowIso = new Date().toISOString();
            const state = {
                lastModified: nextState?.lastModified || nextState?.timestamp || nowIso,
                timestamp: nextState?.timestamp || nextState?.lastModified || nowIso,
                courtScript: typeof nextState?.courtScript === 'string'
                    ? nextState.courtScript
                    : document.getElementById('courtScript').value,
                notes: nextState?.notes || "Auto-saved from browser sync engine."
            };

            // Find or create dashboard_state.json
            const search = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'dashboard_state.json' and trashed = false`,
                fields: 'files(id)',
            });

            if (search.result.files.length > 0) {
                const fileId = search.result.files[0].id;
                const patchResp = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(state)
                });
                if (!patchResp.ok) throw new Error(`Save State Error: ${patchResp.status}`);
            } else {
                await uploadFileToDriveByName('dashboard_state.json', 'application/json', state);
            }
            localStorage.setItem('DASHBOARD_LOCAL_STATE', JSON.stringify(state));
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Registration Fail', err));
            });
        }

        // Install Prompt Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('install-button');
            if (installBtn) installBtn.classList.remove('hidden');
        });

        document.getElementById('install-button')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-button').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // --- PDF Export Logic ---
        async function exportDashboardToPDF(evt) {
            const btn = evt?.currentTarget
                || document.getElementById('export-strategy-btn')
                || document.querySelector('button[onclick*="exportDashboardToPDF"]');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Generating Strategy Report...';
                btn.disabled = true;
            }

            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error('PDF engine unavailable. Please refresh and try again.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                const PAGE_W = 210;
                const PAGE_H = 297;
                const ML = 25;
                const MR = 185;
                const MT = 30;
                const MB = 270;
                const CONTENT_W = MR - ML;
                const MM_PER_PT = 0.352778;

                const COLORS = {
                    navy: [15, 23, 42],
                    gold: [212, 175, 55],
                    slate: [51, 65, 85],
                    slateSoft: [71, 85, 105],
                    watermark: [208, 214, 224],
                    headerFill: [235, 240, 246],
                    rowFill: [252, 253, 255],
                    rowFillAlt: [246, 249, 253],
                    border: [197, 207, 220],
                    cardFill: [242, 246, 250],
                    cardStroke: [204, 213, 225],
                    calloutFill: [245, 247, 250],
                    calloutStroke: [194, 204, 218],
                    accentFill: [252, 248, 236],
                    accentStroke: [212, 175, 55],
                    alertFill: [254, 242, 242],
                    alertStroke: [239, 68, 68]
                };

                const STYLES = {
                    coverTitle: { font: 'times', style: 'bold', size: 23, color: COLORS.navy, lineHeight: 1.14 },
                    coverSubtitle: { font: 'helvetica', style: 'bold', size: 10.8, color: COLORS.gold, lineHeight: 1.2 },
                    docTitle: { font: 'times', style: 'bold', size: 13.8, color: COLORS.navy, lineHeight: 1.2 },
                    sectionHeader: { font: 'times', style: 'bold', size: 12.8, color: COLORS.navy, lineHeight: 1.2 },
                    subHeader: { font: 'helvetica', style: 'bold', size: 9.6, color: COLORS.navy, lineHeight: 1.22 },
                    body: { font: 'helvetica', style: 'normal', size: 8.9, color: COLORS.slate, lineHeight: 1.32 },
                    tableHeader: { font: 'helvetica', style: 'bold', size: 8, color: COLORS.navy, lineHeight: 1.2 },
                    tableBody: { font: 'helvetica', style: 'normal', size: 7.7, color: COLORS.slate, lineHeight: 1.27 },
                    kpiLabel: { font: 'helvetica', style: 'bold', size: 7.3, color: COLORS.slateSoft, lineHeight: 1.2 },
                    kpiValue: { font: 'times', style: 'bold', size: 11.1, color: COLORS.navy, lineHeight: 1.14 },
                    kpiBody: { font: 'helvetica', style: 'normal', size: 7.4, color: COLORS.slate, lineHeight: 1.25 },
                    callout: { font: 'helvetica', style: 'normal', size: 8.25, color: COLORS.slate, lineHeight: 1.24 },
                    footer: { font: 'helvetica', style: 'normal', size: 7.1, color: COLORS.slateSoft, lineHeight: 1.1 }
                };

                const exportDate = new Date();
                const exportDateLabel = exportDate.toLocaleDateString('en-AU', {
                    day: '2-digit',
                    month: 'long',
                    year: 'numeric'
                });
                const filenameDate = exportDate.toISOString().split('T')[0];
                const fallbackLine = 'Data unavailable at export time.';
                const continuationQueue = [];
                const renderedCorpus = [];

                let y = MT;
                let started = false;
                let currentSection = 'Executive Brief';
                const pageMeta = [];
                let apraSectionRendered = false;

                const normalizeLine = (value) => normalizeContextText(value || '');
                const normalizeMultiline = (value) => String(value || '')
                    .replace(/\r/g, '')
                    .split('\n')
                    .map((line) => normalizeContextText(line))
                    .join('\n')
                    .trim();

                function trackRendered(value) {
                    if (value == null) return;
                    if (Array.isArray(value)) {
                        value.forEach((entry) => trackRendered(entry));
                        return;
                    }
                    const normalized = normalizeLine(value);
                    if (normalized) renderedCorpus.push(normalized);
                }

                function queueContinuation(sectionName, title, render) {
                    continuationQueue.push({ sectionName, title, render });
                }

                function applyTextStyle(styleKey) {
                    const style = STYLES[styleKey] || STYLES.body;
                    doc.setFont(style.font, style.style);
                    doc.setFontSize(style.size);
                    doc.setTextColor(...style.color);
                    return style;
                }

                function getLineHeightMm(styleKey, lineHeightFactor = null) {
                    const style = STYLES[styleKey] || STYLES.body;
                    const factor = lineHeightFactor || style.lineHeight || 1.3;
                    return style.size * MM_PER_PT * factor;
                }

                function splitTextExact(text, width, styleKey) {
                    applyTextStyle(styleKey);
                    const safeText = normalizeLine(text) || ' ';
                    const safeWidth = Math.max(8, (Number(width) || CONTENT_W) - 1.2);
                    return doc.splitTextToSize(safeText, safeWidth);
                }

                function measureTextBlock(text, width, styleKey, lineHeightFactor = null, paddingTop = 0, paddingBottom = 0) {
                    const lines = splitTextExact(text, width, styleKey);
                    const lineHeightMm = getLineHeightMm(styleKey, lineHeightFactor);
                    const lineCount = Math.max(1, lines.length);
                    return {
                        lines: lines.length ? lines : [' '],
                        lineHeightMm,
                        height: paddingTop + paddingBottom + (lineCount * lineHeightMm)
                    };
                }

                function drawWatermark() {
                    const wmText = 'PRIVILEGED & CONFIDENTIAL';
                    trackRendered(wmText);

                    doc.setFont('times', 'bold');
                    doc.setFontSize(24);
                    if (typeof doc.GState === 'function' && typeof doc.setGState === 'function') {
                        doc.setGState(new doc.GState({ opacity: 0.12 }));
                        doc.setTextColor(...COLORS.watermark);
                        doc.text(wmText, PAGE_W / 2, PAGE_H / 2, {
                            align: 'center',
                            baseline: 'middle',
                            angle: 45
                        });
                        doc.setGState(new doc.GState({ opacity: 1 }));
                    } else {
                        doc.setTextColor(225, 230, 238);
                        doc.text(wmText, PAGE_W / 2, PAGE_H / 2, {
                            align: 'center',
                            baseline: 'middle',
                            angle: 45
                        });
                    }
                }

                function drawHeaderChrome(sectionLabel) {
                    doc.setDrawColor(...COLORS.gold);
                    doc.setLineWidth(0.45);
                    doc.line(ML, 15, MR, 15);

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(7.8);
                    doc.setTextColor(...COLORS.slate);
                    doc.text('PRIVILEGED & CONFIDENTIAL', ML, 8.2, { baseline: 'top' });
                    doc.text(exportDateLabel, MR, 8.2, { align: 'right', baseline: 'top' });
                    trackRendered(['PRIVILEGED', 'CONFIDENTIAL', sectionLabel]);

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(7.2);
                    doc.setTextColor(...COLORS.navy);
                    doc.text('EXECUTIVE LEGAL BRIEF', MR, 18.2, { align: 'right', baseline: 'top' });

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7.2);
                    doc.setTextColor(...COLORS.slateSoft);
                    doc.text(sectionLabel, ML, 18.2, { baseline: 'top' });
                }

                function drawFooterChrome(sectionLabel, pageNo = null, totalPages = null, clearTextZone = false) {
                    if (clearTextZone) {
                        doc.setFillColor(255, 255, 255);
                        doc.rect(ML, 284, MR - ML, 7.6, 'F');
                    }

                    doc.setDrawColor(...COLORS.gold);
                    doc.setLineWidth(0.45);
                    doc.line(ML, 282, MR, 282);

                    applyTextStyle('footer');
                    doc.text('Police v Deshpande | Executive Defence Strategy', ML, 284.6, { baseline: 'top' });
                    doc.text(sectionLabel, PAGE_W / 2, 284.6, { align: 'center', baseline: 'top' });

                    const pageLabel = (pageNo && totalPages)
                        ? `Page ${pageNo} of ${totalPages}`
                        : 'Page';
                    doc.text(pageLabel, MR, 284.6, { align: 'right', baseline: 'top' });
                }

                function addBrandedPage(sectionName, continuation = false) {
                    if (started) {
                        doc.addPage();
                    } else {
                        started = true;
                    }
                    currentSection = sectionName;
                    const sectionLabel = continuation ? `${sectionName} (Cont.)` : sectionName;
                    pageMeta.push({ section: sectionName, continuation, label: sectionLabel });

                    drawWatermark();
                    drawHeaderChrome(sectionLabel);
                    drawFooterChrome(sectionLabel);
                    y = MT;
                }

                function checkPageBreak(requiredHeight, keepWithNextHeight = 0) {
                    const safeHeight = Math.max(0, requiredHeight || 0);
                    const safeKeep = Math.max(0, keepWithNextHeight || 0);
                    if (y + safeHeight + safeKeep > MB) {
                        addBrandedPage(currentSection, true);
                    }
                }

                function drawCenteredText(text, styleKey, centerY, maxWidth = CONTENT_W, lineHeightFactor = null) {
                    const block = measureTextBlock(text, maxWidth, styleKey, lineHeightFactor);
                    applyTextStyle(styleKey);
                    const style = STYLES[styleKey] || STYLES.body;
                    doc.text(block.lines, PAGE_W / 2, centerY, {
                        align: 'center',
                        baseline: 'top',
                        lineHeightFactor: lineHeightFactor || style.lineHeight
                    });
                    trackRendered(block.lines);
                    return block.height;
                }

                function drawSectionHeader(title, subtitle = '') {
                    const titleBlock = measureTextBlock(title, CONTENT_W, 'sectionHeader');
                    const subtitleBlock = subtitle
                        ? measureTextBlock(subtitle, CONTENT_W, 'subHeader')
                        : { lines: [], height: 0 };
                    const needed = titleBlock.height + (subtitle ? subtitleBlock.height + 4 : 2.6) + 2.2;
                    checkPageBreak(needed, 4.2);

                    applyTextStyle('sectionHeader');
                    doc.text(titleBlock.lines, ML, y, {
                        baseline: 'top',
                        lineHeightFactor: STYLES.sectionHeader.lineHeight
                    });
                    trackRendered(titleBlock.lines);
                    y += titleBlock.height + 1.2;

                    doc.setDrawColor(...COLORS.gold);
                    doc.setLineWidth(0.35);
                    doc.line(ML, y, MR, y);
                    y += 1.6;

                    if (subtitle) {
                        applyTextStyle('subHeader');
                        doc.text(subtitleBlock.lines, ML, y, {
                            baseline: 'top',
                            lineHeightFactor: STYLES.subHeader.lineHeight
                        });
                        trackRendered(subtitleBlock.lines);
                        y += subtitleBlock.height + 1.8;
                    } else {
                        y += 1.4;
                    }
                }

                function drawSubHeader(text, keepWithNextHeight = 0) {
                    const block = measureTextBlock(text, CONTENT_W, 'subHeader');
                    checkPageBreak(block.height + 1.3, keepWithNextHeight);
                    applyTextStyle('subHeader');
                    doc.text(block.lines, ML, y, {
                        baseline: 'top',
                        lineHeightFactor: STYLES.subHeader.lineHeight
                    });
                    trackRendered(block.lines);
                    y += block.height + 1.3;
                }

                function drawWrappedParagraph(text, options = {}) {
                    const {
                        styleKey = 'body',
                        x = ML,
                        width = CONTENT_W,
                        afterGap = 1.9,
                        lineHeightFactor = null,
                        preserveLineBreaks = false
                    } = options;

                    const raw = preserveLineBreaks ? String(text || '').replace(/\r/g, '') : normalizeLine(text || '');
                    if (!raw) return;

                    const paragraphs = preserveLineBreaks ? raw.split('\n') : [raw];
                    paragraphs.forEach((paragraph, idx) => {
                        const normalizedParagraph = preserveLineBreaks ? normalizeLine(paragraph) : paragraph;
                        if (!normalizedParagraph) {
                            y += getLineHeightMm(styleKey, lineHeightFactor) * 0.6;
                            return;
                        }
                        const block = measureTextBlock(normalizedParagraph, width, styleKey, lineHeightFactor);
                        checkPageBreak(block.height + (idx === paragraphs.length - 1 ? afterGap : 0));
                        applyTextStyle(styleKey);
                        const style = STYLES[styleKey] || STYLES.body;
                        doc.text(block.lines, x, y, {
                            baseline: 'top',
                            lineHeightFactor: lineHeightFactor || style.lineHeight
                        });
                        trackRendered(block.lines);
                        y += block.height + (idx === paragraphs.length - 1 ? afterGap : 1.1);
                    });
                }

                function drawBulletedList(items, options = {}) {
                    const {
                        styleKey = 'body',
                        x = ML,
                        width = CONTENT_W,
                        indent = 4,
                        gap = 1.3
                    } = options;

                    const cleaned = (items || []).map((item) => normalizeLine(item)).filter(Boolean);
                    cleaned.forEach((item) => {
                        const block = measureTextBlock(item, width - indent, styleKey);
                        checkPageBreak(block.height + gap);
                        applyTextStyle(styleKey);
                        const style = STYLES[styleKey] || STYLES.body;
                        doc.text('-', x, y, { baseline: 'top' });
                        doc.text(block.lines, x + indent, y, {
                            baseline: 'top',
                            lineHeightFactor: style.lineHeight
                        });
                        trackRendered(block.lines);
                        y += block.height + gap;
                    });
                }

                function drawCallout(text, options = {}) {
                    const {
                        styleKey = 'callout',
                        x = ML,
                        width = CONTENT_W,
                        paddingX = 2.1,
                        paddingY = 1.9,
                        afterGap = 2.2,
                        tone = 'neutral',
                        preserveLineBreaks = false
                    } = options;

                    const raw = preserveLineBreaks ? String(text || '').replace(/\r/g, '') : normalizeLine(text || '');
                    if (!raw) return;

                    const paragraphs = preserveLineBreaks ? raw.split('\n') : [raw];
                    const lines = [];
                    paragraphs.forEach((paragraph, index) => {
                        const normalizedParagraph = normalizeLine(paragraph);
                        if (!normalizedParagraph) {
                            if (index < paragraphs.length - 1) lines.push(' ');
                            return;
                        }
                        const chunk = splitTextExact(normalizedParagraph, width - (2 * paddingX), styleKey);
                        lines.push(...chunk);
                        if (index < paragraphs.length - 1) lines.push(' ');
                    });

                    const effectiveLines = lines.length ? lines : [' '];
                    const lineHeight = getLineHeightMm(styleKey);
                    let cursor = 0;

                    while (cursor < effectiveLines.length) {
                        const minimumHeight = (2 * paddingY) + lineHeight;
                        if (y + minimumHeight > MB) {
                            addBrandedPage(currentSection, true);
                        }

                        const availableLines = Math.floor((MB - y - (2 * paddingY)) / lineHeight);
                        if (availableLines < 1) {
                            addBrandedPage(currentSection, true);
                            continue;
                        }

                        const linesThisChunk = Math.min(availableLines, effectiveLines.length - cursor);
                        const chunk = effectiveLines.slice(cursor, cursor + linesThisChunk);
                        const boxHeight = (linesThisChunk * lineHeight) + (2 * paddingY);
                        checkPageBreak(boxHeight);

                        let fillColor = COLORS.calloutFill;
                        let strokeColor = COLORS.calloutStroke;
                        if (tone === 'accent') {
                            fillColor = COLORS.accentFill;
                            strokeColor = COLORS.accentStroke;
                        }
                        if (tone === 'alert') {
                            fillColor = COLORS.alertFill;
                            strokeColor = COLORS.alertStroke;
                        }

                        doc.setFillColor(...fillColor);
                        doc.setDrawColor(...strokeColor);
                        doc.setLineWidth(0.3);
                        doc.roundedRect(x, y, width, boxHeight, 1.8, 1.8, 'FD');

                        applyTextStyle(styleKey);
                        const style = STYLES[styleKey] || STYLES.body;
                        doc.text(chunk, x + paddingX, y + paddingY, {
                            baseline: 'top',
                            lineHeightFactor: style.lineHeight
                        });
                        trackRendered(chunk);

                        y += boxHeight + afterGap;
                        cursor += linesThisChunk;

                        if (cursor < effectiveLines.length) {
                            addBrandedPage(currentSection, true);
                        }
                    }
                }

                function drawKpiCards(cards, options = {}) {
                    const { columns = 2, gap = 4, afterGap = 2.6 } = options;
                    const cleaned = (cards || []).filter((card) => card && (card.label || card.value || card.detail));
                    if (!cleaned.length) return;

                    const cardPaddingX = 2.2;
                    const cardPaddingY = 2.1;
                    const columnWidth = columns === 2
                        ? ((CONTENT_W - gap) / 2)
                        : CONTENT_W;

                    function prepareCard(card, cardWidth) {
                        const labelText = normalizeLine(card.label || fallbackLine);
                        const valueText = normalizeLine(card.value || fallbackLine);
                        const detailText = normalizeLine(card.detail || '');

                        const label = measureTextBlock(labelText, cardWidth - (2 * cardPaddingX), 'kpiLabel');
                        const value = measureTextBlock(valueText, cardWidth - (2 * cardPaddingX), 'kpiValue');
                        const detail = detailText
                            ? measureTextBlock(detailText, cardWidth - (2 * cardPaddingX), 'kpiBody')
                            : { lines: [], height: 0 };

                        return {
                            label,
                            value,
                            detail,
                            totalHeight: label.height + value.height + detail.height + (2 * cardPaddingY) + 2.2
                        };
                    }

                    function drawCard(prepared, xPos, yPos, cardWidth, cardHeight) {
                        doc.setFillColor(...COLORS.cardFill);
                        doc.setDrawColor(...COLORS.cardStroke);
                        doc.setLineWidth(0.25);
                        doc.roundedRect(xPos, yPos, cardWidth, cardHeight, 1.8, 1.8, 'FD');

                        let textY = yPos + cardPaddingY;
                        applyTextStyle('kpiLabel');
                        doc.text(prepared.label.lines, xPos + cardPaddingX, textY, {
                            baseline: 'top',
                            lineHeightFactor: STYLES.kpiLabel.lineHeight
                        });
                        trackRendered(prepared.label.lines);
                        textY += prepared.label.height + 0.8;

                        applyTextStyle('kpiValue');
                        doc.text(prepared.value.lines, xPos + cardPaddingX, textY, {
                            baseline: 'top',
                            lineHeightFactor: STYLES.kpiValue.lineHeight
                        });
                        trackRendered(prepared.value.lines);
                        textY += prepared.value.height + 0.9;

                        if (prepared.detail.lines.length) {
                            applyTextStyle('kpiBody');
                            doc.text(prepared.detail.lines, xPos + cardPaddingX, textY, {
                                baseline: 'top',
                                lineHeightFactor: STYLES.kpiBody.lineHeight
                            });
                            trackRendered(prepared.detail.lines);
                        }
                    }

                    for (let i = 0; i < cleaned.length; i += columns) {
                        const rowCards = cleaned.slice(i, i + columns);
                        const preparedCards = rowCards.map((card) => prepareCard(card, columnWidth));
                        const rowHeight = Math.max(...preparedCards.map((card) => card.totalHeight));
                        checkPageBreak(rowHeight + afterGap);
                        preparedCards.forEach((preparedCard, index) => {
                            const xPos = ML + (index * (columnWidth + gap));
                            drawCard(preparedCard, xPos, y, columnWidth, rowHeight);
                        });
                        y += rowHeight + afterGap;
                    }
                }

                function drawTableGrid(config) {
                    const { columns, rows, x = ML, width = CONTENT_W, afterGap = 2.4 } = config;
                    if (!Array.isArray(columns) || !columns.length) return;

                    const safeRows = (rows || []).length ? rows : [{ [columns[0].key || 'col0']: fallbackLine }];
                    const fractions = columns.map((column) => Number(column.width) || 1);
                    const fractionTotal = fractions.reduce((sum, value) => sum + value, 0) || columns.length;
                    const colWidths = fractions.map((fraction) => (width * fraction) / fractionTotal);

                    const cellPaddingX = 1.4;
                    const cellPaddingY = 1.25;
                    const headLineHeight = getLineHeightMm('tableHeader');
                    const rowLineHeight = getLineHeightMm('tableBody');
                    const minRowHeight = rowLineHeight + (2 * cellPaddingY);

                    const headerCells = columns.map((column, index) => {
                        const label = normalizeLine(column.label || column.key || 'Column');
                        const lines = splitTextExact(label, colWidths[index] - (2 * cellPaddingX), 'tableHeader');
                        return lines.length ? lines : [' '];
                    });
                    const headerHeight = (Math.max(...headerCells.map((lines) => lines.length)) * headLineHeight) + (2 * cellPaddingY);

                    function drawHeaderRow() {
                        checkPageBreak(headerHeight + minRowHeight);
                        doc.setFillColor(...COLORS.headerFill);
                        doc.setDrawColor(...COLORS.border);
                        doc.setLineWidth(0.25);
                        doc.rect(x, y, width, headerHeight, 'FD');

                        let cursorX = x;
                        columns.forEach((column, index) => {
                            if (index > 0) doc.line(cursorX, y, cursorX, y + headerHeight);
                            applyTextStyle('tableHeader');
                            doc.text(headerCells[index], cursorX + cellPaddingX, y + cellPaddingY, {
                                baseline: 'top',
                                lineHeightFactor: STYLES.tableHeader.lineHeight
                            });
                            trackRendered(headerCells[index]);
                            cursorX += colWidths[index];
                        });
                        doc.line(x + width, y, x + width, y + headerHeight);
                        y += headerHeight;
                    }

                    drawHeaderRow();

                    safeRows.forEach((row, rowIndex) => {
                        const cellLines = columns.map((column, columnIndex) => {
                            const key = column.key || String(columnIndex);
                            const rawValue = Array.isArray(row) ? row[columnIndex] : row[key];
                            const value = normalizeLine(rawValue || ' ');
                            const lines = splitTextExact(value, colWidths[columnIndex] - (2 * cellPaddingX), 'tableBody');
                            return lines.length ? lines : [' '];
                        });

                        const offsets = new Array(columns.length).fill(0);
                        const hasRemaining = () => offsets.some((offset, idx) => offset < cellLines[idx].length);

                        while (hasRemaining()) {
                            if (y + minRowHeight > MB) {
                                addBrandedPage(currentSection, true);
                                drawHeaderRow();
                            }

                            const availableLines = Math.floor((MB - y - (2 * cellPaddingY)) / rowLineHeight);
                            if (availableLines < 1) {
                                addBrandedPage(currentSection, true);
                                drawHeaderRow();
                                continue;
                            }

                            const remainingMax = Math.max(...cellLines.map((lines, idx) => lines.length - offsets[idx]));
                            const linesThisChunk = Math.max(1, Math.min(availableLines, remainingMax));
                            const rowHeight = (linesThisChunk * rowLineHeight) + (2 * cellPaddingY);

                            if (y + rowHeight > MB) {
                                addBrandedPage(currentSection, true);
                                drawHeaderRow();
                                continue;
                            }

                            const fill = rowIndex % 2 === 0 ? COLORS.rowFill : COLORS.rowFillAlt;
                            doc.setFillColor(...fill);
                            doc.setDrawColor(...COLORS.border);
                            doc.setLineWidth(0.22);
                            doc.rect(x, y, width, rowHeight, 'FD');

                            let cursorX = x;
                            columns.forEach((column, columnIndex) => {
                                if (columnIndex > 0) doc.line(cursorX, y, cursorX, y + rowHeight);

                                const remaining = cellLines[columnIndex].length - offsets[columnIndex];
                                const chunkLength = Math.max(0, Math.min(linesThisChunk, remaining));
                                const chunk = cellLines[columnIndex].slice(offsets[columnIndex], offsets[columnIndex] + chunkLength);
                                offsets[columnIndex] += chunkLength;

                                if (chunk.length) {
                                    applyTextStyle('tableBody');
                                    doc.text(chunk, cursorX + cellPaddingX, y + cellPaddingY, {
                                        baseline: 'top',
                                        lineHeightFactor: STYLES.tableBody.lineHeight
                                    });
                                    trackRendered(chunk);
                                }
                                cursorX += colWidths[columnIndex];
                            });

                            doc.line(x + width, y, x + width, y + rowHeight);
                            y += rowHeight;
                        }
                    });

                    y += afterGap;
                }

                function extractDashboardData() {
                    const root = document.getElementById('view-dashboard');
                    const summaryRoot = document.getElementById('ai-global-summary');
                    const summaryParagraphs = Array.from(summaryRoot?.querySelectorAll('p') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const priorities = Array.from(summaryRoot?.querySelectorAll('ul li span:last-child') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const kpiGrid = Array.from(root?.querySelectorAll('div.grid') || [])
                        .find((grid) => grid.children.length >= 4 && grid.querySelector('h4'));

                    const cards = Array.from(kpiGrid?.children || [])
                        .map((card) => {
                            const paragraphs = Array.from(card.querySelectorAll('p'));
                            const label = normalizeLine(paragraphs[0]?.textContent || 'Indicator');
                            const value = normalizeLine(card.querySelector('h4')?.textContent || '');
                            const detail = normalizeLine(paragraphs.slice(1).map((el) => el.textContent).join(' '));
                            return { label, value, detail };
                        })
                        .filter((card) => card.value || card.detail);

                    const hasProbability = cards.some((card) => /probability|likelihood|chance/i.test(`${card.label} ${card.value}`));
                    if (!hasProbability) {
                        cards.push({
                            label: 'Probability Indicator',
                            value: 'Evidence-Gated',
                            detail: 'No numeric probability is present in the live dashboard. Outcome remains contingent on certificates, admissibility, and brief completeness.'
                        });
                    }

                    const hasConduct = cards.some((card) => /harassment|conduct|intercept/i.test(`${card.label} ${card.value}`));
                    if (!hasConduct) {
                        const interceptCount = Array.isArray(CANONICAL_TIMELINE_EVENTS)
                            ? CANONICAL_TIMELINE_EVENTS.filter((eventItem) => /intercept|stop/i.test(`${eventItem.dateLabel} ${eventItem.title}`)).length
                            : 0;
                        cards.push({
                            label: 'Harassment / Conduct Index',
                            value: `${interceptCount || 0} intercept events`,
                            detail: 'Derived from live chronology context for conduct-pattern review.'
                        });
                    }

                    return {
                        purpose: summaryParagraphs[0] || fallbackLine,
                        status: summaryParagraphs[1] || fallbackLine,
                        priorities: priorities.length ? priorities : ['Maintain evidence-led submissions and avoid unsupported claims.'],
                        cards: cards.slice(0, 8)
                    };
                }

                function extractInterventionData() {
                    const root = document.getElementById('view-intervention');
                    const allLines = Array.from(root?.querySelectorAll('h4, p, div') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const script = allLines.find((line) => /officer, i will comply/i.test(line))
                        || 'Officer, I will comply with lawful directions, including name/address and testing obligations. I do not wish to answer broader questions without legal advice.';
                    const correctiveRule = allLines.find((line) => /strip any claim/i.test(line))
                        || 'Strip any claim that cannot be proved by a dated record or admissible certificate.';
                    const conditional = allLines.find((line) => /if the evidence shows x/i.test(line))
                        || 'If the evidence shows X, then the defence position is Y.';

                    const statusGrid = Array.from(root?.querySelectorAll('div.grid') || [])
                        .find((grid) => grid.children.length >= 3 && grid.querySelector('h4'));
                    const statusCards = Array.from(statusGrid?.children || [])
                        .map((card) => {
                            const heading = normalizeLine(card.querySelector('h4')?.textContent || 'Status Item');
                            const paragraphs = Array.from(card.querySelectorAll('p'));
                            const value = normalizeLine(paragraphs[0]?.textContent || fallbackLine);
                            const detail = normalizeLine(paragraphs.slice(1).map((el) => el.textContent).join(' '));
                            return {
                                label: heading,
                                value,
                                detail: detail || 'Operational context from intervention panel.'
                            };
                        })
                        .filter((card) => card.value || card.detail);

                    return {
                        script,
                        correctiveRule,
                        conditional,
                        statusCards: statusCards.length
                            ? statusCards
                            : [{ label: 'Operational Status', value: 'Intervention Panel Available', detail: fallbackLine }]
                    };
                }

                function extractTimelineRows() {
                    const domRows = Array.from(document.querySelectorAll('#canonical-timeline-list article'))
                        .map((article) => {
                            const date = normalizeLine(article.querySelector('span')?.textContent || '');
                            const incident = normalizeLine(article.querySelector('h4')?.textContent || '');
                            const noteParagraphs = Array.from(article.querySelectorAll('p'));
                            const note = normalizeLine(noteParagraphs[0]?.textContent || '');
                            const source = normalizeLine(article.querySelector('.timeline-source')?.textContent || '');
                            return {
                                date,
                                incident,
                                strategicWeight: [note, source].filter(Boolean).join(' | ')
                            };
                        })
                        .filter((row) => row.date || row.incident || row.strategicWeight);

                    if (domRows.length) return domRows;
                    if (Array.isArray(CANONICAL_TIMELINE_EVENTS) && CANONICAL_TIMELINE_EVENTS.length) {
                        return CANONICAL_TIMELINE_EVENTS.map((eventItem) => ({
                            date: normalizeLine(eventItem.dateLabel || ''),
                            incident: normalizeLine(eventItem.title || ''),
                            strategicWeight: normalizeLine(`${eventItem.note || ''} Ref: ${(eventItem.sourceRefs || []).join('; ')}`)
                        }));
                    }

                    return [{ date: 'Timeline', incident: 'No chronology entries detected', strategicWeight: fallbackLine }];
                }

                function extractMatrixRows() {
                    const domRows = Array.from(document.querySelectorAll('#truth-matrix-body tr'))
                        .map((row) => {
                            const cells = Array.from(row.querySelectorAll('td')).map((cell) => normalizeLine(cell.textContent));
                            return {
                                allegation: cells[0] || '',
                                reality: cells[1] || '',
                                evidence: cells[2] || '',
                                source: cells[3] || ''
                            };
                        })
                        .filter((row) => row.allegation || row.reality || row.evidence || row.source);

                    if (domRows.length) return domRows;
                    if (Array.isArray(CANONICAL_TRUTH_MATRIX_ROWS) && CANONICAL_TRUTH_MATRIX_ROWS.length) {
                        return CANONICAL_TRUTH_MATRIX_ROWS.map((row) => ({
                            allegation: normalizeLine(row.allegation || ''),
                            reality: normalizeLine(row.forensicReality || ''),
                            evidence: normalizeLine(row.evidenceKey || ''),
                            source: normalizeLine((row.sourceRefs || []).join('; '))
                        }));
                    }

                    return [{ allegation: 'Truth matrix unavailable', reality: fallbackLine, evidence: fallbackLine, source: fallbackLine }];
                }

                function extractPscData() {
                    const root = document.getElementById('view-harassment');
                    const paragraphs = Array.from(root?.querySelectorAll('p') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);
                    const summary = paragraphs.find((line) => /single source of truth|forensic audit/i.test(line))
                        || paragraphs[0]
                        || fallbackLine;

                    const strengthPanelHeading = Array.from(root?.querySelectorAll('h3') || [])
                        .find((node) => /what the dashboard does well/i.test(normalizeLine(node.textContent)));
                    const strengthPanel = strengthPanelHeading?.closest('.glass-panel');
                    const strengths = Array.from(strengthPanel?.querySelectorAll('p') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const correctivePanelHeading = Array.from(root?.querySelectorAll('h3') || [])
                        .find((node) => /immediate corrective action/i.test(normalizeLine(node.textContent)));
                    const correctivePanel = correctivePanelHeading?.closest('.glass-panel');
                    const corrective = Array.from(correctivePanel?.querySelectorAll('p') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const riskRows = Array.from(root?.querySelectorAll('table tbody tr') || [])
                        .map((row) => {
                            const cells = Array.from(row.querySelectorAll('td')).map((cell) => normalizeLine(cell.textContent));
                            return {
                                issue: cells[0] || '',
                                why: cells[1] || '',
                                likelihood: cells[2] || '',
                                impact: cells[3] || ''
                            };
                        })
                        .filter((row) => row.issue || row.why || row.likelihood || row.impact);

                    return {
                        summary,
                        strengths: strengths.length ? strengths : [
                            'Centralises key case artefacts into a single narrative surface.',
                            'Maps doctrine and evidence dependencies in one operational view.'
                        ],
                        corrective: corrective.length ? corrective : [
                            'Apply a provability filter to remove unsupported assertions.',
                            'Use conditional submissions tied to documentary proof.'
                        ],
                        riskRows: riskRows.length ? riskRows : [{
                            issue: 'Evidence hygiene and admissibility drift',
                            why: 'Narrative quality degrades when claims are not anchored to dated records and certificates.',
                            likelihood: 'Medium',
                            impact: 'High'
                        }]
                    };
                }

                function extractLegalData() {
                    const root = document.getElementById('view-legal');
                    const doctrineCards = Array.from(root?.querySelectorAll('.group') || [])
                        .map((card) => {
                            const title = normalizeLine(card.querySelector('h5')?.textContent || '');
                            const paragraphs = Array.from(card.querySelectorAll('p'))
                                .map((node) => normalizeLine(node.textContent))
                                .filter(Boolean);
                            const tactical = normalizeLine(card.querySelector('div')?.textContent || '');
                            return {
                                title,
                                meta: paragraphs[0] || '',
                                detail: paragraphs.slice(1).join(' '),
                                tactical
                            };
                        })
                        .filter((item) => item.title);

                    const guardrails = Array.from(root?.querySelectorAll('li') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const paragraphs = Array.from(root?.querySelectorAll('p') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .filter(Boolean);

                    const apraFromDoctrine = doctrineCards.find((item) => /APRA|fit-and-proper|CPS 520/i.test(`${item.title} ${item.meta} ${item.detail}`));
                    const apraRisk = apraFromDoctrine
                        ? normalizeLine(`${apraFromDoctrine.meta} ${apraFromDoctrine.detail}`)
                        : (paragraphs.find((line) => /APRA|CPS 520|fit-and-proper/i.test(line))
                            || 'Occupational impact is role and framework dependent; APRA CPS 520 considerations should be handled with objective documentary support.');

                    const caveat = paragraphs.find((line) => /section 59 has offence exclusions|charge-by-charge eligibility/i.test(line))
                        || 'Verified legislation indicates section 59 has offence exclusions (including certain Road Safety Act s49(1) offences). Treat diversion as charge-by-charge eligibility plus prosecution/court practice, not an automatic entitlement.';

                    return {
                        doctrineCards: doctrineCards.length
                            ? doctrineCards
                            : [{ title: 'Core Doctrine', meta: 'Proudman v Dayman (1941) 67 CLR 536', detail: fallbackLine, tactical: '' }],
                        guardrails: guardrails.length
                            ? guardrails
                            : ['Separate provable facts from submissions and avoid unsupported assertions.'],
                        apraRisk,
                        caveat
                    };
                }

                function extractFinancialData() {
                    const root = document.getElementById('view-financial');
                    const protocolRows = Array.from(root?.querySelectorAll('.flex.justify-between') || [])
                        .map((row) => {
                            const left = normalizeLine(row.children[0]?.textContent || '');
                            const right = normalizeLine(row.children[1]?.textContent || '');
                            return { step: left, detail: right };
                        })
                        .filter((item) => /^step\s*\d+/i.test(item.step));

                    const chargeCards = Array.from(root?.querySelectorAll('.grid.grid-cols-2 > div') || [])
                        .map((card) => {
                            const paragraphs = Array.from(card.querySelectorAll('p'));
                            const label = normalizeLine(paragraphs[0]?.textContent || 'Charge requirement');
                            const detail = normalizeLine(paragraphs.slice(1).map((node) => node.textContent).join(' '));
                            return {
                                label,
                                value: label,
                                detail: detail || fallbackLine
                            };
                        })
                        .filter((card) => card.label || card.detail);

                    const aggregateSpan = Array.from(root?.querySelectorAll('span') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .find((text) => /negative intercept|aggregate conduct/i.test(text));

                    const aggregateValue = Array.from(root?.querySelectorAll('span') || [])
                        .map((node) => normalizeLine(node.textContent))
                        .find((text) => /impound|complaint|chronology|records/i.test(text));

                    return {
                        protocolRows: protocolRows.length
                            ? protocolRows
                            : [
                                { step: 'Step 1', detail: 'Export Drive folder as read-only local case bundle.' },
                                { step: 'Step 2', detail: 'Apply strict naming format for all evidence files.' },
                                { step: 'Step 3', detail: 'Build exhibit register with admissibility mapping.' },
                                { step: 'Step 4', detail: 'Hash exhibits and preserve chain-of-custody records.' },
                                { step: 'Step 5', detail: 'Generate bookmarked court bundle PDF with indexed exhibits.' }
                            ],
                        chargeCards: chargeCards.length
                            ? chargeCards
                            : [
                                {
                                    label: 'Charge 1 (s30)',
                                    value: 'Charge 1 (s30)',
                                    detail: 'VicRoads status certificate, notice/service records, and contemporaneous belief evidence.'
                                },
                                {
                                    label: 'Charges 2-3 (s49)',
                                    value: 'Charges 2-3 (s49)',
                                    detail: 'Testing records, analyst certificates, chain-of-custody, procedure warnings, and BWC/police notes.'
                                }
                            ],
                        aggregateNote: normalizeLine(`${aggregateSpan || 'Aggregate conduct evidence leverage.'} ${aggregateValue || ''}`)
                            || 'Negative intercept records, impound receipts, and complaint chronology should be indexed for mitigation and proportionality submissions.'
                    };
                }

                function extractCourtData() {
                    const root = document.getElementById('view-court');
                    const roadmapRows = Array.from(root?.querySelectorAll('.relative.pl-10') || [])
                        .map((row) => {
                            const stage = normalizeLine(row.querySelector('h5')?.textContent || '');
                            const detail = normalizeLine(row.querySelector('p')?.textContent || '');
                            return { stage, detail };
                        })
                        .filter((item) => item.stage || item.detail);

                    const judicialNote = normalizeLine(document.getElementById('magistrate-feedback')?.textContent || '')
                        || 'Judicial simulator note unavailable at export time.';
                    const scriptLive = normalizeMultiline(document.getElementById('courtScript')?.value || '');

                    return {
                        roadmapRows: roadmapRows.length
                            ? roadmapRows
                            : [
                                { stage: 'Day 0-1 | Immediate', detail: 'Create evidence bundle and demand complete brief.' },
                                { stage: 'Day 2-4 | Element Mapping', detail: 'Map each exhibit to element/admissibility requirements.' },
                                { stage: 'Day 5-7 | Negotiation', detail: 'Engage prosecution on brief gaps and streamlining opportunities.' },
                                { stage: 'Day 8-10 | Finalise Pack', detail: 'Finalise diversion exhibits and mention script.' },
                                { stage: 'Day 11-12 | Pre-Hearing', detail: 'Print bundles and rehearse concise oral submissions.' }
                            ],
                        judicialNote,
                        scriptLive: scriptLive || fallbackLine
                    };
                }

                const dashboardData = extractDashboardData();
                const interventionData = extractInterventionData();
                const timelineRows = extractTimelineRows();
                const matrixRows = extractMatrixRows();
                const pscData = extractPscData();
                const legalData = extractLegalData();
                const financialData = extractFinancialData();
                const courtData = extractCourtData();

                // Page 1 - Cover
                addBrandedPage('Cover', false);
                doc.setDrawColor(...COLORS.gold);
                doc.setLineWidth(0.35);
                doc.line(ML, 56, MR, 56);
                doc.line(ML, 119, MR, 119);

                let coverY = 87;
                coverY += drawCenteredText('LEX DEFENCE', 'coverTitle', coverY);
                coverY += 5;
                coverY += drawCenteredText('Executive Defence Strategy', 'coverSubtitle', coverY);
                coverY += 18;
                coverY += drawCenteredText('Police v Deshpande', 'docTitle', coverY);
                coverY += 6;
                coverY += drawCenteredText('Melbourne Magistrates Court', 'body', coverY, 120);
                coverY += 4.5;
                coverY += drawCenteredText('Hearing: 23 February 2026', 'body', coverY, 120);
                coverY += 14;
                drawCenteredText(`Prepared ${exportDateLabel}`, 'subHeader', coverY, 120);

                // Page 2 - TOC
                addBrandedPage('Table of Contents', false);
                drawSectionHeader('Table of Contents', 'Strategic section map aligned to executive review standard.');
                drawTableGrid({
                    columns: [
                        { key: 'section', label: 'Strategic Section', width: 0.82 },
                        { key: 'page', label: 'Target Page', width: 0.18 }
                    ],
                    rows: [
                        { section: 'Executive Summary', page: '3' },
                        { section: 'Immediate Intervention', page: '4' },
                        { section: 'Canonical Timeline', page: '5' },
                        { section: 'Truth Matrix', page: '6' },
                        { section: 'Deep Dive I - PSC Analysis', page: '7' },
                        { section: 'Deep Dive II - APRA Regulatory Risk', page: '8' },
                        { section: 'Deep Dive III - Financial Audit', page: '9' },
                        { section: 'Roadmap / Oral Submission', page: '10' }
                    ]
                });
                drawSubHeader('Document Controls');
                drawBulletedList([
                    'Strict rendering margins: 25 mm left/right and 30-270 mm content band.',
                    'All text blocks are split with style-aware splitTextToSize before drawing.',
                    'Core section order is fixed to 10 pages; overflow is appended as continuation pages.',
                    'Header and footer chrome are rendered on every page with final page stamping.'
                ]);

                // Page 3 - Executive Summary
                addBrandedPage('Executive Summary', false);
                drawSectionHeader('Case Snapshot & Objectives', 'Purpose and strategic baseline from the live dashboard context.');
                drawSubHeader('Purpose and Context', 8);
                drawWrappedParagraph(dashboardData.purpose);
                drawWrappedParagraph(dashboardData.status, { styleKey: 'body' });
                drawSubHeader('Key Strategic Indicators', 18);
                const coreSummaryCards = dashboardData.cards.slice(0, 4);
                const overflowSummaryCards = dashboardData.cards.slice(4);
                drawKpiCards(coreSummaryCards, { columns: 2 });
                if (overflowSummaryCards.length) {
                    queueContinuation('Executive Summary', 'Additional Strategic Indicators', () => {
                        drawKpiCards(overflowSummaryCards, { columns: 2 });
                    });
                }
                drawSubHeader('Strategic Priorities', 10);
                const corePriorities = dashboardData.priorities.slice(0, 4);
                const overflowPriorities = dashboardData.priorities.slice(4);
                drawBulletedList(corePriorities);
                if (overflowPriorities.length) {
                    queueContinuation('Executive Summary', 'Additional Strategic Priorities', () => {
                        drawBulletedList(overflowPriorities);
                    });
                }

                // Page 4 - Intervention
                addBrandedPage('Immediate Intervention', false);
                drawSectionHeader('Forensic Audit of Dashboard', 'Immediate protocol and corrective framing for lawful interactions.');
                drawSubHeader('Immediate Protocol Script', 14);
                drawCallout(interventionData.script, { tone: 'neutral' });
                drawSubHeader('Immediate Corrective Action Rule', 8);
                drawWrappedParagraph(interventionData.correctiveRule);
                drawCallout(interventionData.conditional, { tone: 'accent' });
                drawSubHeader('Operational Status', 20);
                const coreStatusCards = interventionData.statusCards.slice(0, 3);
                const overflowStatusCards = interventionData.statusCards.slice(3);
                drawKpiCards(coreStatusCards, { columns: 2 });
                if (overflowStatusCards.length) {
                    queueContinuation('Immediate Intervention', 'Operational Status (Cont.)', () => {
                        drawKpiCards(overflowStatusCards, { columns: 2 });
                    });
                }

                // Page 5 - Timeline
                addBrandedPage('Canonical Timeline', false);
                drawSectionHeader('Procedural Pathway & Hearing Plan', 'Dashboard-derived chronology requiring certificate and brief verification.');
                const coreTimelineRows = timelineRows.slice(0, 9);
                const overflowTimelineRows = timelineRows.slice(9);
                drawTableGrid({
                    columns: [
                        { key: 'date', label: 'Date', width: 0.22 },
                        { key: 'incident', label: 'Incident', width: 0.26 },
                        { key: 'strategicWeight', label: 'Strategic Weight', width: 0.52 }
                    ],
                    rows: coreTimelineRows
                });
                if (overflowTimelineRows.length) {
                    queueContinuation('Canonical Timeline', 'Canonical Timeline', () => {
                        drawTableGrid({
                            columns: [
                                { key: 'date', label: 'Date', width: 0.22 },
                                { key: 'incident', label: 'Incident', width: 0.26 },
                                { key: 'strategicWeight', label: 'Strategic Weight', width: 0.52 }
                            ],
                            rows: overflowTimelineRows
                        });
                    });
                }

                // Page 6 - Truth Matrix
                addBrandedPage('Truth Matrix', false);
                drawSectionHeader('Probability Matrix & Risk Map', 'Truth matrix generated from allegation-to-evidence mapping.');
                const coreMatrixRows = matrixRows.slice(0, 7);
                const overflowMatrixRows = matrixRows.slice(7);
                drawTableGrid({
                    columns: [
                        { key: 'allegation', label: 'Police Allegation', width: 0.23 },
                        { key: 'reality', label: 'Forensic Reality', width: 0.33 },
                        { key: 'evidence', label: 'Evidence Key', width: 0.24 },
                        { key: 'source', label: 'Dependencies / Source Register', width: 0.20 }
                    ],
                    rows: coreMatrixRows
                });
                if (overflowMatrixRows.length) {
                    queueContinuation('Truth Matrix', 'Truth Matrix', () => {
                        drawTableGrid({
                            columns: [
                                { key: 'allegation', label: 'Police Allegation', width: 0.23 },
                                { key: 'reality', label: 'Forensic Reality', width: 0.33 },
                                { key: 'evidence', label: 'Evidence Key', width: 0.24 },
                                { key: 'source', label: 'Dependencies / Source Register', width: 0.20 }
                            ],
                            rows: overflowMatrixRows
                        });
                    });
                }

                // Page 7 - PSC Analysis
                addBrandedPage('Deep Dive I - PSC Analysis', false);
                drawSectionHeader('PSC Analysis: Forensic Audit & Conduct Risk', 'Extracted from the Forensic Audit panel in the live dashboard.');
                drawSubHeader('Forensic Audit Summary', 8);
                drawWrappedParagraph(pscData.summary);

                drawSubHeader('What the Dashboard Does Well', 10);
                const corePscStrengths = pscData.strengths.slice(0, 4);
                const overflowPscStrengths = pscData.strengths.slice(4);
                drawBulletedList(corePscStrengths, { styleKey: 'tableBody' });

                drawSubHeader('Immediate Corrective Action Track', 10);
                const corePscCorrective = pscData.corrective.slice(0, 4);
                const overflowPscCorrective = pscData.corrective.slice(4);
                drawBulletedList(corePscCorrective, { styleKey: 'tableBody' });

                drawSubHeader('PSC Risk Register', 12);
                const corePscRiskRows = pscData.riskRows.slice(0, 4);
                const overflowPscRiskRows = pscData.riskRows.slice(4);
                drawTableGrid({
                    columns: [
                        { key: 'issue', label: 'Issue', width: 0.25 },
                        { key: 'why', label: 'Why It Matters', width: 0.45 },
                        { key: 'likelihood', label: 'Likelihood', width: 0.15 },
                        { key: 'impact', label: 'Impact', width: 0.15 }
                    ],
                    rows: corePscRiskRows
                });

                if (overflowPscStrengths.length || overflowPscCorrective.length || overflowPscRiskRows.length) {
                    queueContinuation('Deep Dive I - PSC Analysis', 'PSC Analysis', () => {
                        if (overflowPscStrengths.length) {
                            drawSubHeader('What the Dashboard Does Well (Cont.)');
                            drawBulletedList(overflowPscStrengths, { styleKey: 'tableBody' });
                        }
                        if (overflowPscCorrective.length) {
                            drawSubHeader('Immediate Corrective Action Track (Cont.)');
                            drawBulletedList(overflowPscCorrective, { styleKey: 'tableBody' });
                        }
                        if (overflowPscRiskRows.length) {
                            drawSubHeader('PSC Risk Register (Cont.)');
                            drawTableGrid({
                                columns: [
                                    { key: 'issue', label: 'Issue', width: 0.25 },
                                    { key: 'why', label: 'Why It Matters', width: 0.45 },
                                    { key: 'likelihood', label: 'Likelihood', width: 0.15 },
                                    { key: 'impact', label: 'Impact', width: 0.15 }
                                ],
                                rows: overflowPscRiskRows
                            });
                        }
                    });
                }

                // Page 8 - APRA Risk
                addBrandedPage('Deep Dive II - APRA Regulatory Risk', false);
                drawSectionHeader('Legal Framework & APRA Risk', 'Doctrine mapping plus APRA/CPS impact framing and diversion caveat.');
                drawSubHeader('Core Defence Position', 10);
                drawWrappedParagraph(CORE_DEFENCE_CONTEXT || fallbackLine);

                const coreDoctrineCards = legalData.doctrineCards.slice(0, 3);
                const overflowDoctrineCards = legalData.doctrineCards.slice(3);
                drawSubHeader('Primary Authorities', 10);
                coreDoctrineCards.forEach((item) => {
                    drawSubHeader(item.title, 6);
                    if (item.meta) drawWrappedParagraph(item.meta, { styleKey: 'tableBody' });
                    if (item.detail) drawWrappedParagraph(item.detail);
                    if (item.tactical) drawCallout(item.tactical, { tone: 'neutral', styleKey: 'tableBody' });
                });

                drawSubHeader('APRA Regulatory Risk', 6);
                drawWrappedParagraph(legalData.apraRisk);
                apraSectionRendered = Boolean(normalizeLine(legalData.apraRisk));

                drawSubHeader('Diversion Eligibility Caveat', 8);
                drawCallout(legalData.caveat, { tone: 'alert' });

                const coreGuardrails = legalData.guardrails.slice(0, 4);
                const overflowGuardrails = legalData.guardrails.slice(4);
                if (coreGuardrails.length) {
                    drawSubHeader('Control Guardrails', 8);
                    drawBulletedList(coreGuardrails, { styleKey: 'tableBody' });
                }

                if (overflowDoctrineCards.length || overflowGuardrails.length) {
                    queueContinuation('Deep Dive II - APRA Regulatory Risk', 'APRA Risk', () => {
                        overflowDoctrineCards.forEach((item) => {
                            drawSubHeader(item.title, 6);
                            if (item.meta) drawWrappedParagraph(item.meta, { styleKey: 'tableBody' });
                            if (item.detail) drawWrappedParagraph(item.detail);
                            if (item.tactical) drawCallout(item.tactical, { tone: 'neutral', styleKey: 'tableBody' });
                        });
                        if (overflowGuardrails.length) {
                            drawSubHeader('Control Guardrails (Cont.)', 8);
                            drawBulletedList(overflowGuardrails, { styleKey: 'tableBody' });
                        }
                    });
                }

                // Page 9 - Financial Audit
                addBrandedPage('Deep Dive III - Financial Audit', false);
                drawSectionHeader('Evidence Action Plan & Financial Audit', 'Evidence ingestion protocol and charge-specific audit controls.');
                const coreProtocolRows = financialData.protocolRows.slice(0, 5);
                const overflowProtocolRows = financialData.protocolRows.slice(5);
                drawSubHeader('Evidence Ingestion Protocol', 18);
                drawTableGrid({
                    columns: [
                        { key: 'step', label: 'Protocol Step', width: 0.28 },
                        { key: 'detail', label: 'Implementation Detail', width: 0.72 }
                    ],
                    rows: coreProtocolRows
                });

                const coreChargeCards = financialData.chargeCards.slice(0, 2);
                const overflowChargeCards = financialData.chargeCards.slice(2);
                drawSubHeader('Charge-Specific Requirements', 16);
                drawKpiCards(coreChargeCards, { columns: 2 });

                drawSubHeader('Financial and Conduct Context', 8);
                drawWrappedParagraph(financialData.aggregateNote);

                if (overflowProtocolRows.length || overflowChargeCards.length) {
                    queueContinuation('Deep Dive III - Financial Audit', 'Financial Audit', () => {
                        if (overflowProtocolRows.length) {
                            drawSubHeader('Evidence Ingestion Protocol (Cont.)', 8);
                            drawTableGrid({
                                columns: [
                                    { key: 'step', label: 'Protocol Step', width: 0.28 },
                                    { key: 'detail', label: 'Implementation Detail', width: 0.72 }
                                ],
                                rows: overflowProtocolRows
                            });
                        }
                        if (overflowChargeCards.length) {
                            drawSubHeader('Charge-Specific Requirements (Cont.)', 8);
                            drawKpiCards(overflowChargeCards, { columns: 2 });
                        }
                    });
                }

                // Page 10 - Roadmap / Oral Submission
                addBrandedPage('Roadmap / Oral Submission', false);
                drawSectionHeader('Roadmap: Oral Submission Script', 'Live script extracted from the current dashboard state.');
                drawSubHeader('Court-Day Execution Checklist', 14);
                const coreRoadmapRows = courtData.roadmapRows.slice(0, 5);
                const overflowRoadmapRows = courtData.roadmapRows.slice(5);
                drawTableGrid({
                    columns: [
                        { key: 'stage', label: 'Stage', width: 0.31 },
                        { key: 'detail', label: 'Execution Detail', width: 0.69 }
                    ],
                    rows: coreRoadmapRows
                });

                drawSubHeader('Judicial Simulator Note', 8);
                drawWrappedParagraph(courtData.judicialNote);

                const fullScriptLive = courtData.scriptLive || fallbackLine;
                const scriptLines = splitTextExact(fullScriptLive, CONTENT_W - 4.2, 'callout');
                const coreScriptLineCount = 30;
                const coreScriptText = scriptLines.slice(0, coreScriptLineCount).join('\n') || fallbackLine;
                const overflowScriptText = scriptLines.slice(coreScriptLineCount).join('\n');

                drawSubHeader('Courtroom Submission Script', 20);
                drawCallout(coreScriptText, {
                    tone: 'neutral',
                    preserveLineBreaks: true,
                    styleKey: 'callout'
                });

                drawSubHeader('Closing Control Points');
                drawBulletedList([
                    'Maintain lawful compliance posture while preserving right-to-silence boundaries.',
                    'Anchor every submission to dated records, certificates, or direct exhibit references.',
                    'Present diversion first, with fallback minimisation and no-conviction pathway where legally open.'
                ], { styleKey: 'tableBody' });

                if (overflowRoadmapRows.length || overflowScriptText) {
                    queueContinuation('Roadmap / Oral Submission', 'Roadmap / Oral Submission', () => {
                        if (overflowRoadmapRows.length) {
                            drawSubHeader('Court-Day Execution Checklist (Cont.)', 8);
                            drawTableGrid({
                                columns: [
                                    { key: 'stage', label: 'Stage', width: 0.31 },
                                    { key: 'detail', label: 'Execution Detail', width: 0.69 }
                                ],
                                rows: overflowRoadmapRows
                            });
                        }
                        if (overflowScriptText) {
                            drawSubHeader('Courtroom Submission Script (Cont.)', 10);
                            drawCallout(overflowScriptText, {
                                tone: 'neutral',
                                preserveLineBreaks: true,
                                styleKey: 'callout'
                            });
                        }
                    });
                }

                continuationQueue.forEach((item) => {
                    addBrandedPage(item.sectionName, true);
                    drawSectionHeader(`${item.title} (Continuation)`, 'Overflow content appended after the core ten-page structure.');
                    item.render();
                });

                // Quality gates
                const currentLiveScript = normalizeMultiline(document.getElementById('courtScript')?.value || '');
                if (currentLiveScript !== courtData.scriptLive) {
                    throw new Error('Court script changed during export. Re-run export to capture the latest live text.');
                }

                if (!apraSectionRendered) {
                    throw new Error('APRA Regulatory Risk section is missing or empty.');
                }

                const renderedTextModel = renderedCorpus.join('\n').toUpperCase();
                ['PRIVILEGED', 'CONFIDENTIAL'].forEach((phrase) => {
                    if (!renderedTextModel.includes(phrase)) {
                        throw new Error(`Required legal marker missing: ${phrase}`);
                    }
                });

                if (/\[REDACTED_PENDING\]/i.test(renderedTextModel) || /<REDACT_ME>/i.test(renderedTextModel)) {
                    throw new Error('Unresolved redaction marker detected. Resolve markers before export.');
                }

                const totalPages = doc.getNumberOfPages();
                if (totalPages < 10) {
                    throw new Error(`Minimum page threshold failed: expected at least 10 pages, got ${totalPages}.`);
                }

                for (let pageNo = 1; pageNo <= totalPages; pageNo += 1) {
                    doc.setPage(pageNo);
                    const meta = pageMeta[pageNo - 1] || {
                        section: 'Executive Brief',
                        continuation: false,
                        label: 'Executive Brief'
                    };
                    drawFooterChrome(meta.label || meta.section, pageNo, totalPages, true);
                }

                doc.save(`Executive_Defence_Strategy_${filenameDate}.pdf`);
            } catch (error) {
                console.error('PDF Export Failed:', error);
                alert('Export failed: ' + error.message);
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }
        // Init
        switchView('dashboard');
    </script>

    <!-- AI FORENSIC INSPECTOR (Floating) -->
    <div id="ai-inspector" class="ai-inspector flex flex-col hidden">
        <div class="px-6 py-4 border-b border-white/5 bg-white/[0.02] flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-microscope text-executive-gold"></i>
                <h5 class="text-[10px] font-bold text-white uppercase tracking-widest">Forensic AI Inspector</h5>
            </div>
            <button onclick="document.getElementById('ai-inspector').classList.add('hidden')"
                class="text-slate-500 hover:text-white">
                <i class="fa-solid fa-times text-xs"></i>
            </button>
        </div>
        <div id="inspector-content"
            class="flex-1 p-6 overflow-y-auto custom-scrollbar text-[11px] text-slate-300 leading-relaxed font-mono">
            Scanning document for administrative anomalies...
        </div>
        <div class="p-4 bg-black/20 border-t border-white/5">
            <div class="flex gap-2">
                <input type="text" id="inspector-query"
                    class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] focus:outline-none focus:border-executive-gold"
                    placeholder="Ask about this document...">
                <button onclick="triggerAIAction('inspect')"
                    class="px-3 bg-executive-gold text-navy font-bold rounded-lg"><i
                        class="fa-solid fa-magnifying-glass text-xs text-executive-navy"></i></button>
            </div>
        </div>
    </div>
</body>

</html>
