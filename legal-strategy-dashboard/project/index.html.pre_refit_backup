<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Executive Defence Strategy | Police v Deshpande</title>
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPSc2NCcgaGVpZ2h0PSc2NCcgdmlld0JveD0nMCAwIDY0IDY0Jz48cmVjdCB3aWR0aD0nNjQnIGhlaWdodD0nNjQnIHJ4PScxMicgZmlsbD0nIzAyMDYxNycvPjxwYXRoIGQ9J00xNiAxMmgzMnY0MEgxNnonIHN0cm9rZT0nI0Q0QUYzNycgc3Ryb2tlLXdpZHRoPSc0JyBmaWxsPSdub25lJy8+PHBhdGggZD0nTTI0IDI0aDE2bS0xNiAxMGgxNm0tMTYgMTBoMTYnIHN0cm9rZT0nI0Q0QUYzNycgc3Ryb2tlLXdpZHRoPSczJy8+PC9zdmc+">
    <meta name="theme-color" content="#c5a059">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LegalDash">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3652/3652191.png">

    <!-- External Resources -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Google Identity & API Setup -->
    <script src="https://apis.google.com/js/api.js" defer></script>
    <script src="https://accounts.google.com/gsi/client" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

    <!-- Typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap"
        rel="stylesheet">

    <!-- Custom Config -->
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        executive: {
                            navy: '#020617',
                            gold: '#D4AF37',
                            goldDark: '#B8860B',
                            crimson: '#7F1D1D',
                            slate: '#1E293B',
                            silver: '#E2E8F0'
                        },
                        legal: {
                            navy: '#0a192f',
                            slate: '#334155',
                            gold: '#c5a059',
                            paper: '#f8fafc',
                            alert: '#ef4444'
                        }
                    },
                    boxShadow: {
                        'executive': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
                        'card': '0 0 0 1px rgba(255,255,255,0.05), 0 4px 6px -1px rgba(0,0,0,0.1)',
                        'glass': 'inset 0 0 0 1px rgba(255,255,255,0.1)'
                    },
                    backgroundImage: {
                        'executive-gradient': 'linear-gradient(135deg, #020617 0%, #0f172a 100%)',
                        'gold-gradient': 'linear-gradient(135deg, #D4AF37 0%, #B8860B 100%)'
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --nav-width: 280px;
            --primary-gold: #D4AF37;
            --executive-navy: #020617;
        }

        body {
            background-color: #020617;
            color: #E2E8F0;
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.02);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Navigation & UI */
        .nav-item {
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-left: 3px solid transparent;
            opacity: 0.6;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            opacity: 1;
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(212, 175, 55, 0.1) 0%, transparent 100%);
            border-left-color: var(--primary-gold);
            color: #fff;
            opacity: 1;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .executive-border {
            border: 1px solid rgba(212, 175, 55, 0.2);
        }

        .timeline-connector {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 18px;
            width: 1px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 0;
        }

        @media (min-width: 768px) {
            .timeline-connector {
                left: 24px;
            }
        }

        /* Perspective Cards */
        .perspective-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backface-visibility: hidden;
        }

        .perspective-active {
            transform: rotateY(0deg);
            opacity: 1;
            pointer-events: auto;
        }

        .perspective-hidden {
            transform: rotateY(180deg);
            opacity: 0;
            pointer-events: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        /* AI Thinking Animation */
        .thinking-dots div {
            animation-duration: 1.2s;
            animation-iteration-count: infinite;
            animation-timing-function: ease-in-out;
        }

        .thinking-dots div:nth-child(1) {
            animation-name: bounce;
        }

        .thinking-dots div:nth-child(2) {
            animation-name: bounce;
            animation-delay: 0.1s;
        }

        .thinking-dots div:nth-child(3) {
            animation-name: bounce;
            animation-delay: 0.2s;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-4px);
            }
        }

        /* Intervention Mode */
        .intervention-alert {
            animation: pulse-red 2s infinite;
        }

        @keyframes pulse-red {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        /* Drag and Drop Zone */
        .drop-zone {
            border: 2px dashed rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            border-color: var(--primary-gold);
            background-color: rgba(212, 175, 55, 0.05);
        }

        /* Forensic Document Sheets - Dark Mode Professional */
        .doc-sheet {
            background: #020617;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            color: #cbd5e1;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            background-image:
                radial-gradient(circle at 2px 2px, rgba(255, 255, 255, 0.02) 1px, transparent 0);
            background-size: 24px 24px;
        }

        .doc-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8rem;
            color: rgba(255, 255, 255, 0.02);
            font-weight: 900;
            pointer-events: none;
            z-index: 0;
            white-space: nowrap;
            letter-spacing: 0.5em;
        }

        .doc-sheet .border-black {
            border-color: rgba(255, 255, 255, 0.1) !important;
        }

        .doc-sheet .text-slate-800 {
            color: #f8fafc !important;
        }

        .doc-sheet .bg-yellow-100 {
            background: rgba(234, 179, 8, 0.1) !important;
            border-color: rgba(234, 179, 8, 0.3) !important;
            color: #fef08a !important;
        }

        .doc-sheet .bg-red-50 {
            background: rgba(239, 68, 68, 0.05) !important;
            border-color: rgba(239, 68, 68, 0.2) !important;
            color: #fca5a5 !important;
        }

        .active-doc-btn {
            background: rgba(255, 255, 255, 0.05) !important;
            border-color: var(--executive-gold) !important;
            color: white !important;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.1);
        }

        /* AI Forensic Inspector (Floating) */
        .ai-inspector {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 320px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            z-index: 1000;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Print/PDF Export Optimization */
        #pdf-export-container {
            display: none;
            position: absolute;
            left: -9999px;
            width: 800px;
            background: #020617;
            color: white;
            padding: 40px;
        }

        .pdf-page-breaker {
            page-break-after: always;
            height: 1px;
        }

        @media print {
            .view-panel {
                display: block !important;
                opacity: 1 !important;
                page-break-after: always;
            }
        }
    </style>
</head>

<body
    class="h-screen flex overflow-hidden antialiased selection:bg-executive-gold selection:text-white executive-gradient">

    <!-- MOBILE OVERLAY BACKDROP -->
    <div id="mobile-overlay" onclick="toggleSidebar()"
        class="fixed inset-0 bg-black/80 z-30 hidden lg:hidden backdrop-blur-md transition-opacity opacity-0"></div>

    <!-- EXECUTIVE SIDEBAR -->
    <aside id="sidebar" role="navigation"
        class="fixed inset-y-0 left-0 z-40 w-[var(--nav-width)] bg-executive-navy border-r border-white/5 text-slate-400 flex flex-col shadow-2xl transform -translate-x-full lg:translate-x-0 lg:static transition-transform duration-300 flex-shrink-0">
        <!-- Brand -->
        <div class="p-8 border-b border-white/5 flex justify-between items-center group cursor-pointer"
            onclick="switchView('dashboard')">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="w-10 h-10 rounded bg-gold-gradient flex items-center justify-center shadow-lg transform group-hover:scale-110 transition-transform">
                        <i class="fa-solid fa-scale-balanced text-white text-xl"></i>
                    </div>
                    <h1 class="font-serif text-xl font-bold tracking-[0.2em] text-white">LEX DEFENSION</h1>
                </div>
                <p class="text-[9px] uppercase tracking-[0.4em] text-executive-gold font-bold">Elite Strategic Counsel
                </p>
            </div>
            <button onclick="toggleSidebar()" aria-label="Close sidebar" class="lg:hidden text-slate-400 hover:text-white"><i
                    class="fa-solid fa-times text-xl"></i></button>
        </div>

        <!-- Navigation -->
        <nav class="flex-1 overflow-y-auto py-6 space-y-1 custom-scrollbar">
            <button onclick="switchView('dashboard')" id="btn-dashboard" aria-label="Executive Briefing"
                class="nav-item active w-full text-left px-8 py-4 text-[10px] font-bold uppercase tracking-[0.15em] flex items-center gap-4">
                <i class="fa-solid fa-chart-line w-5 text-center text-executive-gold"></i> Executive Briefing
            </button>
            <button onclick="switchView('intervention')" id="btn-intervention" aria-label="Police Intervention"
                class="nav-item w-full text-left px-8 py-4 text-[10px] font-bold uppercase tracking-[0.15em] flex items-center gap-4 bg-red-950/20 text-red-400 border-l-red-600">
                <i class="fa-solid fa-hand-shield w-5 text-center intervention-alert"></i> POLICE INTERVENTION
            </button>
            <div class="px-8 py-4 text-[9px] uppercase tracking-widest text-slate-500 font-bold">Case Intelligence</div>
            <button onclick="switchView('chronology')" id="btn-chronology" aria-label="Forensic Timeline"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-clock-rotate-left w-5 text-center"></i> Forensic Timeline
            </button>
            <button onclick="switchView('harassment')" id="btn-harassment" aria-label="Conduct Analysis"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-user-secret w-5 text-center"></i> Conduct Analysis
            </button>
            <button onclick="switchView('matrix')" id="btn-matrix" aria-label="Truth Matrix"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-layer-group w-5 text-center"></i> Truth Matrix
            </button>
            <button onclick="switchView('legal')" id="btn-legal" aria-label="Legal Arguments"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-gavel w-5 text-center"></i> Legal Arguments
            </button>

            <div class="px-8 py-4 text-[9px] uppercase tracking-widest text-slate-500 font-bold">Assets & Operations
            </div>
            <button onclick="switchView('files')" id="btn-files" aria-label="Evidence Vault"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-vault w-5 text-center"></i> Evidence Vault
            </button>
            <button onclick="switchView('financial')" id="btn-financial" aria-label="Forensic Data"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-file-invoice-dollar w-5 text-center"></i> Forensic Data
            </button>
            <button onclick="switchView('court')" id="btn-court" aria-label="Court Operations"
                class="nav-item w-full text-left px-8 py-3.5 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4">
                <i class="fa-solid fa-landmark w-5 text-center"></i> Court Ops
            </button>

            <button onclick="switchView('ai')" id="btn-ai" aria-label="AI Co-Counsel"
                class="nav-item w-full text-left px-8 py-4 mt-4 text-[10px] font-bold uppercase tracking-widest flex items-center gap-4 bg-white/5 border-l-executive-gold">
                <i class="fa-solid fa-brain w-5 text-center text-executive-gold"></i> AI Co-Counsel
            </button>
        </nav>

        <!-- Emergency Contact -->
        <div class="p-6 bg-amber-900/10 border-t border-white/5">
            <div class="flex items-center gap-3 mb-3">
                <div
                    class="w-8 h-8 rounded-full border border-executive-gold/30 flex items-center justify-center text-executive-gold">
                    <i class="fa-solid fa-phone-volume text-xs"></i>
                </div>
                <div>
                    <p class="text-[9px] uppercase text-slate-500 font-bold">Priority Support</p>
                    <p class="text-xs font-mono text-white">Duty Counsel Active</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main role="main" class="flex-1 overflow-y-auto bg-executive-navy relative smooth-scroll w-full custom-scrollbar">

        <!-- Sticky Header -->
        <header
            class="sticky top-0 z-20 bg-executive-navy/80 backdrop-blur-xl border-b border-white/5 px-6 md:px-10 py-5 flex justify-between items-center shadow-2xl">
            <div class="flex items-center gap-6">
                <button onclick="toggleSidebar()" aria-label="Open sidebar"
                    class="lg:hidden text-white transition-colors hover:text-executive-gold">
                    <i class="fa-solid fa-bars-staggered text-2xl"></i>
                </button>
                <div>
                    <h2 id="page-title" class="font-serif text-xl md:text-2xl font-bold text-white tracking-tight">
                        Executive Briefing</h2>
                    <div class="flex items-center gap-3 mt-1.5">
                        <div
                            class="flex items-center gap-2 px-2 py-0.5 rounded bg-emerald-500/10 border border-emerald-500/20">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                            <span class="text-[9px] text-emerald-400 font-bold uppercase tracking-[0.1em]">AI Engine
                                Active</span>
                        </div>
                        <p id="page-subtitle"
                            class="text-[9px] text-slate-500 font-bold uppercase tracking-[0.2em] hidden xs:block border-l border-white/10 pl-3">
                            Hearing: 23 Feb 2026 | Magistrates' Court</p>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-3 md:gap-6">
                <!-- Sync Status Indicator -->
                <div id="sync-status" role="status" aria-live="polite"
                    class="hidden md:flex px-4 py-2 glass-panel rounded-full items-center gap-3 cursor-pointer group transition-all hover:bg-white/5"
                    onclick="switchView('ai')">
                    <div id="sync-indicator-container" class="relative">
                        <span id="sync-indicator"
                            class="w-2.5 h-2.5 rounded-full bg-slate-500 transition-colors"></span>
                        <span id="sync-ping"
                            class="absolute inset-0 w-2.5 h-2.5 rounded-full bg-slate-500 animate-ping opacity-0"></span>
                    </div>
                    <span id="sync-text" class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">System
                        Ready</span>
                </div>

                <button onclick="exportDashboardToPDF(event)" aria-label="Export Briefing to PDF"
                    class="flex px-5 py-2 bg-gold-gradient hover:scale-105 text-white text-[9px] font-bold uppercase tracking-[0.2em] rounded-full transition-all items-center gap-2 shadow-lg border border-white/10">
                    <i class="fa-solid fa-file-pdf"></i> <span class="hidden xs:inline">Export Briefing</span>
                </button>

                <div class="flex items-center gap-2">
                    <div class="h-10 w-10 rounded glass-panel executive-border text-white flex items-center justify-center font-serif font-bold text-sm shadow-xl cursor-help"
                        title="Deshpande, V. | Rank: Executive">
                        VD</div>
                </div>
            </div>
        </header>

        <div class="p-6 md:p-10 max-w-7xl mx-auto space-y-10 pb-24">

            <!-- VIEW: INTERVENTION (NEW) -->
            <div id="view-intervention" class="view-panel hidden animate-fade-in space-y-8">
                <div class="p-8 bg-red-950/30 border border-red-500/30 rounded-2xl intervention-alert">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-full bg-red-600 flex items-center justify-center shadow-lg shadow-red-900/50">
                                <i class="fa-solid fa-hand text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="font-serif text-2xl font-bold text-white">INTERVENTION MODE</h3>
                                <p class="text-xs text-red-400 font-bold uppercase tracking-widest mt-1">Real-Time Law
                                    Enforcement Interaction</p>
                            </div>
                        </div>
                        <div class="px-4 py-2 bg-white/10 rounded-lg border border-white/20">
                            <span class="text-[10px] text-white font-bold uppercase tracking-widest">Protocol
                                Active</span>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-2 gap-8">
                        <!-- Primary Directive -->
                        <div class="glass-panel p-6 rounded-xl border-l-4 border-l-red-500">
                            <h4 class="font-bold text-red-400 text-sm uppercase tracking-widest mb-4">MANDATORY SCRIPT:
                                RIGHT TO SILENCE</h4>
                            <div
                                class="bg-black/40 p-5 rounded-lg border border-white/5 font-serif text-lg leading-relaxed text-white italic">
                                "Officer, I am exercising my right to remain silent. I do not consent to any searches. I
                                will provide my name and address as required by law, but I will not answer any further
                                questions without my legal counsel present."
                            </div>
                            <p class="text-[10px] text-slate-400 mt-4 uppercase font-bold">* Australian Common Law Right
                                - Do Not Waive.</p>
                        </div>

                        <!-- Strategic Rebuttal -->
                        <div class="glass-panel p-6 rounded-xl border-l-4 border-l-executive-gold">
                            <h4 class="font-bold text-executive-gold text-sm uppercase tracking-widest mb-4">DEFENCE
                                ANCHOR: PROUDMAN v DAYMAN</h4>
                            <p class="text-sm text-slate-300 leading-relaxed">
                                If questioned about your licence status, present the <strong>VicRoads Letter (24 Sep
                                    2025)</strong>.
                            </p>
                            <div class="mt-4 p-4 bg-white/5 rounded border border-white/10 text-xs text-slate-400">
                                <em>"Based on official correspondence from VicRoads dated 24 September, I have an honest
                                    and reasonable belief that my driving privileges are fully restored. Any discrepancy
                                    is a systemic administrative failure, not a criminal act."</em>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-3 gap-6">
                    <div class="glass-panel p-6 rounded-xl">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">PSC Reference
                        </h4>
                        <p class="text-2xl font-mono text-white">250310</p>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Cite this for ongoing harassment</p>
                    </div>
                    <div class="glass-panel p-6 rounded-xl">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3">Last 5 Stops
                        </h4>
                        <p class="text-2xl font-mono text-white">09 FEB 2026</p>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Most recent incident logged</p>
                    </div>
                    <div class="glass-panel p-6 rounded-xl border border-emerald-500/20">
                        <h4 class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest mb-3">Action
                            Required</h4>
                        <p class="text-xs text-emerald-400 leading-relaxed">Ensure dashcam is recording and synchronized
                            to evidence vault immediately.</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: DASHBOARD (EXECUTIVE BRIEFING) -->
            <div id="view-dashboard" class="view-panel animate-fade-in space-y-10">
                <!-- Global Briefing Card (Dynamic) -->
                <div class="glass-panel p-8 rounded-2xl executive-border relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-executive-gold/5 blur-[100px] -mr-32 -mt-32"></div>

                    <div class="flex justify-between items-start mb-8">
                        <div>
                            <h3 class="font-serif text-3xl font-bold text-white mb-2">Global Briefing</h3>
                            <p class="text-xs text-executive-gold font-bold uppercase tracking-[0.3em]">AI-Generated
                                Strategic Summary</p>
                        </div>
                        <div class="flex gap-2">
                            <span
                                class="px-3 py-1 bg-white/5 rounded-full border border-white/10 text-[9px] font-bold text-slate-400 uppercase">Live
                                Context</span>
                        </div>
                    </div>

                    <div id="ai-global-summary"
                        class="grid md:grid-cols-2 gap-12 text-slate-300 leading-relaxed text-sm">
                        <div class="space-y-4">
                            <p class="border-l-2 border-executive-gold pl-4 py-1 italic text-slate-400">Initializing
                                intelligence engine for 'Police v Deshpande'...</p>
                            <div class="flex items-center gap-3 text-executive-gold animate-pulse">
                                <i class="fa-solid fa-spinner fa-spin"></i>
                                <span class="text-[10px] font-bold uppercase tracking-widest">Awaiting Google Drive
                                    Sync</span>
                            </div>
                        </div>
                        <div class="glass-panel p-6 rounded-xl bg-white/[0.02]">
                            <h4
                                class="font-bold text-white text-xs uppercase tracking-widest mb-4 flex items-center gap-2">
                                <i class="fa-solid fa-bolt text-executive-gold"></i> Strategic Priorities
                            </h4>
                            <ul class="space-y-3 text-xs">
                                <li class="flex items-start gap-3">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-executive-gold mt-1.5 flex-shrink-0"></span>
                                    <span>Establish <strong>Proudman v Dayman</strong> defense via 24 Sep Letter.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-executive-gold mt-1.5 flex-shrink-0"></span>
                                    <span>Formalize PSC Complaint <strong>#250310</strong> as counter-offensive.</span>
                                </li>
                                <li class="flex items-start gap-3">
                                    <span
                                        class="w-1.5 h-1.5 rounded-full bg-executive-gold mt-1.5 flex-shrink-0"></span>
                                    <span>Consolidate all 5 harassments into single "Abuse of Process" filing.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Strategic KPIs -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1">Primary Objective
                        </p>
                        <h4
                            class="text-xl font-serif font-bold text-white group-hover:text-executive-gold transition-colors">
                            Diversion Order</h4>
                        <div class="mt-4 w-full bg-white/5 h-1 rounded-full overflow-hidden">
                            <div class="bg-executive-gold w-[65%] h-full"></div>
                        </div>
                        <p class="text-[9px] text-slate-500 mt-2 text-right">65% Strategic Readiness</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1">Harassment Index
                        </p>
                        <h4 class="text-xl font-serif font-bold text-red-400">5 Intercepts</h4>
                        <p class="text-[9px] text-slate-500 mt-2">Jan 07 – Feb 09 (33 Day Window)</p>
                    </div>
                    <div class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group">
                        <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest mb-1">Career Integrity
                        </p>
                        <h4 class="text-xl font-serif font-bold text-white">APRA Secure</h4>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Fit & Proper Milestone</p>
                    </div>
                    <div
                        class="glass-panel p-6 rounded-2xl hover:bg-white/5 transition-colors group border border-emerald-500/20">
                        <p
                            class="text-[9px] font-bold text-emerald-500 uppercase tracking-widest mb-1 focus:outline-none">
                            Asset Status</p>
                        <h4 class="text-xl font-serif font-bold text-white">CAR RECOVERED</h4>
                        <p class="text-[9px] text-slate-500 mt-2 uppercase">Released: No Fee / No Record</p>
                    </div>
                </div>
            </div>

            <!-- VIEW: CHRONOLOGY ENGINE -->
            <div id="view-chronology" class="view-panel hidden animate-fade-in space-y-6">
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5">
                    <div class="p-8 border-b border-white/5 bg-white/[0.02]">
                        <h3 class="font-serif font-bold text-2xl text-white">Forensic Timeline</h3>
                        <p class="text-slate-500 text-sm mt-1">Unified Chronological Engine: 2025 Hardship to 2026
                            Targeted Action.</p>
                    </div>
                    <div class="p-10 relative">
                        <div class="timeline-connector"></div>

                        <!-- 2025: The Origins of Hardship -->
                        <div class="relative pl-12 mb-10 group">
                            <div
                                class="absolute left-[18px] top-0 w-3 h-3 bg-slate-600 rounded-full z-10 border-2 border-executive-navy">
                            </div>
                            <span class="font-mono text-[10px] text-slate-500 mb-1 block uppercase tracking-widest">08
                                Mar 2025</span>
                            <h4 class="font-bold text-slate-300">Redundancy Enacted</h4>
                            <p class="text-xs text-slate-500 mt-1">Employment terminated. Trigger for financial
                                instability and reliance on vehicle for income.</p>
                        </div>

                        <div class="relative pl-12 mb-10 group">
                            <div
                                class="absolute left-[18px] top-0 w-3 h-3 bg-slate-600 rounded-full z-10 border-2 border-executive-navy">
                            </div>
                            <span class="font-mono text-[10px] text-slate-500 mb-1 block uppercase tracking-widest">30
                                Apr 2025</span>
                            <h4 class="font-bold text-slate-300">Loss of Tenancy</h4>
                            <p class="text-xs text-slate-500 mt-1">Rental accommodation lost. Explains failure to
                                receive subsequent postal notices.</p>
                        </div>

                        <!-- 20 Sep: Burnley -->
                        <div class="relative pl-12 mb-10 group">
                            <div
                                class="absolute left-[16px] top-0 w-4 h-4 bg-red-600 rounded-full z-10 border-2 border-executive-navy shadow-lg shadow-red-900/20">
                            </div>
                            <span
                                class="font-mono text-[10px] text-red-500 font-bold mb-1 block uppercase tracking-widest">20
                                Sep 2025 • Burnley Incident</span>
                            <h4 class="font-bold text-white">Police Intercept (Monash Fwy)</h4>
                            <div
                                class="mt-3 p-4 bg-red-950/20 border border-red-500/20 rounded-xl text-xs text-slate-400">
                                <p><strong>Charges:</strong> Drive Suspended (s30(1)) + Drug Driving (Meth).</p>
                                <p class="text-[10px] mt-2 text-red-400 font-bold uppercase">Critical: Counts 2 & 3
                                    missing from Brief.</p>
                            </div>
                        </div>

                        <!-- 24 Sep: VicRoads Letter -->
                        <div class="relative pl-12 mb-10 group">
                            <div
                                class="absolute left-[16px] top-0 w-4 h-4 bg-executive-gold rounded-full z-10 border-2 border-executive-navy shadow-lg shadow-executive-gold/20">
                            </div>
                            <span
                                class="font-mono text-[10px] text-executive-gold font-bold mb-1 block uppercase tracking-widest">24
                                Sep 2025 • Defence Anchor</span>
                            <h4 class="font-bold text-white">VicRoads Letter Issued</h4>
                            <p class="text-sm text-slate-300 italic mt-1 font-serif">"Directions ended on 24 September
                                2025"</p>
                            <p class="text-[10px] text-slate-500 mt-2 uppercase font-bold tracking-tighter">Establishes
                                "Honest and Reasonable Mistake of Fact"</p>
                        </div>

                        <!-- 2026 HARASSMENT BLOCK -->
                        <div class="relative pl-12 py-8 my-8 bg-white/[0.01] -ml-12 border-y border-white/5">
                            <div
                                class="absolute right-6 top-4 text-[9px] font-bold text-slate-600 uppercase tracking-[0.2em]">
                                Targeted Phase (Jan-Feb 2026)</div>
                            <div class="absolute left-[24px] top-0 bottom-0 w-[1px] bg-red-500/20 z-0"></div>

                            <div class="relative mb-8">
                                <div
                                    class="absolute left-[18px] top-0 w-3 h-3 bg-executive-navy rounded-full z-10 border border-slate-700 shadow-[0_0_10px_rgba(255,255,255,0.1)]">
                                </div>
                                <span
                                    class="font-mono text-[10px] text-executive-gold font-bold mb-1 block uppercase tracking-widest">21
                                    Jan 2026 • Court Event</span>
                                <h4 class="font-bold text-white">Original Listed Hearing</h4>
                                <p class="text-xs text-slate-500 mt-1">Burnley Matters. Melbourne Magistrates' Court.
                                </p>
                            </div>

                            <div class="relative mb-8">
                                <div
                                    class="absolute left-[16px] top-0 w-4 h-4 bg-red-600 rounded-full z-10 border-2 border-executive-navy shadow-lg shadow-red-900/40">
                                </div>
                                <span
                                    class="font-mono text-[10px] text-red-500 font-bold mb-1 block uppercase tracking-widest">09
                                    Feb 2026 • 20:30</span>
                                <h4 class="font-bold text-white uppercase tracking-tight">Stop #5 (Inland Seizure)</h4>
                                <p class="text-xs text-slate-400 mt-1 leading-relaxed">Impounded without cause. Officer:
                                    "We don't think you are on drugs but who knows."</p>
                            </div>

                            <div class="relative mb-8">
                                <div
                                    class="absolute left-[16px] top-0 w-4 h-4 bg-emerald-500 rounded-full z-10 border-2 border-executive-navy shadow-lg shadow-emerald-500/20">
                                </div>
                                <span
                                    class="font-mono text-[10px] text-emerald-500 font-bold mb-1 block uppercase tracking-widest">09
                                    Feb 2026 • 22:45</span>
                                <h4 class="font-bold text-white uppercase tracking-tight">Vehicle Recovery (Box Hill PS)
                                </h4>
                                <p class="text-xs text-slate-400 mt-1 leading-relaxed">Released without fee, signature,
                                    or interrogation. Confirms lack of evidentiary basis for seizure.</p>
                            </div>

                            <div class="relative">
                                <div
                                    class="absolute left-[16px] top-0 w-4 h-4 bg-emerald-500 rounded-full z-10 border-2 border-executive-navy shadow-lg shadow-emerald-500/20 animate-pulse">
                                </div>
                                <span
                                    class="font-mono text-[10px] text-emerald-500 font-bold mb-1 block uppercase tracking-widest">23
                                    Feb 2026 • Upcoming</span>
                                <h4 class="font-bold text-white">Consolidated Mention Date</h4>
                                <p class="text-xs text-slate-500 mt-1 uppercase font-bold tracking-widest">Target:
                                    Diversion Order Approval.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: POLICE CONDUCT UNIT -->
            <div id="view-harassment" class="view-panel hidden animate-fade-in space-y-8">
                <div
                    class="glass-panel border-l-4 border-l-emerald-500 rounded-2xl p-8 flex justify-between items-center group">
                    <div>
                        <h4 class="font-serif text-2xl font-bold text-white flex items-center gap-3">
                            <i
                                class="fa-solid fa-file-shield text-emerald-500 transition-transform group-hover:scale-110"></i>
                            Formal PSC Complaint Active
                        </h4>
                        <p class="text-slate-500 text-sm mt-1">Professional Standards Command | Reference: 250310</p>
                        <div class="mt-4 flex gap-4">
                            <span
                                class="px-3 py-1 bg-white/5 rounded border border-white/10 font-mono text-[10px] text-emerald-400 uppercase font-bold">Status:
                                Logged</span>
                            <span
                                class="px-3 py-1 bg-white/5 rounded border border-white/10 font-mono text-[10px] text-slate-400 uppercase font-bold tracking-tighter">Dated:
                                Feb 9, 2026</span>
                        </div>
                    </div>
                    <div
                        class="w-16 h-16 rounded-full bg-emerald-500/10 border border-emerald-500/20 flex items-center justify-center text-emerald-500 shadow-inner">
                        <i class="fa-solid fa-check-double text-2xl"></i>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-panel rounded-2xl p-8 border border-white/5">
                        <h3 class="font-serif text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-quote-left text-executive-gold"></i> ADMISSIBLE QUOTES
                        </h3>
                        <div class="space-y-6">
                            <div class="p-5 bg-white/[0.02] border-l-2 border-slate-700 rounded-r-lg">
                                <p class="text-sm text-slate-300 italic">"We don't care what happened with the other
                                    officer before."</p>
                                <p class="text-[10px] text-slate-500 mt-3 uppercase font-bold tracking-widest">Evidence
                                    of systemic disregard for patterns</p>
                            </div>
                            <div class="p-5 bg-white/[0.02] border-l-2 border-slate-700 rounded-r-lg">
                                <p class="text-sm text-slate-300 italic">"We don't think you are on drugs but who knows
                                    you might be on it."</p>
                                <p class="text-[10px] text-slate-500 mt-3 uppercase font-bold tracking-widest">Admits
                                    lack of Reasonable Suspicion</p>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-8 border border-white/5">
                        <h3 class="font-serif text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-shield-halved text-executive-gold"></i> COUNTER-STRATEGY
                        </h3>
                        <div class="grid gap-4">
                            <div class="flex items-start gap-4 p-4 hover:bg-white/[0.03] transition-colors rounded-xl group cursor-help"
                                title="Immediate Escalation Strategy">
                                <div
                                    class="w-8 h-8 rounded-lg bg-executive-gold/10 border border-executive-gold/20 flex items-center justify-center text-executive-gold flex-shrink-0">
                                    <i class="fa-solid fa-gavel text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h5 class="text-xs font-bold text-white uppercase tracking-widest">PSC Escalation
                                    </h5>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">Escalate 5-stop pattern
                                        to IBAC if PSC review fails to address harassment.</p>
                                </div>
                            </div>
                            <div
                                class="flex items-start gap-4 p-4 hover:bg-white/[0.03] transition-colors rounded-xl group">
                                <div
                                    class="w-8 h-8 rounded-lg bg-executive-gold/10 border border-executive-gold/20 flex items-center justify-center text-executive-gold flex-shrink-0">
                                    <i class="fa-solid fa-file-contract text-xs"></i>
                                </div>
                                <div class="flex-1">
                                    <h5 class="text-xs font-bold text-white uppercase tracking-widest">Formal Notice
                                    </h5>
                                    <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">Serve 'Notice of Intent
                                        to Claim Damages' for loss of income during impound.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: TRUTH MATRIX -->
            <div id="view-matrix" class="view-panel hidden animate-fade-in">
                <div class="glass-panel rounded-2xl overflow-hidden border border-white/5 shadow-2xl">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="bg-white/[0.03] border-b border-white/10">
                                <th
                                    class="px-8 py-6 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] w-1/3">
                                    Police Allegation</th>
                                <th
                                    class="px-8 py-6 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] w-1/3">
                                    Forensic Reality</th>
                                <th
                                    class="px-8 py-6 text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em] w-1/3">
                                    Evidence Key</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-white/5">
                            <tr class="group hover:bg-white/[0.01] transition-colors">
                                <td class="px-8 py-6 text-sm text-slate-300">"Random Roadside Testing"</td>
                                <td class="px-8 py-6">
                                    <span
                                        class="text-xs font-bold text-executive-gold uppercase tracking-widest">Targeted
                                        Phase</span>
                                    <p class="text-[10px] text-slate-500 mt-1">High-frequency intercepts with no
                                        probable cause.</p>
                                </td>
                                <td class="px-8 py-6">
                                    <span
                                        class="px-2 py-1 bg-white/5 rounded font-mono text-[9px] text-slate-500 border border-white/5 uppercase">Log-2026-X5</span>
                                </td>
                            </tr>
                            <tr class="group hover:bg-white/[0.01] transition-colors">
                                <td class="px-8 py-6 text-sm text-slate-300">"Refusal indicates guilt"</td>
                                <td class="px-8 py-6">
                                    <span class="text-xs font-bold text-executive-gold uppercase tracking-widest">Mental
                                        Exhaustion</span>
                                    <p class="text-[10px] text-slate-500 mt-1">Direct result of systemic harassment
                                        fatigue.</p>
                                </td>
                                <td class="px-8 py-6">
                                    <span
                                        class="px-2 py-1 bg-white/5 rounded font-mono text-[9px] text-slate-500 border border-white/5 uppercase">PSC-LOG-250310</span>
                                </td>
                            </tr>
                            <tr class="group hover:bg-white/[0.01] transition-colors text-emerald-400/80">
                                <td class="px-8 py-6 text-sm">"Necessary Seizure for Safety"</td>
                                <td class="px-8 py-6">
                                    <span class="text-xs font-bold uppercase tracking-widest">Abuse of Discretion</span>
                                    <p class="text-[10px] mt-1">Immediate, no-fee release proves seizure was punitive,
                                        not evidentiary.</p>
                                </td>
                                <td class="px-8 py-6">
                                    <span
                                        class="px-2 py-1 bg-emerald-500/10 rounded font-mono text-[9px] border border-emerald-500/20 uppercase">BoxHill-RECOVERY</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>


            <!-- VIEW: FORENSIC FINANCIALS -->
            <div id="view-financial" class="view-panel hidden animate-fade-in space-y-8">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-panel rounded-2xl p-8 border border-white/5 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-red-600/5 blur-[60px] -mr-16 -mt-16"></div>
                        <h3 class="font-serif text-xl font-bold text-white mb-6 flex items-center gap-3">
                            <i class="fa-solid fa-file-invoice-dollar text-executive-gold"></i> Financial Hardship
                            Analysis
                        </h3>
                        <div class="space-y-4">
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Employment Status</span>
                                <span class="text-red-400 font-bold text-xs uppercase">Redundant (Mar 2025)</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Primary Support</span>
                                <span class="text-slate-300 font-mono text-xs">Centrelink Payments</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Supplementary
                                    Income</span>
                                <span class="text-slate-300 font-mono text-xs">Gig Economy (Uber/DiDi)</span>
                            </div>
                            <div class="flex justify-between border-b border-white/5 pb-3">
                                <span class="text-slate-500 text-xs uppercase tracking-widest">Asset Status</span>
                                <span class="text-red-400 font-bold text-xs uppercase">Seized (Sole Income Tool)</span>
                            </div>
                        </div>
                    </div>
                    <div class="glass-panel rounded-2xl p-8 border border-red-500/10 bg-red-950/5">
                        <h3 class="font-serif text-xl font-bold text-red-500 mb-6">The Cost of Impoundment</h3>
                        <div class="space-y-6">
                            <p class="text-xs text-slate-400 leading-relaxed uppercase tracking-tighter">
                                The impoundment cycle imposes an immediate and catastrophic financial barrier to
                                justice.
                            </p>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-white/5 rounded-xl border border-white/5">
                                    <p class="text-[9px] text-slate-500 uppercase font-bold mb-1">Nov 03 Fee</p>
                                    <p class="text-lg font-mono text-slate-300">$999.00</p>
                                </div>
                                <div class="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/20">
                                    <p class="text-[9px] text-emerald-400 uppercase font-bold mb-1">Feb 09 Recovery</p>
                                    <p class="text-lg font-mono text-emerald-500">$0.00</p>
                                </div>
                            </div>
                            <div class="p-5 bg-white/[0.02] border-t border-white/5 flex justify-between items-center">
                                <span class="text-xs text-slate-500 font-bold uppercase tracking-widest">Aggregate
                                    Direct Penalty</span>
                                <span class="text-xl font-mono text-white">~$2,054.00</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: EVIDENCE VAULT -->
            <div id="view-files" class="view-panel hidden animate-fade-in space-y-8">
                <div
                    class="glass-panel rounded-2xl overflow-hidden border border-white/5 min-h-[600px] flex flex-col shadow-2xl">
                    <div class="p-8 border-b border-white/10 bg-white/[0.03] flex justify-between items-center">
                        <div>
                            <h3 class="font-serif text-2xl font-bold text-white tracking-tight">Evidentiary Vault</h3>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-1">Digitized
                                Forensic Exhibits | Level 5 Access</p>
                        </div>
                        <div
                            class="px-4 py-2 bg-red-950/20 border border-red-500/20 rounded text-[9px] font-bold text-red-400 uppercase tracking-widest">
                            Privileged</div>
                    </div>

                    <div class="flex flex-1 overflow-hidden flex-col md:flex-row">
                        <!-- File Selection for Mobile -->
                        <div class="md:hidden p-4 bg-executive-navy border-b border-white/10">
                            <select onchange="showDoc(this.value.replace('exhibit-', ''), event)" aria-label="Select Exhibit"
                                class="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-2 text-xs text-white focus:outline-none focus:border-executive-gold">
                                <option value="exhibit-a">Exhibit A: VicRoads Letter</option>
                                <option value="exhibit-b">Exhibit B: Charge Sheet Burnley</option>
                                <option value="exhibit-c">Exhibit C: Charge Sheet Oakleigh</option>
                                <option value="exhibit-e">Exhibit E: PSC Complaint</option>
                            </select>
                            <div class="mt-4">
                                <h4 class="text-[9px] font-bold text-slate-500 uppercase mb-3 tracking-[0.2em]">Live Ingestion</h4>
                                <div class="file-list space-y-2">
                                    <!-- Google Drive files and local uploads appear here -->
                                </div>
                                <div id="drop-zone-mobile" role="button" tabindex="0" aria-label="Upload local forensic files"
                                    class="drop-zone mt-4 p-4 border-2 border-dashed border-white/5 rounded-xl text-center cursor-pointer hover:bg-white/5 transition-colors">
                                    <i class="fa-solid fa-cloud-arrow-up text-slate-500 mb-2"></i>
                                    <p class="text-[10px] text-slate-500">Add local forensic data</p>
                                </div>
                            </div>
                        </div>

                        <!-- File Tree -->
                        <aside
                            class="w-72 bg-executive-navy/50 border-r border-white/5 p-6 flex-shrink-0 hidden md:block">
                            <h4 class="text-[9px] font-bold text-slate-600 uppercase mb-6 tracking-[0.2em]">Inventory
                                Index</h4>
                            <div class="space-y-2">
                                <button onclick="showDoc('exhibit-a', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all active-doc-btn border border-transparent">
                                    <i class="fa-solid fa-file-pdf text-red-500 text-sm"></i> Exhibit A: VicRoads Letter
                                </button>
                                <button onclick="showDoc('exhibit-b', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all border border-transparent">
                                    <i class="fa-solid fa-file-invoice w-3.5 text-center"></i> Charge Sheet: Burnley
                                </button>
                                <button onclick="showDoc('exhibit-c', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-slate-400 hover:text-white hover:bg-white/5 rounded-xl flex items-center gap-3 transition-all border border-transparent">
                                    <i class="fa-solid fa-file-invoice w-3.5 text-center"></i> Charge Sheet: Oakleigh
                                </button>
                                <button onclick="showDoc('exhibit-e', event)"
                                    class="doc-btn w-full text-left px-4 py-3 text-[10px] font-bold text-emerald-500/80 hover:text-emerald-400 hover:bg-emerald-500/5 rounded-xl flex items-center gap-3 transition-all border border-emerald-500/20">
                                    <i class="fa-solid fa-scale-balanced text-sm"></i> Exhibit E: PSC Complaint
                                </button>
                            </div>

                            <div class="mt-8 border-t border-white/5 pt-6">
                                <h4 class="text-[9px] font-bold text-slate-600 uppercase mb-4 tracking-[0.2em]">Live
                                    Ingestion</h4>
                                <div id="file-list" class="file-list space-y-2">
                                    <!-- Google Drive files and local uploads appear here -->
                                </div>
                                <div id="drop-zone" role="button" tabindex="0" aria-label="Upload local forensic files"
                                    class="drop-zone mt-4 p-4 border-2 border-dashed border-white/5 rounded-xl text-center cursor-pointer hover:bg-white/5 transition-colors">
                                    <i class="fa-solid fa-cloud-arrow-up text-slate-500 mb-2"></i>
                                    <p class="text-[10px] text-slate-500">Add local forensic data</p>
                                    <input type="file" id="file-input" class="hidden" multiple aria-label="Upload local forensic files"
                                        onchange="handleFiles(this.files)">
                                </div>
                            </div>
                        </aside>

                        <!-- Document Viewer -->
                        <div class="flex-1 bg-black/40 p-10 overflow-y-auto relative custom-scrollbar">


                            <!-- Exhibit A -->
                            <div id="doc-exhibit-a"
                                class="doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <div class="flex justify-between items-start mb-8">
                                    <div class="font-bold text-xl tracking-tighter">vicroads</div>
                                    <div class="text-right text-xs">
                                        <p>Date of issue: 24 September 2025</p>
                                        <p>Licence/Customer number: 098034950</p>
                                    </div>
                                </div>
                                <div class="mb-8 font-mono text-sm">
                                    <p>Mr Vikram Deshpande</p>
                                    <p>48 516 Toorak Rd</p>
                                    <p>TOORAK VIC 3142</p>
                                </div>
                                <div class="border-b-2 border-black mb-6"></div>
                                <h2 class="font-bold text-lg mb-4">Ending of the suspension and other Directions on
                                    your
                                    driver licence(s)</h2>
                                <p class="text-sm mb-6 leading-relaxed">
                                    Fines Victoria has notified the Transport Secretary to end the Directions issued
                                    for
                                    the unpaid Fines.
                                </p>
                                <div class="bg-yellow-100 p-4 border border-yellow-300 mb-6">
                                    <p class="font-bold text-sm">These Directions ended on 24 September 2025.</p>
                                </div>
                                <p class="text-sm font-bold mb-2">What does this mean for your driver licence(s)?
                                </p>
                                <ol class="list-decimal ml-5 text-sm space-y-2 mb-8">
                                    <li>The suspension of your driver licence(s) has ended.</li>
                                    <li>You can be granted a driver licence subject to eligibility criteria.</li>
                                    <li>You can renew your driver licence.</li>
                                </ol>
                                <div class="doc-watermark">EXHIBIT A</div>
                            </div>

                            <!-- Exhibit B: Burnley Charge Sheet -->
                            <div id="doc-exhibit-b"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <div class="text-center font-bold border-b-2 border-black pb-2 mb-6">CHARGE-SHEET
                                    AND
                                    SUMMONS</div>
                                <div class="grid grid-cols-2 gap-4 text-xs font-mono mb-6">
                                    <div>
                                        <p><strong>Accused:</strong> Vikram Sandip DESHPANDE</p>
                                        <p><strong>DOB:</strong> 24/10/1985</p>
                                        <p><strong>Address:</strong> Toorak VIC 3142</p>
                                    </div>
                                    <div class="text-right">
                                        <p><strong>Date of Offence:</strong> 20 Sep 2025</p>
                                        <p><strong>Informant:</strong> SC Osman KAYNAK 43568</p>
                                        <p><strong>Station:</strong> Melb Highway Patrol</p>
                                    </div>
                                </div>
                                <div class="border border-black p-4 mb-4">
                                    <p class="font-bold mb-2">Charge 1: Drive Suspended</p>
                                    <p class="text-sm">The accused at Burnley on the 20th of September 2025 did
                                        drive a
                                        motor vehicle on a highway namely Monash Freeway while the authorisation
                                        granted
                                        to him to do so was suspended.</p>
                                    <p class="text-xs mt-2"><em>Road Safety Act No. 127/1986 s.30(1)</em></p>
                                </div>
                                <div class="p-4 bg-red-50 border border-red-200 text-red-800 text-xs mb-4">
                                    <strong>DEFENCE NOTE:</strong> Counts 2 & 3 are missing from this brief.
                                    Procedural
                                    defect flagged.
                                </div>
                                <div class="doc-watermark">EXHIBIT B</div>
                            </div>

                            <!-- Exhibit C: Oakleigh Charge Sheet -->
                            <div id="doc-exhibit-c"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <div class="text-center font-bold border-b-2 border-black pb-2 mb-6">CONTINUATION OF
                                    CHARGES</div>
                                <div class="grid grid-cols-2 gap-4 text-xs font-mono mb-6">
                                    <div>
                                        <p><strong>Accused:</strong> Vikram DESHPANDE</p>
                                        <p><strong>Location:</strong> Oakleigh</p>
                                    </div>
                                    <div class="text-right">
                                        <p><strong>Date of Offence:</strong> 03/11/2025</p>
                                        <p><strong>Informant:</strong> SC Shane MAY 41294</p>
                                        <p><strong>Station:</strong> Prahran HWP</p>
                                    </div>
                                </div>
                                <div class="border border-black p-4 mb-4">
                                    <p class="font-bold mb-2">Charge 2: Oral Fluid (Meth)</p>
                                    <p class="text-sm">...did within 3 hours after driving... provide a sample...
                                        found
                                        methylamphetamine present...</p>
                                    <p class="text-xs mt-2"><em>Road Safety Act s.49(1)(h)</em></p>
                                </div>
                                <div class="border border-black p-4 mb-4">
                                    <p class="font-bold mb-2">Charge 3: Drive with Drugs (Meth)</p>
                                    <p class="text-sm">...did drive a motor vehicle while more than the prescribed
                                        concentration of drugs was present...</p>
                                    <p class="text-xs mt-2"><em>Road Safety Act s.49(1)(bb)</em></p>
                                </div>
                                <div class="doc-watermark">EXHIBIT C</div>
                            </div>

                            <!-- Exhibit D: Fines Vic Summary -->
                            <div id="doc-exhibit-d"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <h2 class="font-bold text-lg mb-4 text-center">Fines Victoria Summary Report</h2>
                                <p class="text-center text-xs text-slate-500 mb-6">Generated: 22 Nov 2025 | Debtor
                                    ID:
                                    53091225</p>
                                <div class="border-t border-b border-black py-4 mb-4">
                                    <div class="flex justify-between font-bold">
                                        <span>Total Amount Due:</span>
                                        <span>$10,841.70</span>
                                    </div>
                                </div>
                                <table class="w-full text-xs text-left mb-6">
                                    <thead>
                                        <tr class="border-b border-black">
                                            <th class="py-2">Vehicle</th>
                                            <th class="py-2">Offence</th>
                                            <th class="py-2 text-right">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-slate-200">
                                        <tr>
                                            <td class="py-2 font-mono">CQP971</td>
                                            <td class="py-2">FAIL TO OBEY TRAFFIC LIGHTS</td>
                                            <td class="py-2 text-right">$467.00</td>
                                        </tr>
                                        <tr>
                                            <td class="py-2 font-mono">CQP971</td>
                                            <td class="py-2">EXCEED SPEED BY &lt; 10KM/H</td>
                                            <td class="py-2 text-right">$342.00</td>
                                        </tr>
                                        <!-- Add more rows as needed based on data -->
                                    </tbody>
                                </table>
                                <div class="p-4 bg-amber-50 border border-amber-200 text-amber-800 text-xs">
                                    <strong>ANALYSIS:</strong> 75.1% of debt is attributed to CQP971 and YQH104
                                    ("Zombie
                                    Debt").
                                </div>
                                <div class="doc-watermark">EXHIBIT D</div>
                            </div>

                            <!-- Exhibit E: Formal Complaint Letter (NEW) -->
                            <div id="doc-exhibit-e"
                                class="hidden doc-sheet max-w-2xl mx-auto p-12 min-h-[800px] relative text-slate-800">
                                <div class="text-right text-xs text-slate-500 mb-8">Ref: 250310 | Date: 09 Feb 2026
                                </div>
                                <h2 class="font-bold text-lg mb-2 text-center uppercase border-b pb-4">Formal
                                    Complaint:
                                    Systemic Harassment & Abuse of Process</h2>

                                <div class="text-xs font-mono mb-6 space-y-1">
                                    <p><strong>To:</strong> Officer in Charge, Professional Standards Command</p>
                                    <p><strong>From:</strong> Vikram Sandip Deshpande</p>
                                    <p><strong>Subject:</strong> Harassment, Discretionary Failure, Procedural
                                        Unfairness (Jan–Feb 2026)</p>
                                </div>

                                <div class="space-y-4 text-sm leading-relaxed">
                                    <p><strong>1. INTRODUCTION</strong><br>
                                        I, Vikram Deshpande, formally lodge this complaint regarding a pattern of
                                        systemic, targeted harassment by Victoria Police between 07 Jan 2026 and 09
                                        Feb
                                        2026. This complaint arises from a statistically improbable frequency of
                                        intercepts (5 stops in 33 days) lacking reasonable suspicion.</p>

                                    <p><strong>2. DETAILS OF ALLEGATION</strong><br>
                                        Since 07 Jan 2026, I have been subjected to a relentless campaign of vehicle
                                        intercepts:<br>
                                        - 07 Jan: Negative Alcohol<br>
                                        - 19 Jan: Negative Alcohol<br>
                                        - 21 Jan: Negative Alcohol<br>
                                        - 01 Feb: Negative Alcohol<br>
                                        - 09 Feb: Negative Alcohol. <strong>Vehicle Seized misuse of power.</strong></p>

                                    <p><strong>3. EVIDENTIARY UPDATE (Box Hill PS)</strong><br>
                                        The vehicle was released at 22:45 on 09 Feb 2026 without any fee, paperwork, or
                                        interrogation. This immediate release confirms that the seizure served no
                                        legitimate investigative purpose and was intended solely to cause professional
                                        and personal frustration.</p>

                                    <p><strong>3. IMPACT STATEMENT</strong><br>
                                        As a Centrelink recipient, my vehicle is my only tool of trade (Uber/DiDi).
                                        By
                                        impounding my car, Victoria Police has effectively terminated my employment
                                        and
                                        imposed a punitive financial sanction (~$1,055) exceeding my ability to pay.
                                    </p>

                                    <p><strong>4. DESIRED OUTCOMES</strong><br>
                                        - Immediate cessation of targeted vehicle flagging.<br>
                                        - Review of the decision to impound on 09 Feb given the lack of reasonable
                                        suspicion.<br>
                                        - Internal audit of LEAP database access logs.</p>
                                </div>
                                <div class="mt-8 pt-4 border-t border-slate-300 text-xs italic">
                                    Signed: Vikram Sandip Deshpande (Electronic Submission)
                                </div>
                                <div class="doc-watermark text-emerald-50/10">FILED</div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: LEGAL/TOX -->
            <div id="view-legal" class="view-panel hidden animate-fade-in space-y-10">
                <div class="grid md:grid-cols-2 gap-8">
                    <div class="glass-panel p-8 rounded-2xl border border-white/5">
                        <div class="flex justify-between items-center mb-8">
                            <div>
                                <h3 class="font-serif text-2xl font-bold text-white tracking-tight">Toxicological
                                    Engineering</h3>
                                <p class="text-[9px] text-executive-gold font-bold uppercase tracking-widest mt-1">
                                    Pharmacological Impairment vs Residual Presence</p>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 280px;">
                            <canvas id="toxChart"></canvas>
                        </div>
                        <div class="mt-8 p-6 bg-executive-gold/5 border-l-2 border-executive-gold rounded-r-xl">
                            <p class="text-xs text-slate-400 leading-relaxed italic">
                                "A positive oral fluid test at 48 hours indicates inactive metabolites in subcutaneous
                                tissue, not pharmacological impairment. The absence of a corroborating blood test at the
                                peak window is an evidentiary failure of the Prosecution."
                            </p>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div class="glass-panel p-8 rounded-2xl border border-white/5 relative">
                            <h4
                                class="text-xs font-bold text-white uppercase tracking-widest mb-6 flex items-center gap-3">
                                <i class="fa-solid fa-scale-balanced text-executive-gold"></i> STRATEGIC PRECEDENTS
                            </h4>
                            <div class="space-y-8">
                                <div class="group">
                                    <h5
                                        class="font-serif text-lg font-bold text-white group-hover:text-executive-gold transition-colors underline decoration-white/10 underline-offset-8">
                                        Proudman v Dayman (1941)</h5>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-3">High
                                        Court of Australia | 67 CLR 536</p>
                                    <p class="text-xs text-slate-400 mt-3 leading-relaxed">
                                        The pivotal defence for strict liability traffic offences. Establishes that an
                                        honest and reasonable belief in a state of facts renders the act innocent.
                                    </p>
                                    <div
                                        class="mt-4 p-4 bg-white/[0.02] border border-white/5 rounded-lg text-[10px] text-slate-500">
                                        <strong class="text-executive-gold uppercase tracking-tighter">Tactical
                                            Application:</strong> The VicRoads 'Directions Ended' letter (24 Sep)
                                        directly induced the reasonable belief of license validity.
                                    </div>
                                </div>
                                <div class="group">
                                    <h5
                                        class="font-serif text-lg font-bold text-white group-hover:text-executive-gold transition-colors underline decoration-white/10 underline-offset-8">
                                        Criminal Procedure Act 2009 (s 59)</h5>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest mt-3">
                                        Legislative Diversion Framework</p>
                                    <p class="text-xs text-slate-400 mt-3 leading-relaxed">
                                        A discretionary pathway allowing the court to acknowledge remorse and low
                                        recidivism risk without entering a conviction.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 rounded-2xl border border-red-500/20 bg-red-950/5/5">
                            <p class="text-[10px] font-bold text-red-400 uppercase tracking-widest mb-2">APRA CPS 520
                                TERMINATION RISK</p>
                            <p class="text-xs text-slate-400 leading-relaxed font-medium">
                                Direct reporting obligations to the Australian Prudential Regulation Authority.
                                <span class="text-white bg-red-600/20 px-1">CONVICTION = AUTOMATIC CAREER
                                    TERMINATION.</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- VIEW: COURT OPERATIONS -->
            <div id="view-court" class="view-panel hidden animate-fade-in space-y-10">
                <div
                    class="glass-panel rounded-2xl border border-white/5 overflow-hidden flex flex-col md:flex-row h-[750px] shadow-3xl">
                    <!-- Hearing Roadmap -->
                    <div
                        class="w-full md:w-80 bg-executive-navy/50 border-r border-white/5 p-10 overflow-y-auto custom-scrollbar">
                        <h3 class="font-serif text-xl font-bold text-white mb-10 tracking-tight">Hearing Protocol</h3>
                        <div class="space-y-10 relative">
                            <div class="absolute left-2.5 top-0 bottom-0 w-[1px] bg-white/5"></div>

                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-slate-800 border-2 border-executive-navy flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-slate-500"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-white uppercase tracking-[0.2em] mb-2">09:00 AM |
                                    Arrival</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Secure duty lawyer brief. If
                                    unavailable, proceed as self-represented litigant. Maintain professional detachment.
                                </p>
                            </div>
                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-executive-gold/20 border-2 border-executive-gold/50 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-executive-gold animate-ping"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-executive-gold uppercase tracking-[0.2em] mb-2">
                                    Session | Submission</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Formally move for s59 Diversion.
                                    Pivot strictly to the 'Administrative Error' and 'Career Impact' pillars.</p>
                            </div>
                            <div class="relative pl-10">
                                <div
                                    class="absolute left-0 top-1 w-5 h-5 rounded-full bg-emerald-500/10 border-2 border-emerald-500/40 flex items-center justify-center">
                                    <div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>
                                </div>
                                <h5 class="text-[10px] font-bold text-emerald-400 uppercase tracking-[0.2em] mb-2">
                                    Target | Adjournment</h5>
                                <p class="text-[10px] text-slate-500 leading-relaxed">Secure adjournment for Diversion
                                    Assessment. Conviction avoided. Professional record preserved.</p>
                            </div>
                        </div>

                        <!-- Magistrate Feedback Box -->
                        <div class="mt-12 p-6 rounded-2xl bg-white/[0.02] border border-white/5">
                            <div class="flex justify-between items-center mb-4">
                                <h6 class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">Judicial
                                    Simulator</h6>
                                <button onclick="triggerAIAction('simulate-magistrate')" aria-label="Simulate magistrate feedback"
                                    class="text-executive-gold hover:text-white transition-colors">
                                    <i class="fa-solid fa-play text-[10px]"></i>
                                </button>
                            </div>
                            <div id="magistrate-feedback" class="text-[10px] text-slate-500 italic leading-relaxed">
                                Click to simulate hostile judicial cross-examination...
                            </div>
                        </div>
                    </div>

                    <!-- Interactive Script -->
                    <div class="flex-1 flex flex-col bg-black/10">
                        <div class="p-6 border-b border-white/5 flex justify-between items-center bg-white/[0.02]">
                            <div>
                                <h4 class="text-[10px] font-bold text-white uppercase tracking-[0.3em]">Oral Submission
                                    Script</h4>
                                <p class="text-[8px] text-slate-600 uppercase font-bold tracking-widest mt-1">Legally
                                    Privileged | Verified Victorian Precedent</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span id="court-save-indicator" class="text-[9px] text-slate-500 font-bold uppercase tracking-widest">Not saved</span>
                                <button onclick="triggerAIAction('refine-script')"
                                    class="px-5 py-2 bg-executive-gold/10 hover:bg-executive-gold/20 text-executive-gold text-[9px] font-bold uppercase tracking-[0.2em] rounded-full transition-all flex items-center gap-2 border border-executive-gold/20">
                                    <i class="fa-solid fa-wand-magic-sparkles"></i> AI Strategic Refine
                                </button>
                            </div>
                        </div>
                        <div class="flex-1 p-0">
                            <textarea id="courtScript"
                                class="w-full h-full p-12 bg-transparent text-slate-300 font-serif text-lg leading-relaxed resize-none focus:outline-none custom-scrollbar"
                                spellcheck="false" oninput="debounceSaveState()">
**PHASE 1: THE FORMAL APPEARANCE**
"Your Honour, I appear self-represented. I confirm my name is Vikram Deshpande. I am a financial sector executive with no prior relevant criminal history."

**PHASE 2: THE APPLICATION (Diversion)**
"Your Honour, I respectfully request a short adjournment to finalize an application for Diversion pursuant to s 59 of the Criminal Procedure Act. I believe my case meets the threshold for exceptional circumstances."

**PHASE 3: THE STRATEGIC ARGUMENT**
1. **The Administrative Failure:** "The 'Drive Suspended' charge stems from an honest and reasonable mistake of fact. I relied on a VicRoads letter dated 24 Sep 2025 which explicitly stated that my license directions had ended."
2. **Systemic Harassment:** "Regarding the refusal on 09 Feb, I submit this was a trauma-response to being intercepted 5 times in 33 days without cause. I have documented this pattern with the Police Conduct Unit."
3. **Disproportionate Impact:** "A conviction of any kind triggers mandatory reporting under APRA CPS 520 standards, which effectively terminates my professional livelihood. This outcome is vastly disproportionate to the alleged offending."
</textarea>
                        </div>
                    </div>
                </div>
            </div>



            <!-- VIEW: AI CO-COUNSEL -->
            <div id="view-ai" class="view-panel hidden animate-fade-in h-[calc(100vh-140px)] flex flex-col">
                <div
                    class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden border border-white/5 shadow-3xl">
                    <!-- AI Header -->
                    <div class="p-8 border-b border-white/5 bg-white/[0.03] flex justify-between items-center gap-6">
                        <div class="flex items-center gap-6">
                            <div
                                class="h-16 w-16 rounded-2xl bg-gold-gradient flex items-center justify-center shadow-2xl transform hover:rotate-3 transition-transform">
                                <i class="fa-solid fa-brain text-white text-3xl"></i>
                            </div>
                            <div>
                                <h3 class="font-serif text-2xl font-bold text-white tracking-tight">AI Co-Counsel</h3>
                                <div class="flex items-center gap-3 mt-1">
                                    <span class="flex h-2 w-2 relative">
                                        <span
                                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                                    </span>
                                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-[0.2em]">Gemini
                                        1.5 Flash • High Security Node</p>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center gap-4">
                            <div class="hidden xl:flex flex-col gap-2">
                                <input type="password" id="gemini-api-key" placeholder="Gemini API Key"
                                    class="text-[9px] bg-white/5 border border-white/10 rounded-lg px-4 py-2 w-48 text-white focus:outline-none focus:border-executive-gold transition-all">
                                <input type="text" id="google-client-id" placeholder="Google Client ID"
                                    class="text-[9px] bg-white/5 border border-white/10 rounded-lg px-4 py-2 w-48 text-white focus:outline-none focus:border-executive-gold transition-all">
                            </div>
                            <div class="flex flex-col gap-2">
                                <button onclick="saveKeys()"
                                    class="text-[9px] font-bold uppercase tracking-widest bg-white/10 hover:bg-white/20 text-white px-6 py-2 rounded-lg transition-all border border-white/10">Save
                                    Config</button>
                                <button id="btn-auth" onclick="handleAuthClick()"
                                    class="text-[9px] font-bold uppercase tracking-widest bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition-all shadow-lg flex items-center justify-center gap-2">
                                    <i class="fa-brands fa-google"></i> Connect Drive</button>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Strategy Actions -->
                    <div
                        class="px-8 py-4 bg-white/[0.02] border-b border-white/5 flex gap-4 overflow-x-auto custom-scrollbar no-scrollbar">
                        <button onclick="triggerAIAction('analyze-strength')"
                            class="flex-shrink-0 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/10 hover:border-executive-gold/50 hover:text-executive-gold px-6 py-2.5 rounded-full transition-all shadow-sm">
                            ✨ Strategy Audit
                        </button>
                        <button onclick="triggerAIAction('draft-complaint')"
                            class="flex-shrink-0 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/10 hover:border-emerald-500/50 hover:text-emerald-400 px-6 py-2.5 rounded-full transition-all shadow-sm">
                            ✨ Draft PSC Brief
                        </button>
                        <button onclick="triggerAIAction('simulate-cross')"
                            class="flex-shrink-0 text-[10px] font-bold uppercase tracking-widest bg-white/5 border border-white/10 hover:border-red-500/50 hover:text-red-400 px-6 py-2.5 rounded-full transition-all shadow-sm">
                            ✨ Prosecution Simulation
                        </button>
                    </div>

                    <!-- Executive Chat Environment -->
                    <div id="chat-history" class="flex-1 overflow-y-auto p-10 space-y-8 bg-black/40 custom-scrollbar">
                        <div class="flex gap-6">
                            <div
                                class="w-12 h-12 rounded-xl bg-executive-navy border border-executive-gold/30 flex-shrink-0 flex items-center justify-center mt-1 shadow-xl">
                                <i class="fa-solid fa-scale-balanced text-executive-gold text-lg"></i>
                            </div>
                            <div class="glass-panel p-6 rounded-2xl rounded-tl-none border border-white/5 max-w-[85%]">
                                <p class="text-sm text-slate-300 leading-relaxed font-serif">
                                    <strong class="text-white text-lg block mb-4">Strategic Environment Active.</strong>
                                    I have ingested the full case brief (DESHPANDE v POLICE). Analysis confirms a <span
                                        class="text-executive-gold font-bold">dual-pillar defence</span> opportunity:
                                </p>
                                <ul class="mt-6 space-y-4 text-sm text-slate-400">
                                    <li class="flex gap-3"><i class="fa-solid fa-check text-executive-gold mt-1"></i>
                                        <span class="leading-relaxed"><strong>Administrative Failure:</strong>
                                            Leveraging the VicRoads Sep 24 directive as the basis for <em>Proudman v
                                                Dayman</em> ignorance of fact.</span>
                                    </li>
                                    <li class="flex gap-3"><i class="fa-solid fa-check text-executive-gold mt-1"></i>
                                        <span class="leading-relaxed"><strong>Systemic Bias:</strong> The statistically
                                            anomalous "5 Stops" pattern supports an Abuse of Process stay or Diversion
                                            mitigation.</span>
                                    </li>
                                </ul>
                                <p class="mt-8 text-xs text-slate-500 uppercase tracking-widest font-bold">How shall we
                                    proceed with the court filing?</p>
                            </div>
                        </div>
                    </div>

                    <!-- Intelligence Input Area -->
                    <div class="p-8 bg-black/60 border-t border-white/10">
                        <div class="max-w-4xl mx-auto flex gap-4 relative">
                            <textarea id="chat-input" rows="1"
                                class="w-full bg-white/5 border border-white/10 rounded-2xl pl-6 pr-16 py-5 text-sm text-white focus:outline-none focus:border-executive-gold transition-all resize-none shadow-2xl"
                                placeholder="Execute strategic inquiry or document request..."
                                onkeydown="handleChatInput(event)"></textarea>
                            <button onclick="sendMessage()" aria-label="Send Message"
                                class="absolute right-3 top-3 bottom-3 w-12 bg-gold-gradient hover:scale-105 text-white rounded-xl flex items-center justify-center transition-all shadow-lg">
                                <i class="fa-solid fa-paper-plane text-sm"></i>
                            </button>
                        </div>
                        <div class="flex justify-center items-center gap-6 mt-6">
                            <p class="text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em]">
                                <i class="fa-solid fa-shield-halved mr-2 text-executive-gold"></i> AES-256 Encrypted
                                Context
                            </p>
                            <p class="text-[9px] text-slate-600 font-bold uppercase tracking-[0.3em]">
                                <i class="fa-solid fa-building-columns mr-2"></i> Counsel-Client Privileged
                            </p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // --- SECURITY: OBFUSCATION UTILITIES ---
        const _K = "LEX_DEFENSION_2026"; // Internal obfuscation key
        function _obs(s) {
            if (!s) return "";
            return btoa(s.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ _K.charCodeAt(i % _K.length))).join(''));
        }
        function _deobs(s) {
            if (!s) return "";
            try {
                const d = atob(s);
                return d.split('').map((c, i) => String.fromCharCode(c.charCodeAt(0) ^ _K.charCodeAt(i % _K.length))).join('');
            } catch (e) { return ""; }
        }

        // --- SECURITY: XSS SANITIZATION ---
        function sanitize(str) {
            if (!str) return "";
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#x27;', '/': '&#x2F;' };
            return str.replace(/[&<>"'/]/g, s => map[s]);
        }
        function formatAIResponse(text) {
            // Sanitize first
            let clean = sanitize(text);
            // Then re-enable bolding and line breaks for UI
            return clean.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
        }

        function applyAriaLabels() {
            const elements = document.querySelectorAll('button, [role="button"], input, select, textarea, a[href]');
            elements.forEach(el => {
                if (!el.getAttribute('aria-label')) {
                    const label = el.getAttribute('placeholder') || el.getAttribute('title') || (el.innerText || '').trim();
                    el.setAttribute('aria-label', label || 'Action');
                }
            });
        }

        // Global variable to hold the chart instance
        let toxChartInstance = null;
        let uploadedFiles = []; // Store uploaded file metadata

        // --- FILE UPLOAD LOGIC ---
        const dropZones = document.querySelectorAll('.drop-zone');
        const fileInput = document.getElementById('file-input');

        dropZones.forEach(zone => {
            zone.addEventListener('click', () => fileInput.click());
            zone.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    fileInput.click();
                }
            });

            zone.addEventListener('dragover', (e) => {
                e.preventDefault();
                zone.classList.add('drag-over');
            });

            zone.addEventListener('dragleave', () => {
                zone.classList.remove('drag-over');
            });

            zone.addEventListener('drop', (e) => {
                e.preventDefault();
                zone.classList.remove('drag-over');
                handleFiles(e.dataTransfer.files);
            });
        });

        function handleFiles(files) {
            const lists = document.querySelectorAll('.file-list');
            Array.from(files).forEach(file => {
                uploadedFiles.push(file);
                const safeName = sanitize(file.name);

                lists.forEach(list => {
                    const div = document.createElement('div');
                    div.className = "flex items-center justify-between p-2 bg-slate-50 rounded border border-slate-100 text-xs";
                    div.innerHTML = `
                        <div class="flex items-center gap-2 truncate">
                            <i class="fa-solid fa-file text-slate-400"></i>
                            <span class="font-medium text-slate-700 truncate">${safeName}</span>
                        </div>
                        <span class="text-[10px] text-slate-400">${(file.size / 1024 / 1024).toFixed(2)} MB</span>
                    `;
                    list.appendChild(div);
                });
            });

            // Add system message to analysis chat
            addDocMessage(`System: Successfully ingested ${files.length} new document(s) into local context.`, 'system');
        }

        // --- DOC ANALYSIS LOGIC ---
        function analyzeDocuments() {
            const input = document.getElementById('doc-query-input');
            const query = input.value.trim();
            if (!query) return;

            addDocMessage(query, 'user');
            input.value = '';

            // Simulate "Reading" files (Visual Feedback)
            const thinkingId = addDocMessage('Inspecting loaded files...', 'thinking');

            setTimeout(() => {
                document.getElementById(thinkingId).remove();
                // This connects to the main AI logic if key is present, otherwise mock response
                const apiKey = _deobs(sessionStorage.getItem('GEMINI_API_KEY'));

                if (apiKey) {
                    // Call real Gemini with file context context
                    const fileContext = uploadedFiles.map(f => `[File: ${f.name}]`).join(", ");
                    const context = `USER HAS UPLOADED THESE FILES: ${fileContext}. They are asking about them. ` + scrapeContext();

                    callGemini(apiKey, context, query).then(response => {
                        addDocMessage(response, 'ai');
                    }).catch(err => {
                        addDocMessage("Error analyzing documents: " + err.message, 'system');
                    });
                } else {
                    // Mock response if no key
                    addDocMessage("**Analysis Result:** Based on the file metadata and your query, I recommend cross-referencing these documents with the Chronology Engine. Please save your API key to perform full text extraction and deep analysis.", 'ai');
                }
            }, 1500);
        }

        function addDocMessage(text, type) {
            const history = document.getElementById('doc-analysis-history');
            const id = 'doc-msg-' + Date.now();
            let html = '';

            if (type === 'user') {
                const clean = sanitize(text);
                html = `<div class="flex justify-end"><div class="bg-slate-200 text-slate-800 p-3 rounded-lg rounded-tr-none text-sm max-w-[80%]">${clean}</div></div>`;
            } else if (type === 'ai') {
                const formatted = formatAIResponse(text);
                html = `<div class="flex gap-3"><div class="w-6 h-6 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-robot text-legal-gold text-[10px]"></i></div><div class="bg-white border border-slate-200 p-3 rounded-lg rounded-tl-none text-sm max-w-[90%] shadow-sm">${formatted}</div></div>`;
            } else if (type === 'thinking') {
                html = `<div id="${id}" class="flex gap-3"><div class="w-6 h-6 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-robot text-legal-gold text-[10px] animate-pulse"></i></div><div class="text-xs text-slate-400 italic mt-2">Reading documents...</div></div>`;
            } else {
                const clean = sanitize(text);
                html = `<div class="text-center"><span class="text-[10px] text-slate-400 uppercase tracking-wide border-b border-slate-200 pb-1">${clean}</span></div>`;
            }

            history.insertAdjacentHTML('beforeend', html);
            history.scrollTop = history.scrollHeight;
            return id;
        }


        // --- GEMINI AI INTEGRATION (Main Chat) ---
        const SYSTEM_PROMPT = `
Role: Senior Victorian Traffic Defence Counsel.
Client: Vikram Deshpande (Financial Executive).
Opposition: Victoria Police (Informant SC May).
Objective: excessive police harassment (5 stops in 33 days) + honest mistake of fact (Proudman v Dayman) = Diversion.
Constraint: AVOID conviction at all costs to preserve APRA "Fit and Proper" status.

You have access to the dashboard context. When answering:
1. Be concise, strategic, and authoritative.
2. Cite specific Victorian legislation (Road Safety Act 1986, Criminal Procedure Act 2009).
3. Reference the specific case facts (VicRoads letter Sep 24, 5 Stops).
4. Do not be generic. Be aggressive in defence strategy.
`;

        async function sendMessage(forcedPrompt = null, isSimulation = false) {
            const input = document.getElementById('chat-input');
            const message = forcedPrompt || input.value.trim();
            if (!message) return;

            // Only add user message to chat if it's a normal chat, not a simulation/action
            if (!isSimulation && !forcedPrompt) {
                addMessage(message, 'user');
                input.value = '';
            } else if (forcedPrompt && !isSimulation) {
                addMessage(message, 'user'); // Show prompt in chat for actions like "Analyze"
            }

            const apiKey = _deobs(sessionStorage.getItem('GEMINI_API_KEY'));
            if (!apiKey) {
                if (isSimulation) {
                    document.getElementById('magistrate-feedback').innerText = "Error: Please enter your API Key in the AI Co-Counsel tab.";
                } else {
                    addMessage("Error: Please enter and save your Gemini API Key in the top right corner.", 'system');
                }
                return;
            }

            let thinkingId;
            if (!isSimulation) {
                thinkingId = addMessage('Analyzing case files...', 'ai-thinking');
            } else {
                document.getElementById('magistrate-feedback').innerHTML = `<div class="flex items-center gap-2 text-slate-500"><i class="fa-solid fa-spinner fa-spin"></i> Consulting Magistrate Persona...</div>`;
            }

            try {
                const context = scrapeContext();
                const response = await callGemini(apiKey, context, message);

                if (isSimulation) {
                    // Update the magistrate feedback box specifically
                    document.getElementById('magistrate-feedback').innerHTML = formatAIResponse(response);
                } else {
                    document.getElementById(thinkingId).remove();
                    addMessage(response, 'ai');
                }

            } catch (error) {
                if (isSimulation) {
                    document.getElementById('magistrate-feedback').innerText = "Simulation Error: " + error.message;
                } else {
                    document.getElementById(thinkingId).remove();
                    addMessage(`Error: ${error.message}`, 'system');
                }
            }
        }

        function triggerAIAction(action) {
            let prompt = "";
            let isSimulation = false;

            switch (action) {
                case 'analyze-strength':
                    switchView('ai');
                    prompt = "Analyze the defence strategy based on the dashboard. Estimate the probability of securing Diversion given the 'Dual-Failure' and 'Harassment' arguments. List 3 critical weaknesses we must address.";
                    break;
                case 'draft-complaint':
                    switchView('ai');
                    prompt = "Draft a formal complaint to the Police Conduct Unit regarding the 5 stops in 33 days. Use a professional, legal tone. Emphasize 'Abuse of Process' and the impact on the client's sole income source (Uber vehicle).";
                    break;
                case 'simulate-cross':
                    switchView('ai');
                    prompt = "Simulate the Prosecutor (Sergeant). Ask me ONE difficult cross-examination question regarding my refusal to be tested on Feb 09. Then, provide the optimal answer I should give.";
                    break;
                case 'refine-script':
                    switchView('ai');
                    const currentScript = document.getElementById('courtScript').value;
                    prompt = `Refine this hearing script for maximum persuasive impact. Make it sharper and more focused on 'Proudman v Dayman' and 'APRA Career Risk'. Keep it concise for a self-represented litigant:\n\n"${currentScript}"`;
                    break;
                case 'simulate-magistrate':
                    isSimulation = true;
                    const scriptText = document.getElementById('courtScript').value;
                    prompt = `Act as a cynical Victorian Magistrate hearing this matter. Review the following defence submission: "${scriptText}". 
                    
                     प्रोवाइड 2 likely interruptions/questions you would ask to challenge this narrative, and then deliver a preliminary indication of your ruling on Diversion based on the "5 Stops" harassment argument. Output as HTML.`;
                    break;
                case 'inspect':
                    isSimulation = false;
                    const inspector = document.getElementById('ai-inspector');
                    inspector.classList.remove('hidden');
                    const activeDoc = document.querySelector('.doc-sheet:not(.hidden)');
                    const docTitle = activeDoc ? activeDoc.querySelector('h1')?.innerText || 'Active Exhibit' : 'Selected Exhibit';
                    prompt = `Perform a deep forensic inspection of this document: "${docTitle}". Look for administrative errors, jurisdictional flaws, or evidence of harassment. Provide findings in a concise, bulleted list suitable for an AI Inspector panel.`;
                    break;
            }
            if (prompt) sendMessage(prompt, isSimulation);
        }

        function addMessage(text, type) {
            const history = document.getElementById('chat-history');
            const id = 'msg-' + Date.now();

            let html = '';
            if (type === 'user') {
                const clean = sanitize(text);
                html = `<div class="flex gap-4 flex-row-reverse" id="${id}"><div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-user text-slate-500 text-xs"></i></div><div class="bg-legal-navy text-white p-4 rounded-lg rounded-tr-none shadow-md max-w-[80%]"><p class="text-sm leading-relaxed">${clean}</p></div></div>`;
            } else if (type === 'ai') {
                const formatted = formatAIResponse(text);
                html = `<div class="flex gap-4" id="${id}"><div class="w-8 h-8 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-scale-balanced text-legal-gold text-xs"></i></div><div class="bg-white p-4 rounded-lg rounded-tl-none shadow-sm border border-slate-200 max-w-[80%]"><p class="text-sm text-slate-700 leading-relaxed">${formatted}</p></div></div>`;
            } else if (type === 'ai-thinking') {
                html = `<div class="flex gap-4" id="${id}"><div class="w-8 h-8 rounded-full bg-legal-navy flex-shrink-0 flex items-center justify-center mt-1"><i class="fa-solid fa-robot text-legal-gold text-xs animate-pulse"></i></div><div class="bg-transparent p-4 max-w-[80%] flex items-center gap-2 thinking-dots"><div class="w-2 h-2 bg-slate-400 rounded-full"></div><div class="w-2 h-2 bg-slate-400 rounded-full"></div><div class="w-2 h-2 bg-slate-400 rounded-full"></div></div></div>`;
            } else {
                html = `<div class="flex justify-center my-4" id="${id}"><span class="bg-red-100 text-red-800 text-xs px-3 py-1 rounded-full font-bold">${text}</span></div>`;
            }

            history.insertAdjacentHTML('beforeend', html);
            history.scrollTop = history.scrollHeight;
            return id;
        }

        async function callGemini(apiKey, context, userPrompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;

            // Add Drive context if available
            let driveContextText = "";
            if (window.driveFilesContext && window.driveFilesContext.length > 0) {
                driveContextText = "\n\nFILES IN GOOGLE DRIVE (Case_Files):\n" +
                    window.driveFilesContext.map(f => `- ${f.name} (ID: ${f.id}, Modified: ${f.modifiedTime})`).join("\n");
            }

            const payload = {
                contents: [{
                    parts: [{
                        text: `${SYSTEM_PROMPT}\n\nCURRENT DASHBOARD CONTEXT:\n${context}${driveContextText}\n\nUSER QUESTION:\n${userPrompt}`
                    }]
                }]
            };

            const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) { const errData = await response.json(); throw new Error(errData.error?.message || 'Gemini API request failed'); }
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function scrapeContext() {
            let context = "";
            const views = ['dashboard', 'chronology', 'harassment', 'matrix', 'financial', 'files', 'legal', 'court'];
            views.forEach(view => {
                const el = document.getElementById(`view-${view}`);
                if (el) { context += `\n--- VIEW: ${view.toUpperCase()} ---\n${el.innerText.substring(0, 2000)}`; }
            });
            return context;
        }

        async function saveKeys() {
            const geminiKey = document.getElementById('gemini-api-key').value;
            const clientId = document.getElementById('google-client-id').value;
            const oldClientId = localStorage.getItem('GOOGLE_CLIENT_ID');

            if (geminiKey) sessionStorage.setItem('GEMINI_API_KEY', _obs(geminiKey));
            if (clientId) localStorage.setItem('GOOGLE_CLIENT_ID', clientId); // Client ID is usually not sensitive enough for XOR but we keep it plaintext for simplicity or obfuscate if requested. Requirements say "API Key Storage" specifically.

            alert('Configuration Saved (API Key stored for this session only)');

            // Re-init token client if client ID changed and it's valid
            if (clientId && clientId !== oldClientId && clientId.includes('.apps.googleusercontent.com')) {
                initTokenClient();
            }

            // Sync to Drive if connected
            if (accessToken) {
                try {
                    await uploadConfigToDrive(geminiKey, clientId);
                } catch (err) {
                    console.error('Config Sync Fail:', err);
                    alert('Error syncing config to Drive: ' + err.message);
                }
            }
        }

        async function uploadConfigToDrive(geminiKey, clientId) {
            updateSyncStatus('Uploading Config...');
            const config = {
                GEMINI_API_KEY: geminiKey,
                GOOGLE_CLIENT_ID: clientId,
                lastUpdated: new Date().toISOString()
            };

            // Find existing api_keys.json
            const search = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'api_keys.json' and trashed = false`,
                fields: 'files(id)',
            });

            if (search.result.files.length > 0) {
                const fileId = search.result.files[0].id;
                const patchResp = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });
                if (!patchResp.ok) throw new Error(`Upload Config Error: ${patchResp.status}`);
            } else {
                // Create new
                const fileMetadata = {
                    name: 'api_keys.json',
                    mimeType: 'application/json',
                    parents: [DRIVE_FOLDER_ID]
                };
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                const multipartRequestBody =
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(fileMetadata) +
                    delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(config) +
                    close_delim;

                const postResp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'multipart/related; boundary=' + boundary },
                    body: multipartRequestBody
                });
                if (!postResp.ok) throw new Error(`Create Config Error: ${postResp.status}`);
            }
            updateSyncStatus('Config Synced', 'bg-emerald-500');
        }

        function handleChatInput(e) {
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        }

        // --- Chart Logic (Toxicology) ---
        function renderToxChart() {
            const ctx = document.getElementById('toxChart').getContext('2d');
            if (toxChartInstance) { toxChartInstance.destroy(); }
            toxChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['0h', '12h', '24h', '36h', '48h (Stop)', '60h'],
                    datasets: [{ label: 'Concentration (Trace)', data: [100, 80, 40, 15, 5, 0], borderColor: '#c5a059', backgroundColor: 'rgba(197, 160, 89, 0.1)', fill: true, tension: 0.4 }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { grid: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        // --- View Logic ---
        function switchView(viewId) {
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const btn = document.getElementById(`btn-${viewId}`);
            if (btn) btn.classList.add('active');

            document.querySelectorAll('.view-panel').forEach(el => el.classList.add('hidden'));
            const panel = document.getElementById(`view-${viewId}`);
            if (panel) panel.classList.remove('hidden');

            // Dynamic Header Update
            const viewTitles = {
                'dashboard': 'Executive Briefing',
                'intervention': 'Police Intervention',
                'chronology': 'Forensic Timeline',
                'harassment': 'Conduct Analysis',
                'matrix': 'Truth Matrix',
                'legal': 'Legal Arguments',
                'files': 'Evidence Vault',
                'financial': 'Forensic Data',
                'court': 'Court Operations',
                'ai': 'AI Co-Counsel'
            };
            const pageTitle = document.getElementById('page-title');
            if (pageTitle && viewTitles[viewId]) {
                pageTitle.innerText = viewTitles[viewId];
            }

            if (viewId === 'legal' || viewId === 'financial') setTimeout(renderToxChart, 100);
        }

        // --- Document Viewer Logic ---
        function showDoc(docId, evt) {
            document.querySelectorAll('.doc-sheet').forEach(el => el.classList.add('hidden'));
            const doc = document.getElementById(`doc-${docId}`);
            if (doc) doc.classList.remove('hidden');

            document.querySelectorAll('.doc-btn').forEach(el => {
                el.classList.remove('active-doc-btn');
                el.classList.add('opacity-60');
            });

            if (evt && evt.currentTarget) {
                evt.currentTarget.classList.add('active-doc-btn');
                evt.currentTarget.classList.remove('opacity-60');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden', 'opacity-0');
                overlay.classList.add('opacity-100');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.remove('opacity-100');
                overlay.classList.add('opacity-0');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        window.addEventListener('load', () => {
            const savedGeminiKey = _deobs(sessionStorage.getItem('GEMINI_API_KEY'));
            const savedClientId = localStorage.getItem('GOOGLE_CLIENT_ID');

            if (savedGeminiKey) document.getElementById('gemini-api-key').value = savedGeminiKey;

            const clientIdInput = document.getElementById('google-client-id');
            if (savedClientId) {
                clientIdInput.value = savedClientId;
            }

            // Restore local state
            const localState = localStorage.getItem('DASHBOARD_LOCAL_STATE');
            if (localState) {
                try {
                    const parsed = JSON.parse(localState);
                    if (parsed.courtScript) document.getElementById('courtScript').value = parsed.courtScript;
                    const indicator = document.getElementById('court-save-indicator');
                    if (indicator) {
                        indicator.textContent = 'Restored';
                        indicator.classList.add('text-emerald-400');
                    }
                } catch (e) { console.error('Error restoring local state', e); }
            }

            applyAriaLabels();
            gapi.load('client', initGapiClient);
        });

        // --- GOOGLE DRIVE SYNC ENGINE ---
        const DRIVE_FOLDER_ID = '1hWKlM5c3EbB5jgAA5Xi_V6rFD3nKQUZS';
        let tokenClient;
        let accessToken = null;
        let lastSyncTime = Date.now();
        window.driveFilesContext = [];

        async function initGapiClient() {
            try {
                await gapi.client.init({
                    discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
                });
                updateSyncStatus('Ready', 'bg-slate-500'); // Default to Ready if GAPI loads
                initTokenClient();
                checkStoredToken();
            } catch (e) {
                console.error('GAPI Init Error:', e);
                updateSyncStatus('Sync Error', 'bg-red-500');
            }
        }

        function initTokenClient() {
            const clientId = localStorage.getItem('GOOGLE_CLIENT_ID');
            if (!clientId) return;

            if (!clientId.includes('.apps.googleusercontent.com')) {
                console.warn("Potential Invalid Client ID: Ensure you use the full OAuth Client ID, not just the project number.");
            }

            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: clientId,
                scope: 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/drive.metadata.readonly',
                callback: (tokenResponse) => {
                    if (tokenResponse.error !== undefined) {
                        console.error('Auth Error:', tokenResponse);
                        updateSyncStatus('Auth Error: ' + tokenResponse.error, 'bg-red-500');
                        if (tokenResponse.error === 'access_denied') {
                            alert("Access Denied: Please ensure 'sarkar.vikram@gmail.com' is added as a 'Test User' in your Google Cloud Console OAuth Consent Screen.");
                        }
                        return;
                    }
                    accessToken = tokenResponse.access_token;
                    // Set token for GAPI client
                    gapi.client.setToken({ access_token: accessToken });

                    // Persist token securely (SessionStorage for access token)
                    const expiresAt = Date.now() + (tokenResponse.expires_in * 1000);
                    sessionStorage.setItem('GOOGLE_ACCESS_TOKEN', _obs(accessToken));
                    sessionStorage.setItem('GOOGLE_TOKEN_EXPIRES', expiresAt);

                    document.getElementById('btn-auth').innerText = 'Drive Connected';
                    document.getElementById('btn-auth').classList.replace('bg-blue-600', 'bg-emerald-600');
                    startSyncLoop();
                },
                error_callback: (err) => {
                    console.error('GIS Error:', err);
                    updateSyncStatus('Auth Error', 'bg-red-500');
                }
            });
        }

        function handleAuthClick() {
            if (!tokenClient) {
                alert("Please enter a Google Client ID in the AI Co-Counsel configuration first.");
                return;
            }
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        function checkStoredToken() {
            const storedToken = _deobs(sessionStorage.getItem('GOOGLE_ACCESS_TOKEN'));
            const expiresAt = sessionStorage.getItem('GOOGLE_TOKEN_EXPIRES');

            if (storedToken && expiresAt && Date.now() < parseInt(expiresAt)) {
                accessToken = storedToken;
                // Set token for GAPI client
                gapi.client.setToken({ access_token: accessToken });

                document.getElementById('btn-auth').innerText = 'Drive Connected';
                document.getElementById('btn-auth').classList.replace('bg-blue-600', 'bg-emerald-600');
                startSyncLoop();
            }
        }

        function updateSyncStatus(status, colorClass = 'bg-emerald-500') {
            const indicator = document.getElementById('sync-indicator');
            const statusText = document.getElementById('sync-text');
            indicator.className = `w-2 h-2 rounded-full animate-pulse ${colorClass}`;
            statusText.innerText = status;
        }

        let isSyncing = false;

        async function startSyncLoop() {
            if (isSyncing) return;
            updateSyncStatus('Syncing...');
            await runSync();
            setInterval(runSync, 20000);
        }

        async function runSync() {
            if (!accessToken || isSyncing) return;
            isSyncing = true;
            try {
                updateSyncStatus('Syncing...');

                // 1. Fetch Config (API Keys)
                await fetchConfigFromDrive();

                // 2. Index Files (Context Sync)
                await indexDriveFiles();

                // 3. Save State (Persistence)
                await saveStateToDrive();

                // 4. Robust "Always Replace" Sync for Workspace Files
                await syncWorkspaceFiles();

                // 5. Check Self (Modified Status) - Done after sync to avoid immediate reload
                await checkSelfUpdate();

                updateSyncStatus('Synced', 'bg-emerald-500');
                lastSyncTime = Date.now();
                setTimeout(() => {
                    if (isSyncing === false) {
                        document.getElementById('sync-indicator').classList.remove('animate-pulse');
                    }
                }, 3000);

            } catch (err) {
                console.error('Sync Error:', err);
                if (err.status === 401 || (err.result && err.result.error && err.result.error.code === 401)) {
                    accessToken = null;
                    sessionStorage.removeItem('GOOGLE_ACCESS_TOKEN');
                    sessionStorage.removeItem('GOOGLE_TOKEN_EXPIRES');
                    updateSyncStatus('Auth Expired', 'bg-red-500');
                    document.getElementById('btn-auth').innerText = 'Connect Drive';
                    document.getElementById('btn-auth').classList.replace('bg-emerald-600', 'bg-blue-600');
                    return;
                }
                updateSyncStatus('Sync Error', 'bg-red-500');
            } finally {
                isSyncing = false;
            }
        }

        async function uploadFileToDriveByName(fileName, mimeType, content) {
            const search = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = '${fileName}' and trashed = false`,
                fields: 'files(id)',
            });

            const fileMetadata = {
                name: fileName,
                mimeType: mimeType,
                parents: [DRIVE_FOLDER_ID]
            };

            const url = search.result.files.length > 0
                ? `https://www.googleapis.com/upload/drive/v3/files/${search.result.files[0].id}?uploadType=media`
                : 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart';

            if (search.result.files.length > 0) {
                // UPDATE (PATCH)
                const resp = await fetch(url, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': mimeType },
                    body: typeof content === 'string' ? content : JSON.stringify(content)
                });
                if (!resp.ok) throw new Error(`Upload ${fileName} Error: ${resp.status}`);
            } else {
                // CREATE (MULTIPART POST)
                const boundary = '-------314159265358979323846';
                const delimiter = "\r\n--" + boundary + "\r\n";
                const close_delim = "\r\n--" + boundary + "--";
                const body = delimiter +
                    'Content-Type: application/json\r\n\r\n' +
                    JSON.stringify(fileMetadata) +
                    delimiter +
                    `Content-Type: ${mimeType}\r\n\r\n` +
                    (typeof content === 'string' ? content : JSON.stringify(content)) +
                    close_delim;

                const resp = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'multipart/related; boundary=' + boundary },
                    body: body
                });
                if (!resp.ok) throw new Error(`Create ${fileName} Error: ${resp.status}`);
            }
        }

        async function syncWorkspaceFiles() {
            const filesToSync = [
                { name: 'legal_strategy_dashboard.html', mime: 'text/html' },
                { name: 'index.html', mime: 'text/html' },
                { name: 'manifest.json', mime: 'application/json' },
                { name: 'sw.js', mime: 'application/javascript' }
            ];

            for (const file of filesToSync) {
                try {
                    const resp = await fetch(file.name);
                    if (resp.ok) {
                        const content = await resp.text();
                        await uploadFileToDriveByName(file.name, file.mime, content);
                        console.log(`Successfully synced: ${file.name}`);
                    }
                } catch (e) {
                    console.warn(`Could not sync ${file.name}:`, e);
                }
            }
        }

        async function fetchConfigFromDrive() {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'api_keys.json' and trashed = false`,
                fields: 'files(id, name)',
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                const fileId = files[0].id;
                const contentResponse = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (!contentResponse.ok) throw new Error(`Fetch Config Error: ${contentResponse.status}`);
                const keys = await contentResponse.json();
                if (keys.GEMINI_API_KEY) {
                    sessionStorage.setItem('GEMINI_API_KEY', _obs(keys.GEMINI_API_KEY));
                    document.getElementById('gemini-api-key').value = keys.GEMINI_API_KEY;
                }
                if (keys.GOOGLE_CLIENT_ID) {
                    const localClientId = localStorage.getItem('GOOGLE_CLIENT_ID');
                    if (keys.GOOGLE_CLIENT_ID !== localClientId) {
                        localStorage.setItem('GOOGLE_CLIENT_ID', keys.GOOGLE_CLIENT_ID);
                        document.getElementById('google-client-id').value = keys.GOOGLE_CLIENT_ID;
                        // Client ID changed from cloud, re-init client logic if needed
                        initTokenClient();
                    }
                }
            }
        }

        async function checkSelfUpdate() {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'legal_strategy_dashboard.html' and trashed = false`,
                fields: 'files(id, name, modifiedTime)',
            });
            const files = response.result.files;
            if (files && files.length > 0) {
                const driveTime = new Date(files[0].modifiedTime).getTime();
                if (driveTime > lastSyncTime + 5000) { // 5s grace period
                    if (confirm("A newer version of the dashboard is available on Google Drive. Reload now?")) {
                        window.location.reload();
                    }
                }
            }
        }

        async function indexDriveFiles() {
            const response = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and trashed = false`,
                fields: 'files(id, name, mimeType, modifiedTime)',
            });
            window.driveFilesContext = response.result.files;

            // Update UI list if we are in Case Files view
            const lists = document.querySelectorAll('.file-list');
            // We only prepend/update to avoid clearing local uploads if any
            const driveFiles = window.driveFilesContext.filter(f => f.name !== 'legal_strategy_dashboard.html' && f.name !== 'api_keys.json' && f.name !== 'dashboard_state.json');

            // Simple logic to show drive files in the list if not already there
            driveFiles.forEach(file => {
                const existing = document.querySelector(`[data-drive-id="${file.id}"]`);
                if (!existing) {
                    const safeName = sanitize(file.name);
                    lists.forEach(list => {
                        const div = document.createElement('div');
                        div.setAttribute('data-drive-id', file.id);
                        div.className = "flex items-center justify-between p-2 bg-blue-50/50 rounded border border-blue-100 text-xs";
                        div.innerHTML = `
                            <div class="flex items-center gap-2 truncate">
                                <i class="fa-brands fa-google-drive text-blue-500"></i>
                                <span class="font-medium text-slate-700 truncate">${safeName}</span>
                            </div>
                            <span class="text-[9px] text-blue-400 uppercase font-bold">Cloud</span>
                        `;
                        list.prepend(div);
                    });
                }
            });
        }

        // --- STATE PERSISTENCE ---
        let debounceTimer;
        function debounceSaveState() {
            clearTimeout(debounceTimer);
            const indicator = document.getElementById('court-save-indicator');
            if (indicator) {
                indicator.textContent = 'Saving...';
                indicator.classList.remove('text-emerald-400');
                indicator.classList.add('text-slate-500');
            }
            debounceTimer = setTimeout(() => {
                const state = {
                    courtScript: document.getElementById('courtScript').value,
                    timestamp: new Date().toISOString()
                };
                localStorage.setItem('DASHBOARD_LOCAL_STATE', JSON.stringify(state));
                if (indicator) {
                    indicator.textContent = `Saved ${new Date().toLocaleTimeString()}`;
                    indicator.classList.remove('text-slate-500');
                    indicator.classList.add('text-emerald-400');
                }
                console.log('Local state autosaved');
            }, 500);
        }

        async function saveStateToDrive() {
            const state = {
                lastModified: new Date().toISOString(),
                courtScript: document.getElementById('courtScript').value,
                notes: "Auto-saved from browser sync engine."
            };

            // Find or create dashboard_state.json
            const search = await gapi.client.drive.files.list({
                q: `'${DRIVE_FOLDER_ID}' in parents and name = 'dashboard_state.json' and trashed = false`,
                fields: 'files(id)',
            });

            const fileMetadata = {
                name: 'dashboard_state.json',
                mimeType: 'application/json',
                parents: [DRIVE_FOLDER_ID]
            };

            const media = {
                mimeType: 'application/json',
                body: JSON.stringify(state)
            };

            if (search.result.files.length > 0) {
                const fileId = search.result.files[0].id;
                const patchResp = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify(state)
                });
                if (!patchResp.ok) throw new Error(`Save State Error: ${patchResp.status}`);
            } else {
                await uploadFileToDriveByName('dashboard_state.json', 'application/json', state);
            }
            // lastSyncTime is now updated in runSync finally block for accuracy
        }

        // --- PWA Service Worker Registration ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered'))
                    .catch(err => console.log('SW Registration Fail', err));
            });
        }

        // Install Prompt Logic
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const installBtn = document.getElementById('install-button');
            if (installBtn) installBtn.classList.remove('hidden');
        });

        document.getElementById('install-button')?.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    document.getElementById('install-button').classList.add('hidden');
                }
                deferredPrompt = null;
            }
        });

        // --- PDF Export Logic ---
        async function exportDashboardToPDF(evt) {
            const btn = evt?.currentTarget || document.querySelector('button[onclick*="exportDashboardToPDF"]');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.innerHTML = '<i class="fa-solid fa-spinner animate-spin"></i> Generating Executive Briefing...';
                btn.disabled = true;
            }

            try {
                if (!window.jspdf || !window.jspdf.jsPDF) {
                    throw new Error('PDF engine unavailable. Please refresh and try again.');
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4' });

                const PAGE_W = 210;
                const PAGE_H = 297;
                const MARGIN = 25;
                const CONTENT_LEFT = 25;
                const CONTENT_RIGHT = 185;
                const CONTENT_TOP = 25;
                const CONTENT_BOTTOM = 272;
                const CONTENT_WIDTH = 160;
                const MM_PER_PT = 0.352778;
                const BODY_LINE_HEIGHT_FACTOR = 1.35;
                const TABLE_LINE_HEIGHT_FACTOR = 1.25;

                const COLOR_NAVY = [2, 6, 23];
                const COLOR_GOLD = [212, 175, 55];
                const COLOR_SLATE = [51, 65, 85];
                const COLOR_SLATE_SOFT = [71, 85, 105];
                const COLOR_BORDER = [203, 213, 225];
                const COLOR_KPI_FILL = [241, 245, 249];
                const COLOR_CALLOUT_FILL = [248, 250, 252];
                const COLOR_APRA_FILL = [254, 242, 242];
                const COLOR_APRA_TEXT = [127, 29, 29];
                const COLOR_APRA_BORDER = [239, 68, 68];

                const exportDate = new Date();
                const exportDateDisplay = exportDate.toLocaleDateString('en-AU', { dateStyle: 'long' });
                const reportTitle = 'Lex Defension Executive Briefing';
                let cursorY = CONTENT_TOP;
                let currentPage = 1;

                function normalizeText(value) {
                    return String(value || '')
                        .replace(/\u00A0/g, ' ')
                        .replace(/\s+/g, ' ')
                        .trim();
                }

                function nodeText(node) {
                    return normalizeText(node ? (node.innerText || node.textContent || '') : '');
                }

                function select(root, selector) {
                    return root ? root.querySelector(selector) : null;
                }

                function selectAll(root, selector) {
                    return root ? Array.from(root.querySelectorAll(selector)) : [];
                }

                function toLineHeightMm(fontSizePt, factor) {
                    return fontSizePt * MM_PER_PT * factor;
                }

                function linesHeight(lines, fontSizePt, factor) {
                    const count = Math.max(lines && lines.length ? lines.length : 1, 1);
                    return count * toLineHeightMm(fontSizePt, factor);
                }

                function splitLines(text, width) {
                    const cleaned = normalizeText(text);
                    if (!cleaned) return [];
                    return doc.splitTextToSize(cleaned, width);
                }

                function drawPageChrome(pageNumber) {
                    doc.setDrawColor(...COLOR_GOLD);
                    doc.setLineWidth(0.35);
                    doc.line(MARGIN, 14, PAGE_W - MARGIN, 14);

                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(8);
                    doc.setTextColor(...COLOR_NAVY);
                    doc.text('Privileged & Confidential', MARGIN, 10);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(...COLOR_SLATE);
                    doc.text(exportDateDisplay, PAGE_W - MARGIN, 10, { align: 'right' });

                    doc.setDrawColor(...COLOR_NAVY);
                    doc.setLineWidth(0.2);
                    doc.line(MARGIN, PAGE_H - 14, PAGE_W - MARGIN, PAGE_H - 14);

                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(7);
                    doc.setTextColor(...COLOR_SLATE_SOFT);
                    doc.text('Police v Deshpande | Executive Legal Strategy', MARGIN, PAGE_H - 8);

                    doc.setFont('helvetica', 'italic');
                    doc.setFontSize(7);
                    doc.setTextColor(...COLOR_GOLD);
                    doc.text(`Draft ${pageNumber}`, PAGE_W - MARGIN, PAGE_H - 8, { align: 'right' });
                }

                function drawFinalPageNumber(pageNumber, totalPages) {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(8);
                    doc.setTextColor(...COLOR_SLATE_SOFT);
                    doc.text(`Page ${pageNumber} of ${totalPages}`, PAGE_W / 2, PAGE_H - 8, { align: 'center' });
                }

                function addPage() {
                    doc.addPage();
                    currentPage += 1;
                    drawPageChrome(currentPage);
                    cursorY = CONTENT_TOP;
                }

                function ensureSpace(requiredHeight) {
                    if (cursorY + requiredHeight > CONTENT_BOTTOM) {
                        addPage();
                    }
                }

                function writeWrapped(text, options = {}) {
                    const cleaned = normalizeText(text);
                    if (!cleaned) return 0;

                    const x = options.x ?? CONTENT_LEFT;
                    const width = options.width ?? CONTENT_WIDTH;
                    const font = options.font || 'helvetica';
                    const style = options.style || 'normal';
                    const size = options.size || 10;
                    const color = options.color || COLOR_SLATE;
                    const before = options.before || 0;
                    const after = options.after ?? 2.5;
                    const lineHeightFactor = options.lineHeightFactor || BODY_LINE_HEIGHT_FACTOR;
                    const align = options.align || 'left';

                    const lines = splitLines(cleaned, width);
                    if (!lines.length) return 0;
                    const lineHeight = toLineHeightMm(size, lineHeightFactor);
                    let writtenHeight = 0;

                    if (before > 0) {
                        ensureSpace(before + lineHeight);
                        cursorY += before;
                        writtenHeight += before;
                    }

                    doc.setFont(font, style);
                    doc.setFontSize(size);
                    doc.setTextColor(...color);

                    let startIndex = 0;
                    while (startIndex < lines.length) {
                        let availableHeight = CONTENT_BOTTOM - cursorY;
                        let maxLines = Math.floor(availableHeight / lineHeight);

                        if (maxLines < 1) {
                            addPage();
                            availableHeight = CONTENT_BOTTOM - cursorY;
                            maxLines = Math.floor(availableHeight / lineHeight);
                        }
                        if (maxLines < 1) break;

                        const chunk = lines.slice(startIndex, startIndex + maxLines);
                        doc.text(chunk, x, cursorY, { lineHeightFactor, align });

                        const chunkHeight = chunk.length * lineHeight;
                        cursorY += chunkHeight;
                        writtenHeight += chunkHeight;
                        startIndex += chunk.length;

                        if (startIndex < lines.length) {
                            addPage();
                        }
                    }

                    if (after > 0) {
                        if (cursorY + after > CONTENT_BOTTOM) {
                            addPage();
                        }
                        cursorY += after;
                        writtenHeight += after;
                    }

                    return writtenHeight;
                }

                function writeSectionHeader(title) {
                    const lines = splitLines(title, CONTENT_WIDTH);
                    const size = 16;
                    const height = linesHeight(lines, size, 1.2);
                    ensureSpace(height + 8);

                    doc.setFont('times', 'bold');
                    doc.setFontSize(size);
                    doc.setTextColor(...COLOR_NAVY);
                    doc.text(lines, CONTENT_LEFT, cursorY, { lineHeightFactor: 1.2 });

                    cursorY += height;
                    doc.setDrawColor(...COLOR_GOLD);
                    doc.setLineWidth(0.6);
                    doc.line(CONTENT_LEFT, cursorY + 1, CONTENT_RIGHT, cursorY + 1);
                    cursorY += 6;
                }

                function writeSubHeader(text) {
                    writeWrapped(text, {
                        font: 'times',
                        style: 'bold',
                        size: 12,
                        color: COLOR_NAVY,
                        before: 1,
                        after: 2
                    });
                }

                function writeBullet(text, options = {}) {
                    const cleaned = normalizeText(text);
                    if (!cleaned) return;

                    const indent = options.indent || 0;
                    const size = options.size || 10;
                    const lineHeightFactor = options.lineHeightFactor || BODY_LINE_HEIGHT_FACTOR;
                    const bulletX = CONTENT_LEFT + indent;
                    const textX = bulletX + 4;
                    const width = CONTENT_RIGHT - textX;
                    const lines = splitLines(cleaned, width);
                    if (!lines.length) return;
                    const lineHeight = toLineHeightMm(size, lineHeightFactor);
                    let startIndex = 0;

                    while (startIndex < lines.length) {
                        let availableHeight = CONTENT_BOTTOM - cursorY;
                        let maxLines = Math.floor(availableHeight / lineHeight);

                        if (maxLines < 1) {
                            addPage();
                            availableHeight = CONTENT_BOTTOM - cursorY;
                            maxLines = Math.floor(availableHeight / lineHeight);
                        }
                        if (maxLines < 1) break;

                        const chunk = lines.slice(startIndex, startIndex + maxLines);

                        doc.setFont('helvetica', 'bold');
                        doc.setFontSize(size);
                        doc.setTextColor(...COLOR_GOLD);
                        doc.text('\u2022', bulletX, cursorY);

                        doc.setFont('helvetica', 'normal');
                        doc.setFontSize(size);
                        doc.setTextColor(...COLOR_SLATE);
                        doc.text(chunk, textX, cursorY, { lineHeightFactor });

                        cursorY += chunk.length * lineHeight;
                        startIndex += chunk.length;

                        if (startIndex < lines.length) {
                            addPage();
                        }
                    }

                    if (cursorY + 2 > CONTENT_BOTTOM) {
                        addPage();
                    }
                    cursorY += 2;
                }

                function writeCallout(text, options = {}) {
                    const cleaned = normalizeText(text);
                    if (!cleaned) return;

                    const fill = options.fill || COLOR_CALLOUT_FILL;
                    const border = options.border || COLOR_BORDER;
                    const textColor = options.textColor || COLOR_SLATE;
                    const size = options.size || 10;
                    const lineHeightFactor = options.lineHeightFactor || BODY_LINE_HEIGHT_FACTOR;
                    const paddingX = 4;
                    const paddingY = 3;
                    const width = CONTENT_WIDTH - (paddingX * 2);
                    const lines = splitLines(cleaned, width);
                    if (!lines.length) return;
                    const lineHeight = toLineHeightMm(size, lineHeightFactor);
                    let startIndex = 0;

                    while (startIndex < lines.length) {
                        let availableHeight = CONTENT_BOTTOM - cursorY;
                        let maxLines = Math.floor((availableHeight - (paddingY * 2)) / lineHeight);

                        if (maxLines < 1) {
                            addPage();
                            availableHeight = CONTENT_BOTTOM - cursorY;
                            maxLines = Math.floor((availableHeight - (paddingY * 2)) / lineHeight);
                        }
                        if (maxLines < 1) break;

                        const chunk = lines.slice(startIndex, startIndex + maxLines);
                        const chunkHeight = (chunk.length * lineHeight) + (paddingY * 2);

                        doc.setFillColor(...fill);
                        doc.setDrawColor(...border);
                        doc.setLineWidth(0.2);
                        doc.roundedRect(CONTENT_LEFT, cursorY, CONTENT_WIDTH, chunkHeight, 1.8, 1.8, 'FD');

                        doc.setFont(options.font || 'helvetica', options.style || 'normal');
                        doc.setFontSize(size);
                        doc.setTextColor(...textColor);
                        doc.text(chunk, CONTENT_LEFT + paddingX, cursorY + paddingY + (size * MM_PER_PT), { lineHeightFactor });

                        cursorY += chunkHeight;
                        startIndex += chunk.length;

                        if (startIndex < lines.length) {
                            addPage();
                        }
                    }

                    if (cursorY + 3 > CONTENT_BOTTOM) {
                        addPage();
                    }
                    cursorY += 3;
                }

                function writeKpiGrid(items) {
                    const cards = (items || []).filter((item) => normalizeText(item.label || item.title || item.value || item.detail));
                    if (!cards.length) return;

                    const columns = 2;
                    const columnGap = 4;
                    const rowGap = 4;
                    const cardWidth = (CONTENT_WIDTH - columnGap) / columns;

                    for (let i = 0; i < cards.length; i += columns) {
                        const rowCards = cards.slice(i, i + columns);
                        const measured = rowCards.map((card) => {
                            const label = normalizeText(card.label || card.title || 'KPI');
                            const value = normalizeText(card.value || '');
                            const detail = normalizeText(card.detail || '');

                            const labelLines = splitLines(label, cardWidth - 6);
                            const valueLines = splitLines(value, cardWidth - 6);
                            const detailLines = splitLines(detail, cardWidth - 6);

                            const labelHeight = linesHeight(labelLines, 8, 1.2);
                            const valueHeight = linesHeight(valueLines, 12, 1.2);
                            const detailHeight = detail ? linesHeight(detailLines, 8, 1.2) : 0;
                            const height = 6 + labelHeight + 2 + valueHeight + (detail ? 2 + detailHeight : 0) + 6;
                            return { label, value, detail, labelLines, valueLines, detailLines, height };
                        });

                        const rowHeight = Math.max(...measured.map((entry) => entry.height));
                        ensureSpace(rowHeight + rowGap);

                        measured.forEach((entry, columnIndex) => {
                            const x = CONTENT_LEFT + (columnIndex * (cardWidth + columnGap));
                            const y = cursorY;

                            doc.setFillColor(...COLOR_KPI_FILL);
                            doc.setDrawColor(...COLOR_BORDER);
                            doc.setLineWidth(0.25);
                            doc.roundedRect(x, y, cardWidth, rowHeight, 2, 2, 'FD');

                            let textY = y + 6;

                            doc.setFont('helvetica', 'bold');
                            doc.setFontSize(8);
                            doc.setTextColor(...COLOR_NAVY);
                            doc.text(entry.labelLines, x + 3, textY, { lineHeightFactor: 1.2 });
                            textY += linesHeight(entry.labelLines, 8, 1.2) + 2;

                            doc.setFont('times', 'bold');
                            doc.setFontSize(12);
                            doc.setTextColor(...COLOR_GOLD);
                            doc.text(entry.valueLines, x + 3, textY, { lineHeightFactor: 1.2 });
                            textY += linesHeight(entry.valueLines, 12, 1.2);

                            if (entry.detail) {
                                textY += 2;
                                doc.setFont('helvetica', 'normal');
                                doc.setFontSize(8);
                                doc.setTextColor(...COLOR_SLATE_SOFT);
                                doc.text(entry.detailLines, x + 3, textY, { lineHeightFactor: 1.2 });
                            }
                        });

                        cursorY += rowHeight + rowGap;
                    }
                }

                function renderTable(headers, rows, fractions, options = {}) {
                    if (!headers || !headers.length || !rows || !rows.length) return;

                    const tableWidth = options.width || CONTENT_WIDTH;
                    const tableX = options.x || CONTENT_LEFT;
                    const fractionsTotal = fractions.reduce((sum, value) => sum + value, 0);
                    const colWidths = fractions.map((value) => (tableWidth * value) / fractionsTotal);
                    const cellPaddingX = 2;
                    const cellPaddingY = 1.6;
                    const fontSize = options.fontSize || 9;

                    function drawRow(cells, isHeader) {
                        const linesByCell = cells.map((cell, idx) => splitLines(cell, colWidths[idx] - (cellPaddingX * 2)));
                        const textHeights = linesByCell.map((lines) => linesHeight(lines, fontSize, TABLE_LINE_HEIGHT_FACTOR));
                        const rowHeight = Math.max(...textHeights.map((height) => height + (cellPaddingY * 2)));

                        if (cursorY + rowHeight > CONTENT_BOTTOM) {
                            addPage();
                            drawRow(headers, true);
                        }

                        let x = tableX;

                        linesByCell.forEach((lines, idx) => {
                            const width = colWidths[idx];

                            if (isHeader) {
                                doc.setFillColor(226, 232, 240);
                                doc.setDrawColor(...COLOR_BORDER);
                                doc.setLineWidth(0.2);
                                doc.rect(x, cursorY, width, rowHeight, 'FD');
                                doc.setFont('helvetica', 'bold');
                                doc.setFontSize(fontSize);
                                doc.setTextColor(...COLOR_NAVY);
                            } else {
                                doc.setFillColor(255, 255, 255);
                                doc.setDrawColor(...COLOR_BORDER);
                                doc.setLineWidth(0.2);
                                doc.rect(x, cursorY, width, rowHeight, 'S');
                                doc.setFont('helvetica', 'normal');
                                doc.setFontSize(fontSize);
                                doc.setTextColor(...COLOR_SLATE);
                            }

                            doc.text(lines, x + cellPaddingX, cursorY + cellPaddingY + (fontSize * MM_PER_PT), {
                                lineHeightFactor: TABLE_LINE_HEIGHT_FACTOR
                            });
                            x += width;
                        });

                        cursorY += rowHeight;
                    }

                    drawRow(headers, true);
                    rows.forEach((row) => drawRow(row, false));
                    cursorY += 4;
                }

                function startSection(title) {
                    addPage();
                    writeSectionHeader(title);
                }

                const views = {
                    intervention: document.getElementById('view-intervention'),
                    dashboard: document.getElementById('view-dashboard'),
                    chronology: document.getElementById('view-chronology'),
                    harassment: document.getElementById('view-harassment'),
                    matrix: document.getElementById('view-matrix'),
                    legal: document.getElementById('view-legal'),
                    financial: document.getElementById('view-financial'),
                    court: document.getElementById('view-court'),
                    files: document.getElementById('view-files')
                };

                const aiSummaryRoot = document.getElementById('ai-global-summary');
                const summaryLead = nodeText(select(aiSummaryRoot, 'div:first-child p'));
                const summaryStatus = nodeText(select(aiSummaryRoot, 'div:first-child span'));
                const globalSummary = normalizeText(`${summaryLead} ${summaryStatus}`);

                const strategicPriorities = selectAll(aiSummaryRoot, 'ul li span:last-child')
                    .map((node) => nodeText(node))
                    .filter(Boolean);

                const dashboardChildBlocks = Array.from(views.dashboard ? views.dashboard.children : []);
                const kpiGrid = dashboardChildBlocks.find((child) => child.classList && child.classList.contains('grid') && child.children.length >= 4);
                const kpis = Array.from(kpiGrid ? kpiGrid.children : [])
                    .map((card) => {
                        const paragraphs = selectAll(card, 'p').map((node) => nodeText(node)).filter(Boolean);
                        return {
                            label: paragraphs[0] || '',
                            value: nodeText(select(card, 'h4')),
                            detail: paragraphs.slice(1).join(' | ')
                        };
                    })
                    .filter((item) => normalizeText(item.label + item.value + item.detail));

                const interventionGrids = selectAll(views.intervention, 'div.grid');
                const interventionStatusGrid = interventionGrids.find((grid) => grid.children.length >= 3);
                const interventionStatusCards = Array.from(interventionStatusGrid ? interventionStatusGrid.children : [])
                    .map((card) => {
                        const title = nodeText(select(card, 'h4'));
                        const paragraphs = selectAll(card, 'p').map((node) => nodeText(node)).filter(Boolean);
                        return {
                            label: title,
                            value: paragraphs[0] || '',
                            detail: paragraphs.slice(1).join(' | ')
                        };
                    })
                    .filter((item) => normalizeText(item.label + item.value + item.detail));

                const chronologyEvents = [];
                const seenChronology = new Set();
                selectAll(views.chronology, 'span.font-mono').forEach((dateNode) => {
                    const date = nodeText(dateNode);
                    const container = dateNode.closest('div.relative');
                    const incident = nodeText(select(container, 'h4'));
                    if (!date || !incident) return;
                    const strategicWeight = selectAll(container, 'p')
                        .map((node) => nodeText(node))
                        .filter(Boolean)
                        .join(' ');
                    const dedupeKey = `${date}::${incident}`;
                    if (seenChronology.has(dedupeKey)) return;
                    seenChronology.add(dedupeKey);
                    chronologyEvents.push([date, incident, strategicWeight || 'Context log extracted from chronology view.']);
                });

                const admissibleQuoteBlocks = selectAll(views.harassment, '.p-5');
                const admissibleQuotes = admissibleQuoteBlocks
                    .map((block) => {
                        const lines = selectAll(block, 'p').map((node) => nodeText(node)).filter(Boolean);
                        return normalizeText(lines.join(' | '));
                    })
                    .filter(Boolean);

                const counterStrategies = selectAll(views.harassment, 'div.flex-1')
                    .map((block) => {
                        const title = nodeText(select(block, 'h5'));
                        const detail = nodeText(select(block, 'p'));
                        return normalizeText([title, detail].filter(Boolean).join(': '));
                    })
                    .filter(Boolean);

                const matrixHeaders = selectAll(views.matrix, 'thead th').map((node) => nodeText(node)).filter(Boolean);
                const matrixRows = selectAll(views.matrix, 'tbody tr')
                    .map((row) => selectAll(row, 'td').map((cell) => nodeText(cell)))
                    .filter((cells) => cells.some((cell) => normalizeText(cell)));

                const legalParagraphs = selectAll(views.legal, 'p').map((node) => nodeText(node)).filter(Boolean);
                const precedents = selectAll(views.legal, 'div.group')
                    .map((block) => {
                        const title = nodeText(select(block, 'h5'));
                        if (!title) return null;
                        const paragraphs = selectAll(block, 'p').map((node) => nodeText(node)).filter(Boolean);
                        const tactical = nodeText(select(block, 'div.mt-4'));
                        return {
                            title,
                            citation: paragraphs[0] || '',
                            summary: paragraphs[1] || '',
                            tactical
                        };
                    })
                    .filter(Boolean);

                const financialParagraphs = selectAll(views.financial, 'p').map((node) => nodeText(node)).filter(Boolean);
                const financialKeyValues = selectAll(views.financial, 'div.flex.justify-between.border-b')
                    .map((row) => {
                        const spans = selectAll(row, 'span').map((node) => nodeText(node)).filter(Boolean);
                        return spans.length >= 2 ? [spans[0], spans[1]] : null;
                    })
                    .filter(Boolean);

                const costPanelHeading = selectAll(views.financial, 'h3').find((heading) => /cost of impoundment/i.test(nodeText(heading)));
                const costPanel = costPanelHeading ? costPanelHeading.closest('div') : null;
                const costGrid = select(costPanel, 'div.grid');
                const costHighlights = Array.from(costGrid ? costGrid.children : [])
                    .map((card) => {
                        const lines = selectAll(card, 'p').map((node) => nodeText(node)).filter(Boolean);
                        return {
                            label: lines[0] || '',
                            value: lines[1] || '',
                            detail: lines.slice(2).join(' | ')
                        };
                    })
                    .filter((item) => normalizeText(item.label + item.value + item.detail));

                const courtSteps = selectAll(views.court, 'div.relative.pl-10')
                    .map((step) => {
                        const time = nodeText(select(step, 'h5'));
                        const action = nodeText(select(step, 'p'));
                        return [time || 'Step', action || ''];
                    })
                    .filter((entry) => normalizeText(entry[0] + entry[1]));

                const exhibitTitles = selectAll(views.files, '.doc-btn').map((node) => nodeText(node)).filter(Boolean);
                const exhibitSummaries = selectAll(views.files, '.doc-sheet')
                    .map((sheet) => {
                        const exhibit = normalizeText((sheet.id || '').replace('doc-', '').toUpperCase());
                        const title = nodeText(select(sheet, 'h2'))
                            || nodeText(select(sheet, '.text-center.font-bold'))
                            || nodeText(select(sheet, '.font-bold.text-xl'))
                            || exhibit;
                        const summary = selectAll(sheet, 'p')
                            .map((node) => nodeText(node))
                            .find((line) => line.length > 24) || '';
                        return normalizeText(title + summary) ? { exhibit, title, summary } : null;
                    })
                    .filter(Boolean);

                const reportData = {
                    executiveSummary: {
                        globalSummary,
                        strategicPriorities,
                        kpis
                    },
                    intervention: {
                        script: nodeText(select(views.intervention, '.font-serif.text-lg')),
                        anchorTitle: nodeText(select(views.intervention, '.border-l-executive-gold h4')),
                        anchorBody: nodeText(select(views.intervention, '.border-l-executive-gold p')),
                        anchorQuote: nodeText(select(views.intervention, '.border-l-executive-gold em')),
                        statusCards: interventionStatusCards
                    },
                    chronology: {
                        overview: nodeText(select(views.chronology, '.p-8 p')),
                        events: chronologyEvents
                    },
                    matrix: {
                        headers: matrixHeaders,
                        rows: matrixRows
                    },
                    conduct: {
                        heading: nodeText(select(views.harassment, 'h4')),
                        status: nodeText(select(views.harassment, 'p.text-slate-500.text-sm')),
                        admissibleQuotes,
                        counterStrategies
                    },
                    legal: {
                        toxicology: legalParagraphs.find((line) => /positive oral fluid test/i.test(line)) || '',
                        precedents,
                        apraTitle: legalParagraphs.find((line) => /APRA CPS 520/i.test(line)) || 'APRA CPS 520 TERMINATION RISK',
                        apraBody: legalParagraphs.find((line) => /CONVICTION/i.test(line) && /TERMINATION/i.test(line))
                            || legalParagraphs.find((line) => /Direct reporting obligations/i.test(line))
                            || ''
                    },
                    financial: {
                        keyValues: financialKeyValues,
                        costNarrative: financialParagraphs.find((line) => /impoundment cycle/i.test(line)) || '',
                        costHighlights,
                        aggregatePenalty: nodeText(select(views.financial, 'span.text-xl.font-mono'))
                    },
                    court: {
                        steps: courtSteps,
                        judicialNote: nodeText(document.getElementById('magistrate-feedback')),
                        script: normalizeText(document.getElementById('courtScript')?.value || '')
                    },
                    evidence: {
                        titles: exhibitTitles,
                        summaries: exhibitSummaries
                    }
                };

                drawPageChrome(currentPage);

                doc.setDrawColor(...COLOR_GOLD);
                doc.setLineWidth(0.8);
                doc.line(CONTENT_LEFT, 86, CONTENT_RIGHT, 86);

                doc.setFont('times', 'bold');
                doc.setFontSize(32);
                doc.setTextColor(...COLOR_NAVY);
                doc.text(splitLines('LEX DEFENSION', CONTENT_WIDTH), PAGE_W / 2, 108, {
                    align: 'center',
                    lineHeightFactor: 1.15
                });

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.setTextColor(...COLOR_GOLD);
                doc.text(splitLines('Strategic Counsel Briefing', CONTENT_WIDTH), PAGE_W / 2, 121, { align: 'center' });

                doc.setFont('times', 'bold');
                doc.setFontSize(16);
                doc.setTextColor(...COLOR_NAVY);
                doc.text(splitLines('Police v Deshpande', CONTENT_WIDTH), PAGE_W / 2, 154, { align: 'center' });

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.setTextColor(...COLOR_SLATE_SOFT);
                doc.text(splitLines('Melbourne Magistrates Court', CONTENT_WIDTH), PAGE_W / 2, 166, { align: 'center' });
                doc.text(splitLines('Hearing: 23 February 2026', CONTENT_WIDTH), PAGE_W / 2, 173, { align: 'center' });

                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);
                doc.setTextColor(...COLOR_SLATE);
                doc.text(splitLines(`Prepared ${exportDateDisplay}`, CONTENT_WIDTH), PAGE_W / 2, 206, { align: 'center' });

                doc.setDrawColor(...COLOR_BORDER);
                doc.setLineWidth(0.25);
                doc.line(CONTENT_LEFT, 214, CONTENT_RIGHT, 214);

                doc.setFont('helvetica', 'bold');
                doc.setFontSize(9);
                doc.setTextColor(...COLOR_NAVY);
                doc.text(splitLines(reportTitle, CONTENT_WIDTH), PAGE_W / 2, 224, { align: 'center' });

                startSection('Executive Summary');
                writeSubHeader('Global Briefing');
                writeWrapped(reportData.executiveSummary.globalSummary || 'Strategic summary pending synchronization with live intelligence context.');
                writeSubHeader('Key Strategic Indicators');
                writeKpiGrid(reportData.executiveSummary.kpis);
                writeSubHeader('Strategic Priorities');
                if (reportData.executiveSummary.strategicPriorities.length) {
                    reportData.executiveSummary.strategicPriorities.forEach((item) => writeBullet(item));
                } else {
                    writeBullet('Strategic priorities are pending dashboard synchronization.');
                }

                startSection('Intervention Protocol');
                writeSubHeader('Mandatory Right to Silence Script');
                writeCallout(reportData.intervention.script || 'Mandatory script not available in current dashboard state.');
                writeSubHeader(reportData.intervention.anchorTitle || 'Defence Anchor');
                writeWrapped(reportData.intervention.anchorBody || 'Defence anchor narrative unavailable.');
                if (reportData.intervention.anchorQuote) {
                    writeCallout(reportData.intervention.anchorQuote, {
                        fill: [255, 251, 235],
                        border: COLOR_GOLD,
                        textColor: COLOR_SLATE_SOFT,
                        font: 'times',
                        style: 'italic'
                    });
                }
                writeSubHeader('Operational Status');
                writeKpiGrid(reportData.intervention.statusCards);

                startSection('Forensic Chronology');
                writeWrapped(reportData.chronology.overview || 'Chronology overview extracted from the forensic timeline panel.');
                if (reportData.chronology.events.length) {
                    renderTable(
                        ['Date', 'Incident', 'Strategic Weight'],
                        reportData.chronology.events,
                        [1.15, 1.35, 2.5],
                        { fontSize: 8.5 }
                    );
                } else {
                    writeWrapped('No chronology records were detected at export time.');
                }

                startSection('Truth Matrix');
                writeWrapped('Police allegation and forensic reality matrix generated from the dashboard evidence grid.');
                if (reportData.matrix.rows.length) {
                    renderTable(
                        reportData.matrix.headers.length ? reportData.matrix.headers : ['Police Allegation', 'Forensic Reality', 'Evidence Key'],
                        reportData.matrix.rows,
                        [1.4, 1.6, 1.2],
                        { fontSize: 8.5 }
                    );
                } else {
                    writeWrapped('Truth matrix rows are unavailable in the current dashboard state.');
                }

                startSection('Conduct Analysis');
                writeSubHeader('Professional Standards Command');
                writeWrapped(
                    normalizeText([reportData.conduct.heading, reportData.conduct.status].filter(Boolean).join(' | '))
                    || 'Conduct status unavailable.'
                );
                writeSubHeader('Admissible Quotes');
                if (reportData.conduct.admissibleQuotes.length) {
                    reportData.conduct.admissibleQuotes.forEach((entry) => writeBullet(entry));
                } else {
                    writeBullet('No admissible quotes detected in conduct analysis.');
                }
                writeSubHeader('Counter Strategy');
                if (reportData.conduct.counterStrategies.length) {
                    reportData.conduct.counterStrategies.forEach((entry) => writeBullet(entry));
                } else {
                    writeBullet('Counter-strategy actions were not detected in current view.');
                }

                startSection('Legal and Regulatory Risk');
                writeSubHeader('Toxicological Engineering');
                writeWrapped(reportData.legal.toxicology || 'Toxicology narrative unavailable in current session.');
                writeSubHeader('Strategic Precedents');
                if (reportData.legal.precedents.length) {
                    reportData.legal.precedents.forEach((precedent) => {
                        writeWrapped(precedent.title, {
                            font: 'times',
                            style: 'bold',
                            size: 11,
                            color: COLOR_NAVY,
                            after: 1.5
                        });
                        if (precedent.citation) {
                            writeWrapped(precedent.citation, {
                                font: 'helvetica',
                                style: 'bold',
                                size: 8,
                                color: COLOR_SLATE_SOFT,
                                after: 1.5
                            });
                        }
                        if (precedent.summary) {
                            writeWrapped(precedent.summary, {
                                font: 'helvetica',
                                style: 'normal',
                                size: 9.5
                            });
                        }
                        if (precedent.tactical) {
                            writeCallout(precedent.tactical, {
                                fill: [250, 250, 250],
                                border: COLOR_BORDER,
                                textColor: COLOR_SLATE_SOFT,
                                size: 8.5
                            });
                        }
                    });
                } else {
                    writeWrapped('No legal precedents were extracted for this export.');
                }
                writeSubHeader(reportData.legal.apraTitle);
                writeCallout(
                    reportData.legal.apraBody || 'A conviction creates a material APRA CPS 520 fit-and-proper risk for executive roles.',
                    {
                        fill: COLOR_APRA_FILL,
                        border: COLOR_APRA_BORDER,
                        textColor: COLOR_APRA_TEXT,
                        size: 9.5
                    }
                );

                startSection('Financial Hardship');
                writeSubHeader('Hardship Profile');
                if (reportData.financial.keyValues.length) {
                    renderTable(
                        ['Metric', 'Current Position'],
                        reportData.financial.keyValues,
                        [1.5, 2.5],
                        { fontSize: 8.5 }
                    );
                } else {
                    writeWrapped('Financial hardship metrics were not detected in this session.');
                }
                writeSubHeader('Cost of Impoundment');
                writeWrapped(reportData.financial.costNarrative || 'Cost narrative unavailable.');
                writeKpiGrid(reportData.financial.costHighlights);
                if (reportData.financial.aggregatePenalty) {
                    writeCallout(`Aggregate Direct Penalty: ${reportData.financial.aggregatePenalty}`, {
                        fill: [255, 251, 235],
                        border: COLOR_GOLD,
                        textColor: COLOR_NAVY,
                        font: 'helvetica',
                        style: 'bold',
                        size: 10
                    });
                }

                startSection('Courtroom Roadmap');
                if (reportData.court.steps.length) {
                    renderTable(
                        ['Stage', 'Execution Detail'],
                        reportData.court.steps,
                        [1.3, 2.7],
                        { fontSize: 8.5 }
                    );
                } else {
                    writeWrapped('Court roadmap steps were not detected in current data.');
                }
                if (reportData.court.judicialNote) {
                    writeSubHeader('Judicial Simulator Note');
                    writeWrapped(reportData.court.judicialNote);
                }
                writeSubHeader('Oral Submission Script');
                writeCallout(
                    reportData.court.script || 'Court script is currently empty.',
                    {
                        fill: COLOR_CALLOUT_FILL,
                        border: COLOR_BORDER,
                        textColor: COLOR_SLATE,
                        font: 'times',
                        style: 'italic',
                        size: 10
                    }
                );

                startSection('Evidence Index');
                writeWrapped('Concise exhibit summary generated from the Evidence Vault inventory.');
                writeSubHeader('Indexed Exhibits');
                if (reportData.evidence.titles.length) {
                    reportData.evidence.titles.forEach((title) => writeBullet(title));
                } else {
                    writeBullet('No exhibit titles were detected in the inventory index.');
                }
                writeSubHeader('Exhibit Summaries');
                if (reportData.evidence.summaries.length) {
                    reportData.evidence.summaries.forEach((item) => {
                        const summaryLine = normalizeText(`${item.exhibit}: ${item.title}${item.summary ? ' | ' + item.summary : ''}`);
                        writeBullet(summaryLine);
                    });
                } else {
                    writeBullet('No concise exhibit summaries were detected.');
                }

                const totalPages = doc.getNumberOfPages();
                for (let page = 1; page <= totalPages; page += 1) {
                    doc.setPage(page);
                    drawFinalPageNumber(page, totalPages);
                }

                doc.save(`Lex_Defension_Executive_Briefing_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (error) {
                console.error('PDF Export Failed:', error);
                alert('Export failed: ' + error.message);
            } finally {
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }

        // Init
        switchView('dashboard');
    </script>

    <!-- AI FORENSIC INSPECTOR (Floating) -->
    <div id="ai-inspector" class="ai-inspector flex flex-col hidden">
        <div class="px-6 py-4 border-b border-white/5 bg-white/[0.02] flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-microscope text-executive-gold"></i>
                <h5 class="text-[10px] font-bold text-white uppercase tracking-widest">Forensic AI Inspector</h5>
            </div>
            <button onclick="document.getElementById('ai-inspector').classList.add('hidden')"
                class="text-slate-500 hover:text-white">
                <i class="fa-solid fa-times text-xs"></i>
            </button>
        </div>
        <div id="inspector-content"
            class="flex-1 p-6 overflow-y-auto custom-scrollbar text-[11px] text-slate-300 leading-relaxed font-mono">
            Scanning document for administrative anomalies...
        </div>
        <div class="p-4 bg-black/20 border-t border-white/5">
            <div class="flex gap-2">
                <input type="text" id="inspector-query"
                    class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-[10px] focus:outline-none focus:border-executive-gold"
                    placeholder="Ask about this document...">
                <button onclick="triggerAIAction('inspect')"
                    class="px-3 bg-executive-gold text-navy font-bold rounded-lg"><i
                        class="fa-solid fa-magnifying-glass text-xs text-executive-navy"></i></button>
            </div>
        </div>
    </div>
</body>

</html>
